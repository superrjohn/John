{
    "version": "https://jsonfeed.org/version/1",
    "title": "ä¸€åˆ‡éƒ½æ˜¯éç¨‹",
    "description": "",
    "home_page_url": "https://superrjohn.github.io/John",
    "items": [
        {
            "id": "https://superrjohn.github.io/John/2023/11/03/java/SpringSecurity/WeChat_login",
            "url": "https://superrjohn.github.io/John/2023/11/03/java/SpringSecurity/WeChat_login",
            "title": "SpringSecurity å¾®ä¿¡ç™»éŒ„",
            "date_published": "2023-11-03T15:39:05.235Z",
            "content_html": "<p>åœ¨æ­¤ç‰¹åˆ«æ„Ÿè¬é»‘é¦¬ç¨‹åºå“¡æä¾›çš„èª²ç¨‹: <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMWo4NDExTjdCbS8=\">å­¸æˆåœ¨ç·š</span></p>\n<p>å‰è¨€<br>\næ–¼ç”±å¯¦ç¿’é …ç›®å¿«åšå®Œæ‰åšè¨˜éŒ„ï¼Œè€Œä¸”é …ç›®æ¨¡å¡Šè¼ƒå¤šï¼Œæ•…æŒ‘éƒ¨ä»½ä¾†è¨˜éŒ„ï¼Œæ‰€ä»¥é€™éä¸»è¦æ˜¯ SpringSecurity å…§å®¹ã€‚<br>\n<span class=\"rainbow\">å®Œæ•´é¡¹ç›®åœ°å€</span>ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3N1cGVycmpvaG4vamF2YV93ZWI=\">https://github.com/superrjohn/java_web</span></p>\n<p><span class=\"green\">ä¸Šç¯‡:</span><a href=\"/John/2023/10/30/java/SpringSecurity/SpringSecurity\">èªè­‰æˆæ¬Š</a></p>\n<h1 id=\"é©—è­‰ç¢¼æœå‹™\"><a class=\"markdownIt-Anchor\" href=\"#é©—è­‰ç¢¼æœå‹™\">#</a> é©—è­‰ç¢¼æœå‹™</h1>\n<h2 id=\"éƒ¨ç½²é©—è­‰ç¢¼æœå‹™å·¥ç¨‹\"><a class=\"markdownIt-Anchor\" href=\"#éƒ¨ç½²é©—è­‰ç¢¼æœå‹™å·¥ç¨‹\">#</a> éƒ¨ç½²é©—è­‰ç¢¼æœå‹™å·¥ç¨‹</h2>\n<p>ğŸ”´åœ¨èªè­‰æ™‚ä¸€èˆ¬éƒ½éœ€è¦è¼¸å…¥é©—è­‰ç¢¼ï¼Œé©—è­‰ç¢¼æœ‰ä»€éº¼ç”¨ï¼Ÿ</p>\n<blockquote><p>é©—è­‰ç¢¼å¯ä»¥é˜²æ­¢æƒ¡æ€§æ”»æ“Šï¼Œä¾‹å¦‚ï¼šXSS è·¨ç«™è…³æœ¬æ”»æ“Šã€CSRF è·¨ç«™è«‹æ±‚å½é€ æ”»æ“Šï¼Œä¸€äº›æ¯”è¼ƒè¤‡é›œçš„åœ–å½¢é©—è­‰ç¢¼å¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢æƒ¡æ€§æ”»æ“Šã€‚<br>\nç‚ºäº†ä¿è­·ç³»çµ±çš„å®‰å…¨æ€§åœ¨ä¸€äº›æ¯”è¼ƒé‡è¦çš„æ“ä½œéƒ½éœ€è¦é©—è­‰ç¢¼ã€‚</p>\n</blockquote>\n<p>æœ¬å°ˆæ¡ˆå»ºç«‹å–®ç¨çš„é©—è­‰ç¢¼æœå‹™ç‚ºå„æ¥­å‹™æä¾›é©—è­‰ç¢¼çš„ç”¢ç”Ÿã€æ ¡é©—ç­‰æœå‹™ã€‚<br>\næ‹·è²èª²ç¨‹è³‡æ–™ç›®éŒ„ xuecheng-plus-checkcode é©—è­‰ç¢¼æœå‹™å·¥ç¨‹åˆ°è‡ªå·±çš„å·¥ç¨‹ç›®éŒ„ã€‚<br>\nç„¶å¾Œå®šç¾© nacos è¨­å®šæª”</p>\n<figure class=\"highlight yaml\"><figcaption><span>YAML</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span> </span><br><span class=\"line\">  <span class=\"attr\">servlet:</span> </span><br><span class=\"line\">    <span class=\"attr\">context-path:</span> <span class=\"string\">/checkcode</span> </span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">63075</span> </span><br></pre></td></tr></table></figure>\n<p>æ³¨æ„ä¿®æ”¹ bootstrap.yml ä¸­çš„å‘½åç©ºé–“ç‚ºè‡ªå·±å®šç¾©çš„å‘½åç©ºé–“ã€‚<br>\né…ç½® redis-dev.yamlï¼Œå„²å­˜ redis æœå‹™å•Ÿå‹•</p>\n<figure class=\"highlight xml\"><figcaption><span>XML</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:  </span><br><span class=\"line\">  redis: </span><br><span class=\"line\">    host: 192.168.101.65 </span><br><span class=\"line\">    port: 6379 </span><br><span class=\"line\">    password: redis </span><br><span class=\"line\">    database: 0 </span><br><span class=\"line\">    lettuce: </span><br><span class=\"line\">      pool: </span><br><span class=\"line\">        max-active: 20 </span><br><span class=\"line\">        max-idle: 10 </span><br><span class=\"line\">        min-idle: 0 </span><br><span class=\"line\">    timeout: 10000 </span><br><span class=\"line\">    #redisson: </span><br><span class=\"line\">      #é…ç½®æ–‡ä»¶ç›®å½• </span><br><span class=\"line\">      #config: classpath:singleServerConfig.yaml </span><br></pre></td></tr></table></figure>\n<h2 id=\"é©—è­‰ç¢¼ä»‹é¢æ¸¬è©¦\"><a class=\"markdownIt-Anchor\" href=\"#é©—è­‰ç¢¼ä»‹é¢æ¸¬è©¦\">#</a> é©—è­‰ç¢¼ä»‹é¢æ¸¬è©¦</h2>\n<p>1ï¸âƒ£é»‘é¦¬æä¾›çš„é©—è­‰ç¢¼æœå‹™ä¸­çš„ Controller ä¸­æœ‰ä¸€å€‹æ–¹æ³•ï¼Œæ˜¯ç”¨ä¾†ç”¢ç”Ÿé©—è­‰ç¢¼åœ–ç‰‡çš„</p>\n<figure class=\"highlight java\"><figcaption><span>JAVA</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ApiOperation(value=&quot;ç”ŸæˆéªŒè¯ä¿¡æ¯&quot;, notes=&quot;ç”ŸæˆéªŒè¯ä¿¡æ¯&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@PostMapping(value = &quot;/pic&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> CheckCodeResultDto <span class=\"title function_\">generatePicCheckCode</span><span class=\"params\">(CheckCodeParamsDto checkCodeParamsDto)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> picCheckCodeService.generate(checkCodeParamsDto);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£æˆ‘å€‘ä½¿ç”¨ HttpClient æ¸¬è©¦è©²ä»‹é¢</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### è·å–éªŒè¯ç å›¾ç‰‡</span><br><span class=\"line\">POST localhost:<span class=\"number\">53075</span>/checkcode/pic</span><br></pre></td></tr></table></figure>\n<p>3ï¸âƒ£å›æ‡‰çµæœå¦‚ä¸‹ï¼Œåœ–ç‰‡æ˜¯ä»¥ base64 ç·¨ç¢¼æ ¼å¼å„²å­˜çš„ï¼Œæˆ‘å€‘å¯ä»¥è¤‡è£½ç›´æ¥åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ</p>\n<img data-src=\"/John/img/java/SpringSecurity/14.png\" class=\"abc\">\n<p>4ï¸âƒ£é©—è­‰ç¢¼æœå‹™å¦‚ä½•ç”¢ç”Ÿä½µæ ¡é©—é©—è­‰ç¢¼ï¼Ÿ</p>\n<img data-src=\"/John/img/java/SpringSecurity/15.png\" class=\"abc\">\n<p>1. çµ¦ç”¢ç”Ÿçš„é©—è­‰ç¢¼åˆ†é…ä¸€å€‹ keyï¼Œå°‡ key å’Œé©—è­‰ç¢¼ä¸€åŒå­˜å…¥ redisã€‚ é€™å€‹ key å’Œåœ–ç‰‡ä¸€åŒå›é çµ¦é é¢ã€‚<br>\n2. ä½¿ç”¨è€…è¼¸å…¥é©—è­‰ç¢¼ï¼Œé€£åŒ key ä¸€åŒæäº¤è‡³èªè­‰æœå‹™ï¼Œåªæ˜¯é€™å€‹ key è¢«éš±è—èµ·ä¾†ï¼Œè‡ªå‹•è¼¸å…¥ã€‚<br>\n3. é©—è­‰ç¢¼æœå‹™æ ¹æ“š key å¾å¿«å–å–å‡ºæ­£ç¢ºçš„é©—è­‰ç¢¼å’Œä½¿ç”¨è€…è¼¸å…¥çš„é©—è­‰ç¢¼é€²è¡Œæ¯”å°ï¼Œå¦‚æœç›¸åŒå‰‡æ ¡é©—é€šéï¼Œå¦å‰‡ä¸é€šéã€‚</p>\n<p>5ï¸âƒ£æ ¡é©—é©—è­‰ç¢¼ä»‹é¢ï¼Œcode éœ€è¦æ”¹ç‚ºåœ–ç‰‡é¡¯ç¤ºçš„å€¼</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### æ ¡éªŒéªŒè¯ç  </span><br><span class=\"line\">POST &#123;&#123;checkcode_host&#125;&#125;/checkcode/verify?key=checkcode4506b95bddbe46cdb0d56810b747db1b&amp;code=70dl </span><br></pre></td></tr></table></figure>\n<h2 id=\"å¸³è™Ÿå¯†ç¢¼èªè­‰\"><a class=\"markdownIt-Anchor\" href=\"#å¸³è™Ÿå¯†ç¢¼èªè­‰\">#</a> å¸³è™Ÿå¯†ç¢¼èªè­‰</h2>\n<p>åŸ·è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>\n<img data-src=\"/John/img/java/SpringSecurity/16.png\" class=\"abc\">\n<p>1ã€åœ¨èªè­‰æœå‹™å®šç¾©é ç«¯å‘¼å«é©—è­‰ç¢¼æœå‹™çš„æ¥å£ï¼ŒFeignClient çš„åƒæ•¸ value ç‚ºæœå‹™åï¼ŒCheckCodeClientFactory ç‚ºé™ç´šæ–¹æ³•</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FeignClient(value = &quot;checkcode&quot;,fallbackFactory = CheckCodeClientFactory.class)</span> </span><br><span class=\"line\"> <span class=\"meta\">@RequestMapping(&quot;/checkcode&quot;)</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">CheckCodeClient</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"meta\">@PostMapping(value = &quot;/verify&quot;)</span> </span><br><span class=\"line\"> <span class=\"keyword\">public</span> Boolean <span class=\"title function_\">verify</span><span class=\"params\">(<span class=\"meta\">@RequestParam(&quot;key&quot;)</span> String key,<span class=\"meta\">@RequestParam(&quot;code&quot;)</span> String code)</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2.CheckCodeClientFactory:</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span> </span><br><span class=\"line\"><span class=\"meta\">@Component</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CheckCodeClientFactory</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">FallbackFactory</span>&lt;CheckCodeClient&gt; &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Override</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> CheckCodeClient <span class=\"title function_\">create</span><span class=\"params\">(Throwable throwable)</span> &#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CheckCodeClient</span>() &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">            <span class=\"meta\">@Override</span> </span><br><span class=\"line\">            <span class=\"keyword\">public</span> Boolean <span class=\"title function_\">verify</span><span class=\"params\">(String key, String code)</span> &#123; </span><br><span class=\"line\">                log.debug(<span class=\"string\">&quot;è°ƒç”¨éªŒè¯ç æœåŠ¡ç†”æ–­å¼‚å¸¸:&#123;&#125;&quot;</span>, throwable.getMessage()); </span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">null</span>; </span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">        &#125;; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>3. å•Ÿå‹•é¡æ·»åŠ ï¼ŒbasePackages ç‚ºé ç¨‹èª¿ç”¨æ¥å£çš„ç›®éŒ„</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@EnableFeignClients(basePackages=&#123;&quot;com.xuecheng.*.feignclient&quot;&#125;)</span> </span><br></pre></td></tr></table></figure>\n<p>é…ç½®æ–‡ä»¶å¼•å…¥ feign-dev.yaml</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- data-id: feign-$&#123;spring.profiles.active&#125;.yaml </span><br><span class=\"line\">  group: xuecheng-plus-common </span><br><span class=\"line\">  refresh: <span class=\"literal\">true</span> </span><br></pre></td></tr></table></figure>\n<p>4. å®Œå–„ PasswordAuthServiceImpl</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service(&quot;password_authservice&quot;)</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">PasswordAuthServiceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AuthService</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\"> XcUserMapper xcUserMapper; </span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\"> PasswordEncoder passwordEncoder; </span><br><span class=\"line\"> <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\"> CheckCodeClient checkCodeClient; </span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"meta\">@Override</span> </span><br><span class=\"line\"> <span class=\"keyword\">public</span> XcUser <span class=\"title function_\">execute</span><span class=\"params\">(AuthParamsDto authParamsDto)</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"comment\">//æ ¡éªŒéªŒè¯ç  </span></span><br><span class=\"line\">  <span class=\"type\">String</span> <span class=\"variable\">checkcode</span> <span class=\"operator\">=</span> authParamsDto.getCheckcode(); </span><br><span class=\"line\">  <span class=\"type\">String</span> <span class=\"variable\">checkcodekey</span> <span class=\"operator\">=</span> authParamsDto.getCheckcodekey(); </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">if</span>(StringUtils.isBlank(checkcodekey) || StringUtils.isBlank(checkcode))&#123; </span><br><span class=\"line\">   <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;éªŒè¯ç ä¸ºç©º&quot;</span>); </span><br><span class=\"line\"> </span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">  <span class=\"type\">Boolean</span> <span class=\"variable\">verify</span> <span class=\"operator\">=</span> checkCodeClient.verify(checkcodekey, checkcode); </span><br><span class=\"line\">  <span class=\"keyword\">if</span>(!verify)&#123; </span><br><span class=\"line\">   <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;éªŒè¯ç è¾“å…¥é”™è¯¯&quot;</span>); </span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">  <span class=\"comment\">//è´¦å· </span></span><br><span class=\"line\">  <span class=\"type\">String</span> <span class=\"variable\">username</span> <span class=\"operator\">=</span> authParamsDto.getUsername(); </span><br><span class=\"line\">  <span class=\"type\">XcUser</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> xcUserMapper.selectOne(<span class=\"keyword\">new</span> <span class=\"title class_\">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username)); </span><br><span class=\"line\">  <span class=\"keyword\">if</span>(user==<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">   <span class=\"comment\">//è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨ </span></span><br><span class=\"line\">   <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è´¦å·ä¸å­˜åœ¨&quot;</span>); </span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">  <span class=\"comment\">//æ ¡éªŒå¯†ç  </span></span><br><span class=\"line\">  <span class=\"comment\">//å–å‡ºæ•°æ®åº“å­˜å‚¨çš„æ­£ç¡®å¯†ç  </span></span><br><span class=\"line\">  <span class=\"type\">String</span> <span class=\"variable\">passwordDb</span>  <span class=\"operator\">=</span>user.getPassword(); </span><br><span class=\"line\">  <span class=\"type\">String</span> <span class=\"variable\">passwordForm</span> <span class=\"operator\">=</span> authParamsDto.getPassword(); </span><br><span class=\"line\">  <span class=\"type\">boolean</span> <span class=\"variable\">matches</span> <span class=\"operator\">=</span> passwordEncoder.matches(passwordForm, passwordDb); </span><br><span class=\"line\">  <span class=\"keyword\">if</span>(!matches)&#123; </span><br><span class=\"line\">   <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯&quot;</span>); </span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">  <span class=\"keyword\">return</span> user; </span><br><span class=\"line\"> &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"å¸³è™Ÿå¯†ç¢¼èªè­‰æ¸¬è©¦\"><a class=\"markdownIt-Anchor\" href=\"#å¸³è™Ÿå¯†ç¢¼èªè­‰æ¸¬è©¦\">#</a> å¸³è™Ÿå¯†ç¢¼èªè­‰æ¸¬è©¦</h2>\n<img data-src=\"/John/img/java/SpringSecurity/17.png\" class=\"abc\">\n<p>1. ä½¿ç”¨ç€è¦½å™¨é€ è¨ª <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy41MXh1ZWNoZW5nLmNuL3NpZ24uaHRtbA==\">http://www.51xuecheng.cn/sign.html</span><br>\n2. å…ˆæ¸¬è©¦é©—è­‰ç¢¼ï¼Œåˆ†åˆ¥è¼¸å…¥æ­£ç¢ºçš„é©—è­‰ç¢¼ã€éŒ¯èª¤çš„é©—è­‰ç¢¼é€²è¡Œæ¸¬è©¦<br>\n 3. è¼¸å…¥æ­£ç¢ºçš„å¸³è™Ÿå¯†ç¢¼å’ŒéŒ¯èª¤çš„å¸³è™Ÿå¯†ç¢¼é€²è¡Œæ¸¬è©¦<br>\nç™»å…¥æˆåŠŸå°‡ jwt ä»¤ç‰Œå„²å­˜ cookie.<br>\n4. æ¸¬è©¦è‡ªå‹•ç™»å…¥<br>\nå‹¾é¸è‡ªå‹•ç™»å…¥ cookie ç”¢ç”Ÿæ™‚é–“ç‚º 30 å¤©ï¼Œä¸å‹¾é¸è‡ªå‹•ç™»å…¥é—œé–‰ç€è¦½å™¨è¦–çª—å¾Œè‡ªå‹•åˆªé™¤ cookieã€‚</p>\n<h1 id=\"å¾®ä¿¡æƒç¢¼ç™»å…¥\"><a class=\"markdownIt-Anchor\" href=\"#å¾®ä¿¡æƒç¢¼ç™»å…¥\">#</a> å¾®ä¿¡æƒç¢¼ç™»å…¥</h1>\n<h2 id=\"æ¥å…¥æµç¨‹\"><a class=\"markdownIt-Anchor\" href=\"#æ¥å…¥æµç¨‹\">#</a> æ¥å…¥æµç¨‹</h2>\n<p>å‰è¨€ï¼šå…ˆè¦åœ¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9vcGVuLndlaXhpbi5xcS5jb20v\">ç½‘ç«™åº”ç”¨å¼€å‘</span>ï¼Œä¸¦æ“æœ‰å·²å¯©æ ¸é€šéçš„ç¶²ç«™æ‡‰ç”¨ï¼Œä¸¦å–å¾—ç›¸æ‡‰çš„ AppID å’Œ AppSecretï¼Œç”³è«‹å¾®ä¿¡ç™»å…¥ä¸”é€šéå¯©æ ¸å¾Œï¼Œå¯é–‹å§‹æ¥å–æµç¨‹ (ä¸Šç¶²æ‰¾å¯ä»¥æ‰¾åˆ°è³‡æº)</p>\n<p>å¾®ä¿¡æƒç¢¼ç™»å…¥åŸºæ–¼ OAuth2 å”å®šçš„æˆæ¬Šç¢¼æ¨¡å¼ï¼Œ</p>\n<p>ä»‹é¢æ–‡æª”ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXJzLndlaXhpbi5xcS5jb20vZG9jL29wbGF0Zm9ybS9XZWJzaXRlX0FwcC9XZUNoYXRfTG9naW4vV2VjaGF0X0xvZ2luLmh0bWw=\">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</span></p>\n<p>å¾®ä¿¡ OAuth2.0 æˆæ¬Šç™»å…¥ç›®å‰æ”¯æ´ authorization_code æ¨¡å¼ï¼Œé©ç”¨æ–¼æ“æœ‰ server ç«¯çš„æ‡‰ç”¨ç¨‹å¼æˆæ¬Šã€‚ æ­¤æ¨¡å¼æ•´é«”æµç¨‹ç‚ºï¼š<br>\n1ï¸âƒ£ç¬¬ä¸‰æ–¹ç™¼èµ·å¾®ä¿¡æˆæ¬Šç™»å…¥è¦æ±‚ï¼Œå¾®ä¿¡ä½¿ç”¨è€…å…è¨±æˆæ¬Šç¬¬ä¸‰æ–¹æ‡‰ç”¨ç¨‹å¼å¾Œï¼Œå¾®ä¿¡æœƒæ‹‰èµ·æ‡‰ç”¨ç¨‹å¼æˆ–é‡å®šå‘åˆ°ç¬¬ä¸‰æ–¹ç¶²ç«™ï¼Œä¸¦ä¸”å¸¶ä¸Šæˆæ¬Šè‡¨æ™‚ç¥¨æ“š code åƒæ•¸ï¼›<br>\n2ï¸âƒ£é€é code åƒæ•¸åŠ ä¸Š AppID å’Œ AppSecret ç­‰ï¼Œé€é API æ›å– access_tokenï¼›<br>\n3ï¸âƒ£é€é access_token é€²è¡Œä»‹é¢èª¿ç”¨ï¼Œå–å¾—ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™è³‡æºæˆ–å¹«åŠ©ä½¿ç”¨è€…å¯¦ç¾åŸºæœ¬æ“ä½œã€‚</p>\n<img data-src=\"/John/img/java/SpringSecurity/18.png\" class=\"abc\">\n<p>æ­¥é©Ÿ 1ï¼šåœ¨é é¢ä¸­å…ˆå¼•å…¥ä»¥ä¸‹ JS æª”æ¡ˆï¼ˆæ”¯æ´ httpsï¼‰ï¼š</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js </span><br></pre></td></tr></table></figure>\n<p>æ­¥é©Ÿ 2ï¼šåœ¨éœ€è¦ä½¿ç”¨å¾®ä¿¡ç™»å…¥çš„åœ°æ–¹å¯¦ä¾‹ä»¥ä¸‹ JS ç‰©ä»¶ï¼š</p>\n<p>var obj = new WxLogin({<br>\nself_redirect:true,<br>\nid:â€œlogin_containerâ€,<br>\nappid: â€œ<span class=\"yellow\">ç¶²ç«™æ‡‰ç”¨å¯©æ ¸é€šéå¾Œç²å¾—</span>â€,<br>\nscope: â€œâ€,<br>\nredirect_uri: â€œ<span class=\"yellow\">ç”¨æˆ¶æŒ‰ä¸‹åŒæ„å¾Œï¼Œç¶²ç«™æ‡‰ç”¨é‡å®šå‘</span>â€,<br>\nstate: â€œâ€,<br>\nstyle: â€œâ€,<br>\nhref: â€œâ€<br>\n});</p>\n<h1 id=\"æ¥å…¥å¾®ä¿¡ç™»å…¥\"><a class=\"markdownIt-Anchor\" href=\"#æ¥å…¥å¾®ä¿¡ç™»å…¥\">#</a> æ¥å…¥å¾®ä¿¡ç™»å…¥</h1>\n<h2 id=\"æ¥å…¥åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#æ¥å…¥åˆ†æ\">#</a> æ¥å…¥åˆ†æ</h2>\n <img data-src=\"/John/img/java/SpringSecurity/19.png\" class=\"abc\">\n<p>1ï¸âƒ£éœ€è¦å®šç¾©ä»‹é¢æ¥æ”¶å¾®ä¿¡ä¸‹ç™¼çš„æˆæ¬Šç¢¼ã€‚<br>\n2ï¸âƒ£æ”¶åˆ°æˆæ¬Šç¢¼å‘¼å«å¾®ä¿¡ä»‹é¢ç”³è«‹ä»¤ç‰Œã€‚<br>\n3ï¸âƒ£ç”³è«‹åˆ°ä»¤ç‰Œèª¿ç”¨å¾®ä¿¡ç²å–ç”¨æˆ¶ä¿¡æ¯<br>\n4ï¸âƒ£å–å¾—ä½¿ç”¨è€…è³‡è¨ŠæˆåŠŸå°‡å…¶å¯«å…¥æœ¬å°ˆæ¡ˆç”¨æˆ¶ä¸­å¿ƒè³‡æ–™åº«ã€‚<br>\n5ï¸âƒ£æœ€å¾Œé‡å®šå‘åˆ°ç€è¦½å™¨è‡ªå‹•ç™»å…¥ã€‚</p>\n<h2 id=\"å®šç¾©æ¥å£\"><a class=\"markdownIt-Anchor\" href=\"#å®šç¾©æ¥å£\">#</a> å®šç¾©æ¥å£</h2>\n<p>åƒè€ƒä»‹é¢è¦æ ¼ä¸­ã€Œè«‹æ±‚å–å¾—æˆæ¬Šç¢¼ã€ å®šç¾©æ¥æ”¶å¾®ä¿¡ä¸‹ç™¼çš„æˆæ¬Šç¢¼æ¥å£ï¼Œ<br>\nå®šç¾© WxLoginController é¡ï¼Œç•¶ç”¨æˆ¶åœ¨å‰ç«¯æƒç¢¼æ™‚ï¼Œç”¨æˆ¶åŒæ„å¾Œæœƒè·³è½‰åˆ°é€™å€‹æ–¹æ³•ï¼Œæ”¶åˆ°ç”¨æˆ¶ä¿¡æ¯å¾Œå†åŸ·è¡Œå¾®ä¿¡èªè­‰çš„ service è‡ªå‹•ç™»éŒ„ï¼Œå¦‚ä¸‹:</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span> </span><br><span class=\"line\"><span class=\"meta\">@Controller</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">WxLoginController</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/wxLogin&quot;)</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">wxLogin</span><span class=\"params\">(String code, String state)</span> <span class=\"keyword\">throws</span> IOException &#123; </span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;å¾®ä¿¡æ‰«ç å›è°ƒ,code:&#123;&#125;,state:&#123;&#125;&quot;</span>,code,state); </span><br><span class=\"line\">        <span class=\"comment\">//è¯·æ±‚å¾®ä¿¡ç”³è¯·ä»¤ç‰Œï¼Œæ‹¿åˆ°ä»¤ç‰ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å†™å…¥æœ¬é¡¹ç›®æ•°æ®åº“ </span></span><br><span class=\"line\">        <span class=\"type\">XcUser</span> <span class=\"variable\">xcUser</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">XcUser</span>(); </span><br><span class=\"line\">        <span class=\"comment\">//æš‚æ—¶ç¡¬ç¼–å†™ï¼Œç›®çš„æ˜¯è°ƒè¯•ç¯å¢ƒ </span></span><br><span class=\"line\">        xcUser.setUsername(<span class=\"string\">&quot;t1&quot;</span>); </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(xcUser==<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;redirect:http://www.51xuecheng.cn/error.html&quot;</span>; </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">username</span> <span class=\"operator\">=</span> xcUser.getUsername(); </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;redirect:http://www.51xuecheng.cn/sign.html?username=&quot;</span>+username+<span class=\"string\">&quot;&amp;authType=wx&quot;</span>; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>å®šç¾©å¾®ä¿¡èªè­‰çš„ service</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span> </span><br><span class=\"line\"><span class=\"meta\">@Service(&quot;wx_authservice&quot;)</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">WxAuthServiceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AuthService</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">    XcUserMapper xcUserMapper; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Override</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> XcUserExt <span class=\"title function_\">execute</span><span class=\"params\">(AuthParamsDto authParamsDto)</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">        <span class=\"comment\">//è´¦å· </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">username</span> <span class=\"operator\">=</span> authParamsDto.getUsername(); </span><br><span class=\"line\">        <span class=\"type\">XcUser</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> xcUserMapper.selectOne(<span class=\"keyword\">new</span> <span class=\"title class_\">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username)); </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(user==<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">            <span class=\"comment\">//è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨ </span></span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è´¦å·ä¸å­˜åœ¨&quot;</span>); </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">        <span class=\"type\">XcUserExt</span> <span class=\"variable\">xcUserExt</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">XcUserExt</span>(); </span><br><span class=\"line\">        BeanUtils.copyProperties(user,xcUserExt); </span><br><span class=\"line\">        <span class=\"keyword\">return</span> xcUserExt; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"æ¥å…¥å¾®ä¿¡èªè­‰\"><a class=\"markdownIt-Anchor\" href=\"#æ¥å…¥å¾®ä¿¡èªè­‰\">#</a> æ¥å…¥å¾®ä¿¡èªè­‰</h2>\n<p>æ¥ä¸‹æ¥è¯·æ±‚å¾®ä¿¡ç”³è¯·ä»¤ç‰Œã€‚<br>\n1ï¸âƒ£å› ç‚ºå’Œç¬¬ä¸‰æ–¹é€²è¡Œé ç¨‹èª¿ç”¨ï¼Œæ‰€ä»¥ä½¿ç”¨ restTemplate è¯·æ±‚å¾®ä¿¡ï¼Œé…ç½® RestTemplate bean</p>\n<p>åœ¨å•Ÿå‹•é¡é…ç½® restTemplate</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span> </span><br><span class=\"line\">RestTemplate <span class=\"title function_\">restTemplate</span><span class=\"params\">()</span>&#123; </span><br><span class=\"line\">    <span class=\"type\">RestTemplate</span> <span class=\"variable\">restTemplate</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RestTemplate</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">OkHttp3ClientHttpRequestFactory</span>()); </span><br><span class=\"line\">    <span class=\"keyword\">return</span>  restTemplate; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£å®šç¾©èˆ‡å¾®ä¿¡èªè­‰çš„ service ä»‹é¢ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">WxAuthService</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> XcUser <span class=\"title function_\">wxAuth</span><span class=\"params\">(String code)</span>; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>3ï¸âƒ£ä¸‹é‚Šåœ¨ controller ä¸­å‘¼å« wxAuth ä»‹é¢ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span> </span><br><span class=\"line\"><span class=\"meta\">@Controller</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">WxLoginController</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">    WxAuthService wxAuthService; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/wxLogin&quot;)</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">wxLogin</span><span class=\"params\">(String code, String state)</span> <span class=\"keyword\">throws</span> IOException &#123; </span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;å¾®ä¿¡æ‰«ç å›è°ƒ,code:&#123;&#125;,state:&#123;&#125;&quot;</span>,code,state); </span><br><span class=\"line\">        <span class=\"comment\">//è¯·æ±‚å¾®ä¿¡ç”³è¯·ä»¤ç‰Œï¼Œæ‹¿åˆ°ä»¤ç‰ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å†™å…¥æœ¬é¡¹ç›®æ•°æ®åº“ </span></span><br><span class=\"line\">        <span class=\"type\">XcUser</span> <span class=\"variable\">xcUser</span> <span class=\"operator\">=</span> wxAuthService.wxAuth(code); </span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(xcUser==<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;redirect:http://www.51xuecheng.cn/error.html&quot;</span>; </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">username</span> <span class=\"operator\">=</span> xcUser.getUsername(); </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;redirect:http://www.51xuecheng.cn/sign.html?username=&quot;</span>+username+<span class=\"string\">&quot;&amp;authType=wx&quot;</span>; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>4ï¸âƒ£åœ¨ WxAuthService çš„ wxAuth æ–¹æ³•ä¸­å¯¦ä½œç”³è«‹ä»¤ç‰Œã€æŸ¥è©¢ä½¿ç”¨è€…è³‡è¨Šç­‰å…§å®¹ï¼Œappid å’Œ secret æ˜¯åœ¨å¾®ä¿¡é–‹æ”¾å¹³å°è¨»å†Šå¾Œç²å¾—çš„ï¼Œå°‡å®ƒå€‘é…åœ¨ nacos çš„ auth-service-dev.yaml é…ç½®æ–‡ä»¶ä¸­ï¼Œç„¶è€ŒæŠŠå€¼æ³¨å…¥é€²ä¾†ä½¿ç”¨</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span> </span><br><span class=\"line\"><span class=\"meta\">@Service(&quot;wx_authservice&quot;)</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">WxAuthServiceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AuthService</span>, WxAuthService &#123; </span><br><span class=\"line\"><span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">XcUserMapper xcUserMapper; </span><br><span class=\"line\"><span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">RestTemplate restTemplate; </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\">@Value(&quot;$&#123;weixin.appid&#125;&quot;)</span> </span><br><span class=\"line\">String appid; </span><br><span class=\"line\"><span class=\"meta\">@Value(&quot;$&#123;weixin.secret&#125;&quot;)</span> </span><br><span class=\"line\">String secret; </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">public</span> XcUser <span class=\"title function_\">wxAuth</span><span class=\"params\">(String code)</span>&#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//æ”¶åˆ°codeè°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token </span></span><br><span class=\"line\">    Map&lt;String, String&gt; access_token_map = getAccess_token(code); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(access_token_map==<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    System.out.println(access_token_map); </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">openid</span> <span class=\"operator\">=</span> access_token_map.get(<span class=\"string\">&quot;openid&quot;</span>); </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">access_token</span> <span class=\"operator\">=</span> access_token_map.get(<span class=\"string\">&quot;access_token&quot;</span>); </span><br><span class=\"line\">    <span class=\"comment\">//æ‹¿access_tokenæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ </span></span><br><span class=\"line\">    Map&lt;String, String&gt; userinfo = getUserinfo(access_token, openid); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(userinfo==<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"comment\">//æ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“ </span></span><br><span class=\"line\">    <span class=\"type\">XcUser</span> <span class=\"variable\">xcUser</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>; </span><br><span class=\"line\">     </span><br><span class=\"line\">    <span class=\"keyword\">return</span> xcUser; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>5ï¸âƒ£getAccess_token æ–¹æ³•ï¼Œæ‹¿è‘—æˆæ¬Šç¢¼ç”³è«‹ä»¤ç‰Œæ–¹æ³•ï¼Œå› å¾®ä¿¡è¿”å›æ˜¯ JSON, æ‰€ä»¥æˆ‘å€‘ç”¨ Map æ¥æ”¶ï¼ŒæŠŠåŸæœ¬è«‹æ±‚å¾®ä¿¡åœ°å€çš„é—œéµåƒæ•¸ç”¨ % s ä½”ä½ï¼Œç„¶å¾Œç”¨ format æ–¹æ³•æŠŠä½”ä½åƒæ•¸ä¿®æ”¹æˆæˆ‘å€‘çš„æ•¸æ“šï¼Œé‡æ–°æ‹¼æ¥ url</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Map&lt;String,String&gt; <span class=\"title function_\">getAccess_token</span><span class=\"params\">(String code)</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">wxUrl_template</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code&quot;</span>; </span><br><span class=\"line\">    <span class=\"comment\">//è¯·æ±‚å¾®ä¿¡åœ°å€ </span></span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">wxUrl</span> <span class=\"operator\">=</span> String.format(wxUrl_template, appid, secret, code); </span><br><span class=\"line\"> </span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token, url:&#123;&#125;&quot;</span>, wxUrl); </span><br><span class=\"line\">    <span class=\"comment\">//é ç¨‹èª¿ç”¨å¾®ä¿¡url</span></span><br><span class=\"line\">    ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, <span class=\"literal\">null</span>, String.class); </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> exchange.getBody(); </span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token: è¿”å›å€¼:&#123;&#125;&quot;</span>, result); </span><br><span class=\"line\">    <span class=\"comment\">//jsonè½‰ç‚ºmap</span></span><br><span class=\"line\">    Map&lt;String,String&gt; resultMap = JSON.parseObject(result, Map.class); </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">return</span> resultMap; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>6ï¸âƒ£getUserinfo, æ”œå¸¶ä»¤ç‰ŒæŸ¥è©¢ç”¨æˆ¶ä¿¡æ¯ï¼Œé—œéµ url çš„åƒæ•¸ç”¨ % s ä½”ä½ï¼ŒæŠŠä»¤ç‰Œç²å¾—çš„å€¼å¡«ä¸Š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Map&lt;String,String&gt; <span class=\"title function_\">getUserinfo</span><span class=\"params\">(String access_token,String openid)</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">wxUrl_template</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s&quot;</span>; </span><br><span class=\"line\">    <span class=\"comment\">//è¯·æ±‚å¾®ä¿¡åœ°å€ </span></span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">wxUrl</span> <span class=\"operator\">=</span> String.format(wxUrl_template, access_token,openid); </span><br><span class=\"line\"> </span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token, url:&#123;&#125;&quot;</span>, wxUrl); </span><br><span class=\"line\"> </span><br><span class=\"line\">    ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, <span class=\"literal\">null</span>, String.class); </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//é˜²æ­¢ä¹±ç è¿›è¡Œè½¬ç  </span></span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(exchange.getBody().getBytes(StandardCharsets.ISO_8859_1),StandardCharsets.UTF_8); </span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token: è¿”å›å€¼:&#123;&#125;&quot;</span>, result); </span><br><span class=\"line\">    Map&lt;String,String&gt; resultMap = JSON.parseObject(result, Map.class); </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">return</span> resultMap; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<h2 id=\"å„²å­˜ä½¿ç”¨è€…è³‡è¨Š\"><a class=\"markdownIt-Anchor\" href=\"#å„²å­˜ä½¿ç”¨è€…è³‡è¨Š\">#</a> å„²å­˜ä½¿ç”¨è€…è³‡è¨Š</h2>\n<p>å‘è³‡æ–™åº«ä¿å­˜ä½¿ç”¨è€…è¨Šæ¯ï¼Œå¦‚æœä½¿ç”¨è€…ä¸å­˜åœ¨å°‡å…¶ä¿å­˜åœ¨è³‡æ–™åº«ä¸­ï¼Œäº‹å‹™æ§åˆ¶</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">XcUserRoleMapper xcUserRoleMapper; </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\">@Transactional</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> XcUser <span class=\"title function_\">addWxUser</span><span class=\"params\">(Map userInfo_map)</span>&#123; </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">unionid</span> <span class=\"operator\">=</span> userInfo_map.get(<span class=\"string\">&quot;unionid&quot;</span>).toString(); </span><br><span class=\"line\">    <span class=\"comment\">//æ ¹æ®unionidæŸ¥è¯¢æ•°æ®åº“ </span></span><br><span class=\"line\">    <span class=\"type\">XcUser</span> <span class=\"variable\">xcUser</span> <span class=\"operator\">=</span> xcUserMapper.selectOne(<span class=\"keyword\">new</span> <span class=\"title class_\">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getWxUnionid, unionid)); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(xcUser!=<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> xcUser; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">userId</span> <span class=\"operator\">=</span> UUID.randomUUID().toString(); </span><br><span class=\"line\">    xcUser = <span class=\"keyword\">new</span> <span class=\"title class_\">XcUser</span>(); </span><br><span class=\"line\">    xcUser.setId(userId); </span><br><span class=\"line\">    xcUser.setWxUnionid(unionid); </span><br><span class=\"line\">    <span class=\"comment\">//è®°å½•ä»å¾®ä¿¡å¾—åˆ°çš„æ˜µç§° </span></span><br><span class=\"line\">    xcUser.setNickname(userInfo_map.get(<span class=\"string\">&quot;nickname&quot;</span>).toString()); </span><br><span class=\"line\">    xcUser.setUserpic(userInfo_map.get(<span class=\"string\">&quot;headimgurl&quot;</span>).toString()); </span><br><span class=\"line\">    xcUser.setName(userInfo_map.get(<span class=\"string\">&quot;nickname&quot;</span>).toString()); </span><br><span class=\"line\">    xcUser.setUsername(unionid); </span><br><span class=\"line\">    xcUser.setPassword(unionid); </span><br><span class=\"line\">    xcUser.setUtype(<span class=\"string\">&quot;101001&quot;</span>);<span class=\"comment\">//å­¦ç”Ÿç±»å‹ </span></span><br><span class=\"line\">    xcUser.setStatus(<span class=\"string\">&quot;1&quot;</span>);<span class=\"comment\">//ç”¨æˆ·çŠ¶æ€ </span></span><br><span class=\"line\">    xcUser.setCreateTime(LocalDateTime.now()); </span><br><span class=\"line\">    xcUserMapper.insert(xcUser); </span><br><span class=\"line\">    <span class=\"comment\">//å‘ç”¨æˆ¶è§’è‰²é—œä¿‚è¡¨æ–°å¢è¨˜éŒ„</span></span><br><span class=\"line\">    <span class=\"type\">XcUserRole</span> <span class=\"variable\">xcUserRole</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">XcUserRole</span>(); </span><br><span class=\"line\">    xcUserRole.setId(UUID.randomUUID().toString()); </span><br><span class=\"line\">    xcUserRole.setUserId(userId); </span><br><span class=\"line\">    xcUserRole.setRoleId(<span class=\"string\">&quot;17&quot;</span>);<span class=\"comment\">//å­¦ç”Ÿè§’è‰² </span></span><br><span class=\"line\">    xcUserRoleMapper.insert(xcUserRole); </span><br><span class=\"line\">    <span class=\"keyword\">return</span> xcUser; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>èª¿ç”¨ä¿å­˜ç”¨æˆ·ä¿¡æ¯æ–¹æ³•ï¼Œ</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">WxAuthServiceImpl currentProxy; </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">public</span> XcUser <span class=\"title function_\">wxAuth</span><span class=\"params\">(String code)</span>&#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//æ”¶åˆ°codeè°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token </span></span><br><span class=\"line\">    Map&lt;String, String&gt; access_token_map = getAccess_token(code); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(access_token_map==<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"comment\">//System.out.println(access_token_map); </span></span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">openid</span> <span class=\"operator\">=</span> access_token_map.get(<span class=\"string\">&quot;openid&quot;</span>); </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">access_token</span> <span class=\"operator\">=</span> access_token_map.get(<span class=\"string\">&quot;access_token&quot;</span>); </span><br><span class=\"line\">    <span class=\"comment\">//æ‹¿access_tokenæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ </span></span><br><span class=\"line\">    Map&lt;String, String&gt; userinfo = getUserinfo(access_token, openid); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(userinfo==<span class=\"literal\">null</span>)&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"comment\">//å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ </span></span><br><span class=\"line\">    <span class=\"type\">XcUser</span> <span class=\"variable\">xcUser</span> <span class=\"operator\">=</span> currentProxy.addWxUser(userinfo); </span><br><span class=\"line\">    <span class=\"keyword\">return</span> xcUser; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<blockquote><p>æ³¨æ„ï¼šéäº‹å‹™æ–¹æ³•èª¿ç”¨äº‹å‹™æ–¹æ³•ï¼Œè¦ä½¿ç”¨ä»£ç†ç‰©ä»¶èª¿ç”¨ï¼Œå‰é¢ä¹Ÿæåˆ°é€™é»<br>\né€™è£¡çš„ addWxUser () æ–¹æ³•æ¶‰åŠäº†å¤šè¡¨æ“ä½œï¼Œæ‰€ä»¥éœ€è¦é€²è¡Œäº‹å‹™æ§åˆ¶ï¼Œè€Œ wxAuth () æ˜¯éäº‹å‹™æ–¹æ³•ï¼Œæ‰€ä»¥é€™è£¡æˆ‘å€‘éœ€è¦æ³¨å…¥è‡ªèº«ï¼Œç„¶å¾Œå‘¼å« addWxUser ()</p>\n</blockquote>\n<p>é‡å•Ÿæœå‹™ï¼Œæƒç¢¼ç™»å…¥æ¸¬è©¦ï¼Œç™»å…¥æˆåŠŸï¼Œä¸¦åœ¨æ•¸æ“šåº«è¨˜éŒ„äº†å¾®ä¿¡ç”¨æˆ¶çš„ä¿¡æ¯ï¼</p>\n<img data-src=\"/John/img/java/SpringSecurity/20.png\" class=\"abc\">\n<img data-src=\"/John/img/java/SpringSecurity/21.png\" class=\"abc\">\n<p><span class=\"rainbow\">ç¸½çµ</span>:<br>\n1ï¸âƒ£å¾å¾®ä¿¡æ‹¿åˆ° JS æ–‡ä»¶ä»£ç¢¼åœ¨å‰ç«¯é¡¯ç¤ºï¼Œç•¶ç”¨æˆ¶æƒç¢¼åŒæ„å¾Œï¼Œurl æœƒé‡å®šå‘æˆ‘å€‘æŒ‡å®šçš„åœ°å€</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var obj = new WxLogin(&#123; </span><br><span class=\"line\">self_redirect:true, </span><br><span class=\"line\">id:&quot;login_container&quot;,  </span><br><span class=\"line\">appid: &quot;ç¶²ç«™æ‡‰ç”¨å¯©æ ¸é€šéå¾Œç²å¾—&quot;,  </span><br><span class=\"line\">scope: &quot;&quot;,  </span><br><span class=\"line\">redirect_uri: http://localhost:8160/auth/wxLogin&quot;, </span><br><span class=\"line\"> state: &quot;&quot;, </span><br><span class=\"line\">style: &quot;&quot;, </span><br><span class=\"line\">href: &quot;&quot; </span><br><span class=\"line\">&#125;); </span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£æœƒé‡å®šå‘æœ¬é …ç›® wxLogin çš„ API, åŸ·è¡Œ wxAuth æ–¹æ³•<br>\n3ï¸âƒ£wxAuth æ–¹æ³•æœƒç”¨ restTemplate é ç¨‹èª¿ç”¨å¾®ä¿¡æ¥å£ï¼šç”³è«‹ä»¤ç‰Œã€æ‹¿è‘—ä»¤ç‰ŒæŸ¥è©¢ç”¨æˆ¶ä¿¡æ¯ï¼Œä¸¦ä¿å­˜åˆ°æˆ‘å€‘çš„æ•¸æ“šåº«<br>\n4ï¸âƒ£åŸ·è¡Œå®Œ wxAuth æ–¹æ³•ï¼Œå› ç‚ºæˆ‘å€‘æ•¸æ“šåº«å·²æœ‰ç”¨æˆ¶ä¿¡æ¯ï¼Œæ‰€ä»¥æœ€å¾Œæœƒé‡å®šå‘åˆ°é …ç›®çš„çµ±ä¸€èªè­‰ç™»éŒ„å…¥å£ï¼Œä¸¦åŸ·è¡Œ execute æ–¹æ³•è‡ªå‹•ç™»å…¥</p>\n <img data-src=\"https://i.makeagif.com/media/9-15-2015/bQkqor.gif\" class=\"abc\" width=\"600\" height=\"350\">\n",
            "tags": [
                "SpringSecurity"
            ]
        },
        {
            "id": "https://superrjohn.github.io/John/2023/10/30/java/SpringSecurity/SpringSecurity",
            "url": "https://superrjohn.github.io/John/2023/10/30/java/SpringSecurity/SpringSecurity",
            "title": "SpringSecurity èªè­‰æˆæ¬Š",
            "date_published": "2023-10-30T14:10:06.589Z",
            "content_html": "<p>åœ¨æ­¤ç‰¹åˆ«æ„Ÿè¬é»‘é¦¬ç¨‹åºå“¡æä¾›çš„èª²ç¨‹: <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMWo4NDExTjdCbS8=\">å­¸æˆåœ¨ç·š</span></p>\n<p>å‰è¨€<br>\næ–¼ç”±å¯¦ç¿’é …ç›®å¿«åšå®Œæ‰åšè¨˜éŒ„ï¼Œè€Œä¸”é …ç›®æ¨¡å¡Šè¼ƒå¤šï¼Œæ•…æŒ‘éƒ¨ä»½ä¾†è¨˜éŒ„ï¼Œæ‰€ä»¥é€™éä¸»è¦æ˜¯ SpringSecurity å…§å®¹ã€‚<br>\n<span class=\"rainbow\">å®Œæ•´é¡¹ç›®åœ°å€</span>ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3N1cGVycmpvaG4vamF2YV93ZWI=\">https://github.com/superrjohn/java_web</span></p>\n<h1 id=\"æ¨¡å¡Šéœ€æ±‚åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#æ¨¡å¡Šéœ€æ±‚åˆ†æ\">#</a> æ¨¡å¡Šéœ€æ±‚åˆ†æ</h1>\n<p>ä»€éº¼æ˜¯èªè­‰æˆæ¬Šï¼Ÿ<br>\n<span class=\"yellow\"> ä»€éº¼æ˜¯èªè­‰ï¼Ÿ</span></p>\n<blockquote><p>èªè­‰å³ä½¿ç”¨è€…å»å­˜å–ç³»çµ±è³‡æºæ™‚ç³»çµ±è¦æ±‚é©—è­‰ä½¿ç”¨è€…çš„èº«åˆ†è¨Šæ¯ï¼Œèº«åˆ†åˆæ³•æ–¹å¯ç¹¼çºŒå­˜å–ã€‚ å¸¸è¦‹çš„ç”¨æˆ¶èº«ä»½èªè­‰çš„è¡¨ç¾å½¢å¼æœ‰ï¼šç”¨æˆ¶åå¯†ç¢¼ç™»éŒ„ï¼Œå¾®ä¿¡æƒç¢¼ç­‰æ–¹å¼ã€‚</p>\n</blockquote>\n<p><span class=\"yellow\">ä»€éº¼æ˜¯æˆæ¬Šï¼Ÿ</span></p>\n<blockquote><p>ä½¿ç”¨è€…èªè­‰é€šéå¾Œå»å­˜å–ç³»çµ±çš„è³‡æºï¼Œç³»çµ±æœƒåˆ¤æ–·ä½¿ç”¨è€…æ˜¯å¦æ“æœ‰å­˜å–è³‡æºçš„æ¬Šé™ï¼Œåªå…è¨±å­˜å–æœ‰æ¬Šé™çš„ç³»çµ±è³‡æºï¼Œæ²’æœ‰æ¬Šé™çš„è³‡æºå°‡ç„¡æ³•å­˜å–ã€‚</p>\n</blockquote>\n<h2 id=\"æ¥­å‹™æµç¨‹\"><a class=\"markdownIt-Anchor\" href=\"#æ¥­å‹™æµç¨‹\">#</a> æ¥­å‹™æµç¨‹</h2>\n<p>1ï¸âƒ£çµ±ä¸€èªè­‰ï¼šè¨ˆç•«åŒ…æ‹¬å­¸ç”Ÿã€å­¸ç¿’æ©Ÿæ§‹çš„è€å¸«ã€å¹³å°ç‡Ÿé‹äººå“¡ä¸‰é¡ç”¨æˆ¶ï¼Œä¸‰é¡ç”¨æˆ¶å°‡ä½¿ç”¨çµ±ä¸€çš„èªè­‰å…¥å£ã€‚</p>\n <img data-src=\"/John/img/java/SpringSecurity/2.png\" class=\"abc\" width=\"600\" height=\"350\">\n<p>2ï¸âƒ£å–®é»ç™»é™¸ï¼šå–®ä¸€ç™»å…¥ï¼ˆSingle Sign Onï¼‰ï¼Œç°¡ç¨± SSOï¼Œæ˜¯ç›®å‰è¼ƒæµè¡Œçš„ä¼æ¥­æ¥­å‹™æ•´åˆçš„è§£æ±ºæ–¹æ¡ˆä¹‹ä¸€ã€‚ SSO çš„å®šç¾©æ˜¯åœ¨å¤šå€‹æ‡‰ç”¨ç³»çµ±ä¸­ï¼Œä½¿ç”¨è€…åªéœ€è¦ç™»å…¥ä¸€æ¬¡å°±å¯ä»¥å­˜å–æ‰€æœ‰äº’ä¿¡çš„æ‡‰ç”¨ç³»çµ±ã€‚</p>\n<p>3ï¸âƒ£ç¬¬ä¸‰æ–¹èªè­‰ï¼šæƒç¢¼ç™»å…¥çš„åŠŸèƒ½ï¼Œå¦‚ï¼šå¾®ä¿¡æƒç¢¼ç™»å…¥ã€QQ æƒç¢¼ç™»å…¥ç­‰ã€‚ æƒç¢¼ç™»å…¥çš„å¥½è™•æ˜¯ç”¨æˆ¶ä¸ç”¨è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼Œçœå»ç”¨æˆ¶è¨»å†Šçš„æˆæœ¬ï¼Œæ˜¯ä¸€ç¨®éå¸¸æœ‰æ•ˆçš„æ¨å»£æ‰‹æ®µã€‚</p>\n<h1 id=\"spring-security-èªè­‰ç ”ç©¶\"><a class=\"markdownIt-Anchor\" href=\"#spring-security-èªè­‰ç ”ç©¶\">#</a> Spring Security èªè­‰ç ”ç©¶</h1>\n<h2 id=\"spring-securityä»‹ç´¹\"><a class=\"markdownIt-Anchor\" href=\"#spring-securityä»‹ç´¹\">#</a> Spring Security ä»‹ç´¹</h2>\n<p>èªè­‰åŠŸèƒ½å¹¾ä¹æ˜¯æ¯å€‹å°ˆæ¡ˆéƒ½è¦å…·å‚™çš„åŠŸèƒ½ï¼Œè€Œä¸”å®ƒèˆ‡æ¥­å‹™ç„¡é—œï¼Œå¸‚é¢ä¸Šæœ‰è¨±å¤šèªè­‰æ¡†æ¶ï¼Œä¾‹å¦‚ï¼šApache Shiroã€CASã€Spring Security ç­‰ã€‚ ç”±æ–¼æœ¬å°ˆæ¡ˆæ˜¯åŸºæ–¼ Spring Cloud æŠ€è¡“æ§‹å»ºï¼ŒSpring Security æ˜¯ spring å®¶æ—çš„ä¸€ä»½å­ä¸”å’Œ Spring Cloud æ•´åˆçš„å¾ˆå¥½ï¼Œå› æ­¤æœ¬å°ˆæ¡ˆé¸ç”¨ Spring Security ä½œç‚ºèªè­‰æœå‹™çš„æŠ€è¡“æ¡†æ¶ã€‚</p>\n<p>Spring Security æ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§ä¸”é«˜åº¦å¯è‡ªè¨‚çš„èº«ä»½é©—è­‰å’Œå­˜å–æ§åˆ¶æ¡†æ¶ï¼Œå®ƒæ˜¯ä¸€å€‹å°ˆæ³¨æ–¼ç‚º Java æ‡‰ç”¨ç¨‹å¼æä¾›èº«ä»½é©—è­‰å’Œæˆæ¬Šçš„æ¡†æ¶ã€‚</p>\n<p>å°ˆæ¡ˆé¦–é ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zcHJpbmcuaW8vcHJvamVjdHMvc3ByaW5nLXNlY3VyaXR5\">https://spring.io/projects/spring-security</span></p>\n<p>Spring cloud Securityï¼š <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zcHJpbmcuaW8vcHJvamVjdHMvc3ByaW5nLWNsb3VkLXNlY3VyaXR5\">https://spring.io/projects/spring-cloud-security</span></p>\n<h3 id=\"èªè­‰æˆæ¬Šå…¥é–€\"><a class=\"markdownIt-Anchor\" href=\"#èªè­‰æˆæ¬Šå…¥é–€\">#</a> èªè­‰æˆæ¬Šå…¥é–€</h3>\n<p>1ï¸âƒ£éƒ¨ç½²èªè­‰æœå‹™å·¥ç¨‹</p>\n<p>å¾èª²ç¨‹è³‡æ–™æ‹·è² xuecheng-plus-auth å·¥ç¨‹åˆ°è‡ªå·±çš„å·¥ç¨‹ç›®éŒ„ä¸‹ã€‚</p>\n<p>æ­¤å·¥ç¨‹æ˜¯ä¸€å€‹æ™®é€šçš„ spring boot å·¥ç¨‹ï¼Œå¯ä»¥é€£æ¥è³‡æ–™åº«ã€‚</p>\n<p>æ­¤å·¥ç¨‹ä¸å…·å‚™èªè­‰æˆæ¬Šçš„åŠŸèƒ½ã€‚</p>\n<p>2ï¸âƒ£å»ºç«‹è³‡æ–™åº«</p>\n<p>å»ºç«‹ xc_users è³‡æ–™åº«</p>\n<p>åŒ¯å…¥èª²ç¨‹è³‡æ–™ä¸­çš„ xcplus_users.sql è…³æœ¬ã€‚</p>\n<p>3ï¸âƒ£ä¿®æ”¹é…ç½®æ–‡ä»¶å’Œåœ¨ nacos è¨»å†Šï¼Œç«¯å£ç‚º 63070</p>\n<h3 id=\"èªè­‰æ¸¬è©¦\"><a class=\"markdownIt-Anchor\" href=\"#èªè­‰æ¸¬è©¦\">#</a> èªè­‰æ¸¬è©¦</h3>\n<p>1ï¸âƒ£ä¸‹é‚Šå‘ auth èªè­‰å·¥ç¨‹æ•´åˆ Spring securityï¼Œå‘ pom.xml åŠ å…¥ Spring Security æ‰€éœ€çš„ä¾è³´</p>\n<figure class=\"highlight xml\"><figcaption><span>pom.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-security<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£åˆå§‹å·¥ç¨‹è‡ªå‚™äº†ä¸€å€‹ Controller é¡ï¼Œå¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span> </span><br><span class=\"line\"><span class=\"meta\">@RestController</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">LoginController</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">  XcUserMapper userMapper; </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"meta\">@RequestMapping(&quot;/login-success&quot;)</span> </span><br><span class=\"line\">  <span class=\"keyword\">public</span> String <span class=\"title function_\">loginSuccess</span><span class=\"params\">()</span>&#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">&quot;ç™»å½•æˆåŠŸ&quot;</span>; </span><br><span class=\"line\">  &#125; </span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"meta\">@RequestMapping(&quot;/user/&#123;id&#125;&quot;)</span> </span><br><span class=\"line\">  <span class=\"keyword\">public</span> XcUser <span class=\"title function_\">getuser</span><span class=\"params\">(<span class=\"meta\">@PathVariable(&quot;id&quot;)</span> String id)</span>&#123; </span><br><span class=\"line\">    <span class=\"type\">XcUser</span> <span class=\"variable\">xcUser</span> <span class=\"operator\">=</span> userMapper.selectById(id); </span><br><span class=\"line\">    <span class=\"keyword\">return</span> xcUser; </span><br><span class=\"line\">  &#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"meta\">@RequestMapping(&quot;/r/r1&quot;)</span> </span><br><span class=\"line\">  <span class=\"keyword\">public</span> String <span class=\"title function_\">r1</span><span class=\"params\">()</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;è®¿é—®r1èµ„æº&quot;</span>; </span><br><span class=\"line\">  &#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"meta\">@RequestMapping(&quot;/r/r2&quot;)</span> </span><br><span class=\"line\">  <span class=\"keyword\">public</span> String <span class=\"title function_\">r2</span><span class=\"params\">()</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;è®¿é—®r2èµ„æº&quot;</span>; </span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>3ï¸âƒ£åœ¨è³‡æ–™ä¸­æ‰¾åˆ° WebSecurityConfig è¨­å®šé¡æ”¾åˆ°æœ¬å·¥ç¨‹ä¸­ï¼Œå®ƒç¹¼æ‰¿ WebSecurityConfigurerAdapter, å®ƒæœ‰ä¸‰éƒ¨ä»½å…§å®¹:<br>\n1. ç”¨æˆ¶è³‡è¨Šï¼šåœ¨è¨˜æ†¶é«”é…ç½®å…©å€‹ä½¿ç”¨è€…ï¼šzhangsanã€lisi,zhangsan ä½¿ç”¨è€…æ“æœ‰çš„æ¬Šé™ç‚º p1,lisi ä½¿ç”¨è€…æ“æœ‰çš„æ¬Šé™ç‚º p2</p>\n<p>2ã€å¯†ç¢¼æ–¹å¼ï¼šæš«æ™‚æ¡ç”¨æ˜æ–‡æ–¹å¼</p>\n<p>3. å®‰å…¨æ””æˆªæ©Ÿåˆ¶:/r/** é–‹é ­çš„è«‹æ±‚éœ€è¦èªè­‰ï¼Œç™»å…¥æˆåŠŸåˆ°æˆåŠŸé é¢ï¼Œç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//é…ç½®ç”¨æˆ·ä¿¡æ¯æœåŠ¡ </span></span><br><span class=\"line\"><span class=\"meta\">@Bean</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> UserDetailsService <span class=\"title function_\">userDetailsService</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œé…ç½®ç”¨æˆ·ä¿¡æ¯,è¿™é‡Œæš‚æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·å­˜å‚¨åœ¨å†…å­˜ä¸­ </span></span><br><span class=\"line\">    <span class=\"type\">InMemoryUserDetailsManager</span> <span class=\"variable\">manager</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InMemoryUserDetailsManager</span>(); </span><br><span class=\"line\">        manager.createUser(User.withUsername(<span class=\"string\">&quot;zhangsan&quot;</span>).password(<span class=\"string\">&quot;123&quot;</span>).authorities(<span class=\"string\">&quot;p1&quot;</span>).build()); </span><br><span class=\"line\">        manager.createUser(User.withUsername(<span class=\"string\">&quot;lisi&quot;</span>).password(<span class=\"string\">&quot;456&quot;</span>).authorities(<span class=\"string\">&quot;p2&quot;</span>).build()); </span><br><span class=\"line\">        <span class=\"keyword\">return</span> manager; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Bean</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> PasswordEncoder <span class=\"title function_\">passwordEncoder</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"comment\">//å¯†ç ä¸ºæ˜æ–‡æ–¹å¼ </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> NoOpPasswordEncoder.getInstance(); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//é…ç½®å®‰å…¨æ‹¦æˆªæœºåˆ¶ </span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span> </span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(HttpSecurity http)</span> <span class=\"keyword\">throws</span> Exception &#123; </span><br><span class=\"line\">        http </span><br><span class=\"line\">                .authorizeRequests() </span><br><span class=\"line\">                .antMatchers(<span class=\"string\">&quot;/r/**&quot;</span>).authenticated()<span class=\"comment\">//è®¿é—®/rå¼€å§‹çš„è¯·æ±‚éœ€è¦è®¤è¯é€šè¿‡ </span></span><br><span class=\"line\">                .anyRequest().permitAll()<span class=\"comment\">//å…¶å®ƒè¯·æ±‚å…¨éƒ¨æ”¾è¡Œ </span></span><br><span class=\"line\">                .and() </span><br><span class=\"line\">                .formLogin().successForwardUrl(<span class=\"string\">&quot;/login-success&quot;</span>);<span class=\"comment\">//ç™»å½•æˆåŠŸè·³è½¬åˆ°/login-success </span></span><br><span class=\"line\">                http.logout().logoutUrl(<span class=\"string\">&quot;/logout&quot;</span>);<span class=\"comment\">//é€€å‡ºåœ°å€ </span></span><br><span class=\"line\">    &#125; </span><br></pre></td></tr></table></figure>\n<p>1. è¨ªå• localhost:63070/auth/login<br>\n2. è¼¸å…¥å¸³è™Ÿ zhangsan, å¯†ç¢¼ 123<br>\n3. ç™»éŒ„æˆåŠŸå¾Œï¼Œé é¢æœƒè·³è½‰ï¼Œé€™æ¨£èªè­‰èº«ä»½å°±å®Œæˆäº†</p>\n<p>4ï¸âƒ£æ·»åŠ æˆæ¬Š<br>\nğŸ”´ä½¿ç”¨è€…èªè­‰é€éå»å­˜å–ç³»çµ±è³‡æºæ™‚ spring security é€²è¡Œæˆæ¬Šæ§åˆ¶ï¼Œåˆ¤æ–·ä½¿ç”¨è€…æ˜¯å¦æœ‰è©²è³‡æºçš„å­˜å–æ¬Šé™ï¼Œå¦‚æœæœ‰å‰‡ç¹¼çºŒè¨ªå•ï¼Œå¦‚æœæ²’æœ‰å‰‡æ‹’çµ•å­˜å–ã€‚<br>\n1. åœ¨ WebSecurityConfig é¡åˆ¥è¨­å®š zhangsan æ“æœ‰ p1 æ¬Šé™ï¼Œlisi æ“æœ‰ p2 æ¬Šé™ã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> UserDetailsService <span class=\"title function_\">userDetailsService</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œé…ç½®ç”¨æˆ·ä¿¡æ¯,è¿™é‡Œæš‚æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·å­˜å‚¨åœ¨å†…å­˜ä¸­ </span></span><br><span class=\"line\">    <span class=\"type\">InMemoryUserDetailsManager</span> <span class=\"variable\">manager</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InMemoryUserDetailsManager</span>(); </span><br><span class=\"line\">    manager.createUser(User.withUsername(<span class=\"string\">&quot;zhangsan&quot;</span>).password(<span class=\"string\">&quot;123&quot;</span>).authorities(<span class=\"string\">&quot;p1&quot;</span>).build()); </span><br><span class=\"line\">    manager.createUser(User.withUsername(<span class=\"string\">&quot;lisi&quot;</span>).password(<span class=\"string\">&quot;456&quot;</span>).authorities(<span class=\"string\">&quot;p2&quot;</span>).build()); </span><br><span class=\"line\">    <span class=\"keyword\">return</span> manager; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>2. åœ¨ controller ä¸­é…ç½® /r/r1 éœ€è¦ p1 æ¬Šé™ï¼Œ/r/r2 éœ€è¦ p2 æ¬Šé™ã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RestController</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">LoginController</span> &#123; </span><br><span class=\"line\">    .... </span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/r/r1&quot;)</span> </span><br><span class=\"line\">    <span class=\"meta\">@PreAuthorize(&quot;hasAuthority(&#x27;p1&#x27;)&quot;)</span><span class=\"comment\">//æ‹¥æœ‰p1æƒé™æ–¹å¯è®¿é—® </span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">r1</span><span class=\"params\">()</span>&#123; </span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">&quot;è®¿é—®r1èµ„æº&quot;</span>; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/r/r2&quot;)</span> </span><br><span class=\"line\">    <span class=\"meta\">@PreAuthorize(&quot;hasAuthority(&#x27;p2&#x27;)&quot;)</span><span class=\"comment\">//æ‹¥æœ‰p2æƒé™æ–¹å¯è®¿é—® </span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">r2</span><span class=\"params\">()</span>&#123; </span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">&quot;è®¿é—®r2èµ„æº&quot;</span>; </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    ... </span><br></pre></td></tr></table></figure>\n<p>ç¾åœ¨ç•¶ç”¨æˆ¶è¨ªå• /r/r1 æ™‚ï¼Œurl æœƒåˆ¤æ–·ç”¨æˆ¶æœ‰æ²’æœ‰è¨ªå•æ¬Šé™ p1, æ‰€ä»¥ zhangsan å¯ä»¥æˆåŠŸè¨ªå•ï¼Œè€Œ lisi ä¸èƒ½ï¼Œå› ç‚º lisi çš„æ¬Šé™ç‚º p2</p>\n<img data-src=\"/John/img/java/SpringSecurity/r1r2.png\" class=\"abc\">\n<p>5ï¸âƒ£å·¥ä½œåŸç†<br>\n Spring Security å° Web è³‡æºçš„ä¿è­·æ˜¯é  Filter å¯¦ç¾çš„ï¼Œæ‰€ä»¥å¾é€™å€‹ Filter ä¾†å…¥æ‰‹ï¼Œé€æ­¥æ·±å…¥ Spring Security åŸç†ã€‚ ç•¶åˆå§‹åŒ– Spring Security æ™‚ï¼Œæœƒå»ºç«‹ä¸€å€‹åç‚º SpringSecurityFilterChain çš„ Servlet éæ¿¾å™¨ï¼Œé¡å‹ç‚º org.springframework.security.web.FilterChainProxyï¼Œå®ƒå¯¦ä½œäº† javax.servlet.Filterï¼Œå› æ­¤å¤–éƒ¨çš„è¦æ±‚æœƒç¶“éæ­¤é¡ï¼Œä¸‹åœ–æ˜¯ Spring Security éæ…®å™¨éˆçµæ§‹åœ–ï¼š</p>\n<img data-src=\"/John/img/java/SpringSecurity/3.png\" class=\"abc\" width=\"400\" height=\"300\">\n<p>FilterChainProxy æ˜¯ä¸€å€‹ä»£ç†ï¼ŒçœŸæ­£é‹ä½œçš„æ˜¯ FilterChainProxy ä¸­ SecurityFilterChain æ‰€åŒ…å«çš„å„å€‹ Filterï¼Œè€Œ Filter ä¸æœƒç›´æ¥è™•ç†èªè­‰å’Œæˆæ¬Šï¼Œè€Œæ˜¯æŠŠå®ƒå€‘äº¤çµ¦äº†èªè­‰ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰å’Œæ±ºç­–ç®¡ç†å™¨ï¼ˆAccessDecisionManagerï¼‰é€²è¡Œè™•ç†ã€‚</p>\n<h1 id=\"oauth2èªè­‰æµç¨‹\"><a class=\"markdownIt-Anchor\" href=\"#oauth2èªè­‰æµç¨‹\">#</a> OAuth2 èªè­‰æµç¨‹</h1>\n<p>åœ¨å‰é‚Šæˆ‘å€‘æåˆ°å¾®ä¿¡æƒç¢¼èªè­‰ï¼Œé€™æ˜¯ä¸€ç¨®ç¬¬ä¸‰æ–¹èªè­‰çš„æ–¹å¼ï¼Œé€™ç¨®èªè­‰æ–¹å¼æ˜¯åŸºæ–¼ OAuth2 å”å®šå¯¦ç¾ï¼Œ</p>\n<p>OAUTH å”å®šç‚ºä½¿ç”¨è€…è³‡æºçš„æˆæ¬Šæä¾›äº†ä¸€å€‹å®‰å…¨çš„ã€é–‹æ”¾è€Œåˆç°¡æ˜“çš„æ¨™æº–ã€‚ åŒæ™‚ï¼Œä»»ä½•ç¬¬ä¸‰æ–¹éƒ½å¯ä»¥ä½¿ç”¨ OAUTH èªè­‰æœå‹™ï¼Œä»»ä½•æœå‹™æä¾›è€…éƒ½å¯ä»¥å¯¦ç¾è‡ªèº«çš„ OAUTH èªè­‰æœå‹™ï¼Œå› è€Œ OAUTH æ˜¯é–‹æ”¾çš„ã€‚ æ¥­ç•Œæä¾›äº† OAUTH çš„å¤šç¨®å¯¦ä½œå¦‚ PHPã€JavaScriptï¼ŒJavaï¼ŒRuby ç­‰å„ç¨®èªè¨€é–‹ç™¼åŒ…ï¼Œå¤§å¤§ç¯€çœäº†ç¨‹å¼è¨­è¨ˆå¸«çš„æ™‚é–“ï¼Œå› è€Œ OAUTH æ˜¯ç°¡æ˜“çš„ã€‚ ç¶²è·¯è¨±å¤šæœå‹™å¦‚ Open APIï¼Œè¨±å¤šå¤§å…¬å¸å¦‚ç©€æ­Œï¼ŒYahooï¼ŒMicrosoft ç­‰éƒ½æä¾›äº† OAUTH èªè­‰æœå‹™ï¼Œé€™äº›éƒ½è¶³ä»¥èªªæ˜ OAUTH æ¨™æº–é€æ¼¸æˆç‚ºé–‹æ”¾è³‡æºæˆæ¬Šçš„æ¨™æº–ã€‚</p>\n<pre><code>     Oauthå”å®šç›®å‰ç™¼å±•åˆ°2.0ç‰ˆæœ¬ï¼Œ1.0ç‰ˆæœ¬éæ–¼è¤‡é›œï¼Œ2.0ç‰ˆæœ¬å·²å»£æ³›æ‡‰ç”¨ã€‚\n</code></pre>\n<p>åƒè€ƒï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS9vQXV0aC83MTUzMTM0P2ZyPWFsYWRkaW4=\">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</span></p>\n<p>Oauth å”è­°ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzY3NDk=\">https://tools.ietf.org/html/rfc6749</span></p>\n<p>ç¾åœ¨ææ¸…æ¥šå¹¾å€‹æ¦‚å¿µï¼š</p>\n<p><span class=\"green\">è³‡æº</span>ï¼šä½¿ç”¨è€…è¨Šæ¯ï¼Œåœ¨å¾®ä¿¡ä¸­å„²å­˜ã€‚</p>\n<p><span class=\"green\">è³‡æºæ“æœ‰è€…</span>ï¼šä½¿ç”¨è€…æ˜¯ä½¿ç”¨è€…è³‡è¨Šè³‡æºçš„æ“æœ‰è€…ã€‚</p>\n<p><span class=\"green\">èªè­‰æœå‹™</span>ï¼šå¾®ä¿¡è² è²¬èªè­‰ç›®å‰ä½¿ç”¨è€…çš„èº«ä»½ï¼Œè² è²¬ç‚ºå®¢æˆ¶ç«¯é ’ç™¼ä»¤ç‰Œã€‚</p>\n<p><span class=\"green\">å®¢æˆ¶ç«¯</span>ï¼šå®¢æˆ¶ç«¯æœƒæ”œå¸¶ä»¤ç‰Œè«‹æ±‚å¾®ä¿¡ç²å–ä½¿ç”¨è€…è¨Šæ¯ï¼Œé»‘é¦¬ç¨‹å¼è¨­è¨ˆå¸«ç¶²ç«™å³å®¢æˆ¶ç«¯ï¼Œé»‘é¦¬ç¶²ç«™éœ€è¦åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿã€‚</p>\n<img data-src=\"/John/img/java/SpringSecurity/4.png\" class=\"abc\" width=\"700\" height=\"300\">\n<p>1. ç”¨æˆ¶é€²å…¥åˆ°ç¶²ç«™æ‰“é–‹æƒç¢¼ç•Œé¢ï¼Œé€²è¡Œå¾®ä¿¡æƒç¢¼<br>\n 2. å¾®ä¿¡è¿”å›ä¿¡æ¯ï¼Œè©¢å•ç”¨æˆ¶æ˜¯å¦æˆæ¬Šå®¢æˆ¶ç«¯ä½¿ç”¨å€‹äººè³‡æ–™ï¼Œç”¨æˆ¶æŒ‰åŒæ„<br>\n 3. å¾®ä¿¡ä¸‹ç™¼æˆæ¬Šç¢¼ï¼Œç¶²ç«™æ‡‰ç”¨å¸¶è‘—æˆæ¬Šç¢¼ç”³è«‹ä»¤ç‰Œï¼Œå¾®ä¿¡ä¸‹ç™¼ä»¤ç‰Œ (éç¨‹ä¸å¯è¦‹)<br>\n 4. ç¶²ç«™æ‡‰ç”¨å¸¶è‘—ä»¤ç‰Œè«‹æ±‚ç”¨æˆ¶å€‹äººä¿¡æ¯ï¼ŒæˆåŠŸä¸¦è¿”å›ç¶²ç«™æ‡‰ç”¨ (éç¨‹ä¸å¯è¦‹)<br>\n 5. ç”¨æˆ¶ç™»éŒ„æˆåŠŸ</p>\n<h2 id=\"oauth2åœ¨æœ¬é …ç›®çš„æ‡‰ç”¨\"><a class=\"markdownIt-Anchor\" href=\"#oauth2åœ¨æœ¬é …ç›®çš„æ‡‰ç”¨\">#</a> OAuth2 åœ¨æœ¬é …ç›®çš„æ‡‰ç”¨</h2>\n<p>äº†è§£å¾®ä¿¡æƒç¢¼ç™»å…¥é»‘é¦¬ç¶²ç«™çš„æµç¨‹ï¼Œæ¥ä¸‹ä¾†èªè­˜ Oauth2.0 çš„èªè­‰æµç¨‹ï¼Œå¼•è‡ª Oauth2.0 å”å®š rfc6749 <span class=\"exturl\" data-url=\"aHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzY3NDk=\">https://tools.ietf.org/html/rfc6749</span> ,<br>\nOauth2 æ˜¯ä¸€å€‹æ¨™æº–çš„é–‹æ”¾çš„æˆæ¬Šå”è­°ï¼Œç”¨æ–¼æ‡‰ç”¨ç¨‹å¼éœ€è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹å¹³å°çš„è³‡æºï¼Œæ‡‰ç”¨ç¨‹å¼å¯ä»¥æ ¹æ“šè‡ªå·±çš„è¦æ±‚å»ä½¿ç”¨ Oauth2ï¼Œæœ¬å°ˆæ¡ˆä½¿ç”¨ Oauth2 å¯¦ç¾ä»¥ä¸‹ç›®æ¨™ï¼š<br>\n1ï¸âƒ£å­¸æˆåœ¨ç·šä¸Šå­˜å–ç¬¬ä¸‰æ–¹ç³»çµ±çš„è³‡æºã€‚</p>\n<p>æœ¬å°ˆæ¡ˆè¦å­˜å–å¾®ä¿¡æƒç¢¼ç™»å…¥æ‰€ä»¥æœ¬å°ˆæ¡ˆè¦ä½¿ç”¨ OAuth2 å”å®šå­˜å–å¾®ä¿¡ä¸­çš„ä½¿ç”¨è€…è³‡è¨Šã€‚</p>\n<p>2ï¸âƒ£å¤–éƒ¨ç³»çµ±è¨ªå•å­¸æˆåœ¨ç·šçš„è³‡æº ã€‚</p>\n<p>åŒæ¨£ç•¶ç¬¬ä¸‰æ–¹ç³»çµ±æƒ³è¦å­˜å–å­¸æˆç·šä¸Šç¶²ç«™çš„è³‡æºä¹Ÿå¯ä»¥åŸºæ–¼ OAuth2 å”è­°ã€‚</p>\n<p>3ï¸âƒ£å­¸æˆç·šä¸Šå‰ç«¯ï¼ˆå®¢æˆ¶ç«¯ï¼‰ å­˜å–å­¸æˆç·šä¸Šå¾®æœå‹™çš„è³‡æºã€‚</p>\n<p>æœ¬å°ˆæ¡ˆæ˜¯å‰å¾Œç«¯åˆ†é›¢æ¶æ§‹ï¼Œå‰ç«¯å­˜å–å¾®æœå‹™è³‡æºä¹Ÿå¯ä»¥åŸºæ–¼ OAuth2 å”å®šé€²è¡Œèªè­‰ã€‚</p>\n<h2 id=\"oauth2çš„æˆæ¬Šæ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#oauth2çš„æˆæ¬Šæ¨¡å¼\">#</a> OAuth2 çš„æˆæ¬Šæ¨¡å¼</h2>\n<p>Spring Security æ”¯æ´ OAuth2 èªè­‰ï¼ŒOAuth2 æä¾›æˆæ¬Šç¢¼æ¨¡å¼ã€å¯†ç¢¼æ¨¡å¼ã€ç°¡åŒ–æ¨¡å¼ã€å®¢æˆ¶ç«¯æ¨¡å¼ç­‰å››ç¨®æˆæ¬Šæ¨¡å¼ï¼Œæœ¬é …ç›®åªæœƒç”¨æˆæ¬Šç¢¼æ¨¡å¼ã€å¯†ç¢¼æ¨¡å¼ã€‚<br>\næˆæ¬Šç¢¼æ¨¡å¼ç°¡å–®ç­è§£æ˜¯ä½¿ç”¨æˆæ¬Šç¢¼å»å–å¾—ä»¤ç‰Œï¼Œè¦æƒ³å–å¾—ä»¤ç‰Œå…ˆè¦å–å¾—æˆæ¬Šç¢¼ï¼Œæˆæ¬Šç¢¼çš„å–å¾—éœ€è¦è³‡æºæ“æœ‰è€…è¦ªè‡ªæˆæ¬ŠåŒæ„æ‰å¯ä»¥å–å¾—ã€‚</p>\n<p>ä¸‹åœ–æ˜¯æˆæ¬Šç¢¼æ¨¡å¼çš„äº’å‹•åœ–ï¼š</p>\n<img data-src=\"/John/img/java/SpringSecurity/5.png\" class=\"abc\" width=\"600\" height=\"400\">\n<h3 id=\"æˆæ¬Šç¢¼æ¨¡å¼æ¸¬è©¦\"><a class=\"markdownIt-Anchor\" href=\"#æˆæ¬Šç¢¼æ¨¡å¼æ¸¬è©¦\">#</a> æˆæ¬Šç¢¼æ¨¡å¼æ¸¬è©¦</h3>\n<p>è‹¥è¦æ¸¬è©¦æˆæ¬Šæ¨¡å¼é¦–å…ˆè¦è¨­å®šæˆæ¬Šä¼ºæœå™¨å³ä¸Šåœ–ä¸­çš„èªè­‰ä¼ºæœå™¨ï¼Œéœ€è¦è¨­å®šæˆæ¬Šæœå‹™åŠä»¤ç‰Œç­–ç•¥ã€‚<br>\n1ï¸âƒ£å¾èª²ç¨‹è³‡æ–™æ‹·è² AuthorizationServer.javaã€TokenConfig.java åˆ°èªè­‰æœå‹™çš„ config å¥—ä»¶ä¸‹ã€‚<br>\nèªªæ˜ï¼šAuthorizationServer ç”¨ @EnableAuthorizationServer è¨»è§£æ¨™è­˜ä¸¦ç¹¼æ‰¿ AuthorizationServerConfigurerAdapter ä¾†è¨­å®š OAuth2.0 æˆæ¬Šä¼ºæœå™¨ã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span> </span><br><span class=\"line\"><span class=\"meta\">@EnableAuthorizationServer</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AuthorizationServer</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AuthorizationServerConfigurerAdapter</span> &#123; </span><br><span class=\"line\">... </span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£AuthorizationServerConfigurerAdapter è¦æ±‚é…ç½®ä»¥ä¸‹å¹¾å€‹é¡åˆ¥ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AuthorizationServerConfigurerAdapter</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AuthorizationServerConfigurer</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">AuthorizationServerConfigurerAdapter</span><span class=\"params\">()</span> &#123;&#125; </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(AuthorizationServerSecurityConfigurer security)</span> <span class=\"keyword\">throws</span> Exception &#123;&#125; </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(ClientDetailsServiceConfigurer clients)</span> <span class=\"keyword\">throws</span> Exception &#123;&#125; </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class=\"keyword\">throws</span> Exception &#123;&#125; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>1ï¼‰ClientDetailsServiceConfigurerï¼šç”¨ä¾†è¨­å®šå®¢æˆ¶ç«¯è©³æƒ…æœå‹™ï¼ˆClientDetailsServiceï¼‰ï¼Œ</p>\n<p>éš¨ä¾¿ä¸€å€‹å®¢æˆ¶ç«¯éƒ½å¯ä»¥éš¨ä¾¿æ¥å–å®ƒçš„èªè­‰æœå‹™å—ï¼Ÿ ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œæœå‹™æä¾›è€…æœƒçµ¦æ‰¹å‡†å­˜å–çš„å®¢æˆ¶ç«¯ä¸€å€‹èº«ä»½ï¼Œç”¨æ–¼å­˜å–æ™‚çš„æ†‘è­‰ï¼Œæœ‰å®¢æˆ¶ç«¯æ¨™è­˜å’Œå®¢æˆ¶ç«¯ç§˜é‘°ï¼Œåœ¨é€™è£¡é…ç½®æ‰¹å‡†å­˜å–çš„å®¢æˆ¶ç«¯çš„è©³ç´°è³‡è¨Šã€‚</p>\n<p>2ï¼‰AuthorizationServerEndpointsConfigurerï¼šç”¨ä¾†è¨­å®šä»¤ç‰Œï¼ˆtokenï¼‰çš„å­˜å–ç«¯é»å’Œä»¤ç‰Œæœå‹™ (token services)ã€‚</p>\n<p>3ï¼‰AuthorizationServerSecurityConfigurerï¼šç”¨ä¾†è¨­å®šä»¤ç‰Œç«¯é»çš„å®‰å…¨æ€§é™åˆ¶.</p>\n<p>2ã€TokenConfig ç‚ºä»¤ç‰Œç­–ç•¥é…ç½®é¡</p>\n<p>æš«æ™‚å…ˆä½¿ç”¨ InMemoryTokenStore åœ¨è¨˜æ†¶é«”å„²å­˜ä»¤ç‰Œï¼Œä»¤ç‰Œçš„æœ‰æ•ˆæœŸé™ç­‰è³‡è¨Šé…ç½®å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ä»¤ç‰Œç®¡ç†æœåŠ¡ </span></span><br><span class=\"line\"><span class=\"meta\">@Bean(name=&quot;authorizationServerTokenServicesCustom&quot;)</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> AuthorizationServerTokenServices <span class=\"title function_\">tokenService</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">    DefaultTokenServices service=<span class=\"keyword\">new</span> <span class=\"title class_\">DefaultTokenServices</span>(); </span><br><span class=\"line\">    service.setSupportRefreshToken(<span class=\"literal\">true</span>);<span class=\"comment\">//æ”¯æŒåˆ·æ–°ä»¤ç‰Œ </span></span><br><span class=\"line\">    service.setTokenStore(tokenStore);<span class=\"comment\">//ä»¤ç‰Œå­˜å‚¨ç­–ç•¥ </span></span><br><span class=\"line\">    service.setAccessTokenValiditySeconds(<span class=\"number\">7200</span>); <span class=\"comment\">// ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ2å°æ—¶ </span></span><br><span class=\"line\">    service.setRefreshTokenValiditySeconds(<span class=\"number\">259200</span>); <span class=\"comment\">// åˆ·æ–°ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ3å¤© </span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> service; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>3ï¸âƒ£é…ç½®èªè­‰ç®¡ç† bean</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@EnableWebSecurity</span> </span><br><span class=\"line\"><span class=\"meta\">@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">WebSecurityConfig</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">WebSecurityConfigurerAdapter</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Bean</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> AuthenticationManager <span class=\"title function_\">authenticationManagerBean</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.authenticationManagerBean(); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    .... </span><br></pre></td></tr></table></figure>\n<p>4ï¸âƒ£é‡å•Ÿèªè­‰æœå‹™</p>\n<p>1.get è«‹æ±‚å–å¾—æˆæ¬Šç¢¼</p>\n<p>ä½å€: <span class=\"exturl\" data-url=\"aHR0cDovL2xvY2FsaG9zdDo2MzA3MC9hdXRoL29hdXRoL2F1dGhvcml6ZT9jbGllbnRfaWQ9WGNXZWJBcHAmYW1wO3Jlc3BvbnNlX3R5cGU9Y29kZSZhbXA7c2NvcGU9YWxsJmFtcDtyZWRpcmVjdF91cmk9aHR0cDovL3d3dy41MXh1ZWNoZW5nLmNu\">http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</span></p>\n<p>åƒæ•¸åˆ—è¡¨å¦‚ä¸‹ï¼š</p>\n<p>client_idï¼šå®¢æˆ¶ç«¯å‡†å…¥æ¨™è­˜ã€‚</p>\n<p>response_typeï¼šæˆæ¬Šç¢¼æ¨¡å¼å›ºå®šç‚º codeã€‚</p>\n<p>scopeï¼šå®¢æˆ¶ç«¯æ¬Šé™ã€‚</p>\n<p>redirect_uriï¼šè·³è½‰ uriï¼Œæˆæ¬Šç¢¼ç”³è«‹æˆåŠŸå¾Œæœƒè·³åˆ°æ­¤ä½å€ï¼Œå¾Œé‚Šå¸¶ä¸Š code åƒæ•¸ï¼ˆæˆæ¬Šç¢¼ï¼‰ã€‚</p>\n<p>è¼¸å…¥å¸³è™Ÿ zhangsanã€å¯†ç¢¼ 123 ç™»å…¥æˆåŠŸï¼Œè¼¸å…¥ /oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy41MXh1ZWNoZW5nLmNu\">http://www.51xuecheng.cn</span></p>\n<p>é¡¯ç¤ºæˆæ¬Šé é¢</p>\n<img data-src=\"/John/img/java/SpringSecurity/6.png\" class=\"abc\">\n<p>æˆæ¬Šã€ŒXcWebAppã€å­˜å–è‡ªå·±çš„å—ä¿è­·è³‡æºï¼Ÿ</p>\n<p>é¸æ“‡åŒæ„ã€‚</p>\n<p>2. è«‹æ±‚æˆåŠŸï¼Œé‡æ–°å°å‘è‡³<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy41MXh1ZWNoZW5nLmNuLz9jb2RlPSVFNiU4RSU4OCVFNiVBQyU4QSVFNyVBMiVCQyVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QWh0dHA6Ly93d3cuNTF4dWVjaGVuZy5jbi8/Y29kZT1XcWpiNUg=\"> http://www.51xuecheng.cn/?code = æˆæ¬Šç¢¼ï¼Œä¾‹å¦‚ï¼šhttp://www.51xuecheng.cn/?code=Wqjb5H</span><br>\n3. ä½¿ç”¨ httpclient å·¥å…· post ç”³è«‹ä»¤ç‰Œ</p>\n<p>/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code = æˆæ¬Šç¢¼ &amp; redirect_uri=<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy41MXh1ZWNoZW5nLmNuLw==\">http://www.51xuecheng.cn/</span></p>\n<p>åƒæ•¸åˆ—è¡¨å¦‚ä¸‹</p>\n<p>client_idï¼šå®¢æˆ¶ç«¯å‡†å…¥æ¨™è­˜ã€‚</p>\n<p>client_secretï¼šå®¢æˆ¶ç«¯ç§˜é‘°ã€‚</p>\n<p>grant_typeï¼šæˆæ¬Šé¡å‹ï¼Œå¡«å…¥ authorization_codeï¼Œè¡¨ç¤ºæˆæ¬Šç¢¼æ¨¡å¼</p>\n<p>codeï¼šæˆæ¬Šç¢¼ï¼Œå°±æ˜¯å‰›å‰›å–å¾—çš„æˆæ¬Šç¢¼ï¼Œæ³¨æ„ï¼šæˆæ¬Šç¢¼åªä½¿ç”¨ä¸€æ¬¡å°±ç„¡æ•ˆäº†ï¼Œéœ€è¦é‡æ–°ç”³è«‹ã€‚</p>\n<p>redirect_uriï¼šç”³è«‹æˆæ¬Šç¢¼æ™‚çš„è·³åˆ° urlï¼Œä¸€å®šå’Œç”³è«‹æˆæ¬Šç¢¼æ™‚ç”¨çš„ redirect_uri ä¸€è‡´ã€‚</p>\n<p>httpclient è…³æœ¬å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight text\"><figcaption><span>text</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### ç¬¬äºŒæ­¥ç”³è¯·ä»¤ç‰Œ </span><br><span class=\"line\">POST &#123;&#123;auth_host&#125;&#125;/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=CTvCrB&amp;redirect_uri=http://www.51xuecheng.cn1</span><br></pre></td></tr></table></figure>\n<p>ç”³è«‹ä»¤ç‰ŒæˆåŠŸå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;access_token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;368b1ee7-a9ee-4e9a-aae6-0fcab243aad2&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;token_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;bearer&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;refresh_token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;3d56e139-0ee6-4ace-8cbe-1311dfaa991f&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;expires_in&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">7199</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;all&quot;</span> </span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span> </span><br></pre></td></tr></table></figure>\n<p>èªªæ˜ï¼š<br>\n1ã€access_tokenï¼Œå­˜å–ä»¤ç‰Œï¼Œç”¨æ–¼å­˜å–è³‡æºä½¿ç”¨ã€‚<br>\n2ã€token_typeï¼Œbearer æ˜¯åœ¨ RFC6750 ä¸­å®šç¾©çš„ä¸€ç¨® token é¡å‹ï¼Œåœ¨æ”œå¸¶ä»¤ç‰Œå­˜å–è³‡æºæ™‚éœ€è¦åœ¨ head ä¸­åŠ å…¥ bearer ç©ºæ ¼ ä»¤ç‰Œå…§å®¹<br>\n 3ã€refresh_tokenï¼Œç•¶ä»¤ç‰Œå¿«éæœŸæ™‚ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œå¯ä»¥å†æ¬¡ç”¢ç”Ÿä»¤ç‰Œã€‚<br>\n4ã€expires_inï¼šéæœŸæ™‚é–“ï¼ˆç§’ï¼‰<br>\n5ã€scopeï¼Œä»¤ç‰Œçš„æ¬Šé™ç¯„åœï¼Œæœå‹™ç«¯å¯ä»¥æ ¹æ“šä»¤ç‰Œçš„æ¬Šé™ç¯„åœå»å°ä»¤ç‰Œæˆæ¬Šã€‚</p>\n<h3 id=\"å¯†ç¢¼æ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#å¯†ç¢¼æ¨¡å¼\">#</a> å¯†ç¢¼æ¨¡å¼</h3>\n<p>å¯†ç¢¼æ¨¡å¼ç›¸å°æˆæ¬Šç¢¼æ¨¡å¼ç°¡å–®ï¼Œæˆæ¬Šç¢¼æ¨¡å¼éœ€ä½¿ç”¨ç€è¦½å™¨ä¾›ä½¿ç”¨è€…è¦ªè‡ªæˆæ¬Šï¼Œå¯†ç¢¼æ¨¡å¼ä¸ç”¨ä½¿ç”¨ç€è¦½å™¨<br>\n 1. è³‡æºæ“æœ‰è€…æä¾›å¸³è™ŸåŠå¯†ç¢¼</p>\n<p>2ã€å®¢æˆ¶ç«¯å‘èªè­‰æœå‹™ç”³è«‹ä»¤ç‰Œï¼Œè«‹æ±‚ä¸­æ”œå¸¶å¸³è™ŸåŠå¯†ç¢¼</p>\n<p>3ã€èªè­‰æœå‹™æ ¡é©—å¸³è™ŸåŠå¯†ç¢¼æ­£ç¢ºæ ¸ç™¼ä»¤ç‰Œã€‚<br>\n1ã€POST è«‹æ±‚å–å¾—ä»¤ç‰Œ</p>\n<p>/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=shangsan&amp;password=123</p>\n<p>åƒæ•¸åˆ—è¡¨å¦‚ä¸‹ï¼š</p>\n<p>client_idï¼šå®¢æˆ¶ç«¯å‡†å…¥æ¨™è­˜ã€‚</p>\n<p>client_secretï¼šå®¢æˆ¶ç«¯ç§˜é‘°ã€‚</p>\n<p>grant_typeï¼šæˆæ¬Šé¡å‹ï¼Œå¡«å…¥ password è¡¨ç¤ºå¯†ç¢¼æ¨¡å¼</p>\n<p>usernameï¼šè³‡æºæ“æœ‰è€…ä½¿ç”¨è€…åç¨±ã€‚</p>\n<p>passwordï¼šè³‡æºæ“æœ‰è€…å¯†ç¢¼ã€‚</p>\n<p>2ã€æˆæ¬Šä¼ºæœå™¨å°‡ä»¤ç‰Œï¼ˆaccess_tokenï¼‰å‚³é€çµ¦ client</p>\n<p>ä½¿ç”¨ httpclient é€²è¡Œæ¸¬è©¦</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### å¯†ç æ¨¡å¼ </span><br><span class=\"line\">POST &#123;&#123;auth_host&#125;&#125;/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=zhangsan&amp;password=<span class=\"number\">123</span> </span><br></pre></td></tr></table></figure>\n<p>è¿”å›ç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;access_token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;368b1ee7-a9ee-4e9a-aae6-0fcab243aad2&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;token_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;bearer&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;refresh_token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;3d56e139-0ee6-4ace-8cbe-1311dfaa991f&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;expires_in&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">6806</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;all&quot;</span> </span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span> </span><br></pre></td></tr></table></figure>\n<h1 id=\"jwtä»¤ç‰Œ\"><a class=\"markdownIt-Anchor\" href=\"#jwtä»¤ç‰Œ\">#</a> JWT ä»¤ç‰Œ</h1>\n<h2 id=\"æ™®é€šä»¤ç‰Œçš„å•é¡Œ\"><a class=\"markdownIt-Anchor\" href=\"#æ™®é€šä»¤ç‰Œçš„å•é¡Œ\">#</a> æ™®é€šä»¤ç‰Œçš„å•é¡Œ</h2>\n<p>å®¢æˆ¶ç«¯ç”³è«‹åˆ°ä»¤ç‰Œï¼Œæ¥ä¸‹ä¾†å®¢æˆ¶ç«¯æ”œå¸¶ä»¤ç‰Œå»å­˜å–è³‡æºï¼Œåˆ°è³‡æºä¼ºæœå™¨å°‡æœƒæ ¡é©—ä»¤ç‰Œçš„åˆæ³•æ€§ã€‚<br>\nè³‡æºä¼ºæœå™¨å¦‚ä½•æ ¡é©—ä»¤ç‰Œçš„åˆæ³•æ€§ï¼Ÿæˆ‘å€‘ä»¥ OAuth2 çš„å¯†ç¢¼æ¨¡å¼ç‚ºä¾‹é€²è¡Œèªªæ˜ï¼š</p>\n<img data-src=\"/John/img/java/SpringSecurity/7.png\" class=\"abc\" width=\"700\" height=\"400\">\n<p>ğŸ‰é€™è£¡å­˜åœ¨ä¸€å€‹å•é¡Œï¼š<br>\nå°±æ˜¯æ ¡é©—ä»¤ç‰Œéœ€è¦é ç«¯è«‹æ±‚èªè­‰æœå‹™ï¼Œå®¢æˆ¶ç«¯çš„æ¯æ¬¡å­˜å–éƒ½æœƒé ç«¯æ ¡é©—ï¼ŒåŸ·è¡Œæ•ˆèƒ½ä½ã€‚<br>\nå¦‚æœèƒ½å¤ è®“è³‡æºæœå‹™è‡ªå·±æ ¡é©—ä»¤ç‰Œçš„åˆæ³•æ€§å°‡çœå»é ç«¯è«‹æ±‚èªè­‰æœå‹™çš„æˆæœ¬ï¼Œæé«˜äº†æ•ˆèƒ½</p>\n<p>ğŸ‰å¦‚ä½•è§£æ±ºä¸Šé‚Šçš„å•é¡Œï¼Œå¯¦ç¾è³‡æºæœå‹™è‡ªè¡Œæ ¡é©—ä»¤ç‰Œ:</p>\n<h2 id=\"ä»€ä¹ˆæ˜¯jwt\"><a class=\"markdownIt-Anchor\" href=\"#ä»€ä¹ˆæ˜¯jwt\">#</a> ä»€ä¹ˆæ˜¯ JWT</h2>\n<p>ğŸŸ¢ä»¤ç‰Œæ¡ç”¨ JWT æ ¼å¼å³å¯è§£æ±ºä¸Šé‚Šçš„å•é¡Œï¼Œç”¨æˆ¶èªè­‰é€šéå¾Œæœƒå¾—åˆ°ä¸€å€‹ JWT ä»¤ç‰Œï¼ŒJWT ä»¤ç‰Œä¸­å·²ç¶“åŒ…æ‹¬äº†ç”¨æˆ¶ç›¸é—œçš„ä¿¡æ¯ï¼Œå®¢æˆ¶ç«¯åªéœ€è¦æ”œå¸¶ JWT è¨ªå•è³‡æºæœå‹™ï¼Œè³‡æºæœå‹™æ ¹æ“šäº‹å…ˆç´„å®š çš„æ¼”ç®—æ³•è‡ªè¡Œå®Œæˆä»¤ç‰Œæ ¡é©—ï¼Œç„¡éœ€æ¯æ¬¡éƒ½è«‹æ±‚èªè­‰æœå‹™å®Œæˆæˆæ¬Šã€‚</p>\n<p>ğŸŸ¡JSON Web Tokenï¼ˆJWTï¼‰æ˜¯ä¸€ç¨®ä½¿ç”¨ JSON æ ¼å¼å‚³éè³‡æ–™çš„ç¶²è·¯ä»¤ç‰ŒæŠ€è¡“ï¼Œå®ƒæ˜¯ä¸€å€‹é–‹æ”¾çš„è¡Œæ¥­æ¨™æº–ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šç¾©äº†ä¸€ç¨®ç°¡æ½”çš„ã€è‡ªåŒ…å«çš„å”è­°æ ¼å¼ï¼Œç”¨æ–¼åœ¨é€šä¿¡ é›™æ–¹å‚³é json å°è±¡ï¼Œå‚³éçš„è¨Šæ¯ç¶“éæ•¸ä½ç°½ç« å¯ä»¥é©—è­‰å’Œä¿¡ä»»ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ HMAC æ¼”ç®—æ³•æˆ–ä½¿ç”¨ RSA çš„å…¬é‘° / ç§é‘°å°ä¾†ç°½åï¼Œé˜²æ­¢å…§å®¹ç¯¡æ”¹ã€‚ å®˜ç¶²ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly9qd3QuaW8v\">https://jwt.io/</span></p>\n<p>ğŸ”´å‚³çµ±çš„åŸºæ–¼ session çš„æ–¹å¼æ˜¯æœ‰ç‹€æ…‹èªè­‰ï¼Œä½¿ç”¨è€…ç™»å…¥æˆåŠŸå°‡ä½¿ç”¨è€…çš„èº«ä»½è³‡è¨Šå„²å­˜åœ¨æœå‹™ç«¯ï¼Œé€™æ¨£åŠ å¤§äº†æœå‹™ç«¯çš„å„²å­˜å£“åŠ›ï¼Œä¸¦ä¸”é€™ç¨®æ–¹å¼ä¸é©åˆåœ¨åˆ†æ•£å¼ç³»çµ±ä¸­æ‡‰ç”¨ã€‚<br>\nå¦‚ä¸‹åœ–ï¼Œç•¶ç”¨æˆ¶è¨ªå•æ‡‰ç”¨æœå‹™ï¼Œæ¯å€‹æ‡‰ç”¨æœå‹™éƒ½æœƒå»ä¼ºæœå™¨æŸ¥çœ‹ session ä¿¡æ¯ï¼Œå¦‚æœ session ä¸­æ²’æœ‰è©²ç”¨æˆ¶å‰‡èªªæ˜ç”¨æˆ¶æ²’æœ‰ç™»éŒ„ï¼Œæ­¤æ™‚å°±æœƒé‡æ–°èªè­‰ï¼Œè€Œè§£æ±ºé€™å€‹å•é¡Œçš„æ–¹æ³•æ˜¯ Session è¤‡è£½ã€Session é»è²¼ã€‚</p>\n<img data-src=\"/John/img/java/SpringSecurity/8.png\" class=\"abc\" width=\"700\" height=\"400\">\n<p>ğŸŸ¢å¦‚æœæ˜¯åŸºæ–¼ä»¤ç‰ŒæŠ€è¡“åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­å¯¦ç¾èªè­‰å‰‡æœå‹™ç«¯ä¸ç”¨å„²å­˜ sessionï¼Œå¯ä»¥å°‡ç”¨æˆ¶è­˜åˆ¥è³‡è¨Šå„²å­˜åœ¨ä»¤ç‰Œä¸­ï¼Œç”¨æˆ¶èªè­‰é€éå¾Œèªè­‰æœå‹™é ’ç™¼ä»¤ç‰Œçµ¦ç”¨æˆ¶ï¼Œç”¨æˆ¶å°‡ä»¤ç‰Œå„²å­˜åœ¨å®¢æˆ¶ ç«¯ï¼Œå»è¨ªå•æ‡‰ç”¨æœå‹™æ™‚æ”œå¸¶ä»¤ç‰Œå»è¨ªå•ï¼Œæœå‹™ç«¯å¾ jwt è§£æå‡ºç”¨æˆ¶è³‡è¨Šã€‚ é€™å€‹éç¨‹å°±æ˜¯ç„¡ç‹€æ…‹èªè­‰ã€‚</p>\n<p>JWT ä»¤ç‰Œçš„å„ªé»ï¼š<br>\n1ï¸âƒ£jwt åŸºæ–¼ jsonï¼Œéå¸¸æ–¹ä¾¿è§£æã€‚<br>\n2ï¸âƒ£å¯ä»¥åœ¨ä»¤ç‰Œä¸­è‡ªè¨‚è±å¯Œçš„å…§å®¹ï¼Œæ˜“æ“´å……ã€‚<br>\n3ï¸âƒ£é€ééå°ç¨±åŠ å¯†æ¼”ç®—æ³•åŠæ•¸ä½ç°½ç« æŠ€è¡“ï¼ŒJWT é˜²æ­¢ç«„æ”¹ï¼Œå®‰å…¨æ€§é«˜ã€‚<br>\n4ï¸âƒ£è³‡æºæœå‹™ä½¿ç”¨ JWT å¯ä¸ä¾è³´èªè­‰æœå‹™å³å¯å®Œæˆæˆæ¬Šã€‚<br>\nç¼ºé»ï¼š<br>\nJWT ä»¤ç‰Œè¼ƒé•·ï¼Œä½”å„²å­˜ç©ºé–“æ¯”è¼ƒå¤§ã€‚</p>\n<p>JWT ä»¤ç‰Œç”±ä¸‰éƒ¨åˆ†çµ„æˆï¼Œæ¯éƒ¨åˆ†ä¸­é–“ä½¿ç”¨ç‚¹ï¼ˆ.ï¼‰åˆ†éš”ï¼Œæ¯”å¦‚ï¼šxxxxx.yyyyy.zzzzz<br>\n1ï¸âƒ£Header<br>\n é ­éƒ¨åŒ…æ‹¬ä»¤ç‰Œçš„é¡å‹ï¼ˆå³ JWTï¼‰åŠä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼ˆå¦‚ HMAC SHA256 æˆ– RSAï¼‰<br>\nå†…å®¹ä½¿ç”¨ Base64Url ç¼–ç ï¼Œå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å°±æ˜¯ JWT ä»¤ç‰Œçš„ç¬¬ä¸€éƒ¨åˆ†ã€‚</p>\n  <figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"punctuation\">&#123;</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;alg&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;HS256&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;typ&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;JWT&quot;</span> </span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span> </span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£Payload<br>\n ç¬¬äºŒéƒ¨åˆ†æ˜¯è² è¼‰ï¼Œå…§å®¹ä¹Ÿæ˜¯ä¸€å€‹ json å°è±¡ï¼Œå®ƒæ˜¯å­˜æ”¾æœ‰æ•ˆè³‡è¨Šçš„åœ°æ–¹ï¼Œå®ƒå¯ä»¥å­˜æ”¾ jwt æä¾›çš„è³‡è¨Šå­—æ®µï¼Œä¾‹å¦‚ï¼šissï¼ˆç°½ç™¼è€…ï¼‰,expï¼ˆéæœŸæ™‚é–“æˆ³è¨˜ï¼‰, subï¼ˆé¢å‘çš„ä½¿ç”¨è€…ï¼‰ ç­‰ï¼Œä¹Ÿå¯è‡ªè¨‚æ¬„ä½ã€‚<br>\næ­¤éƒ¨åˆ†ä¸å»ºè­°å­˜æ”¾æ•æ„Ÿè¨Šæ¯ï¼Œå› ç‚ºæ­¤éƒ¨åˆ†å¯ä»¥è§£ç¢¼é‚„åŸåŸå§‹å…§å®¹ã€‚<br>\næœ€å¾Œå°‡ç¬¬äºŒéƒ¨åˆ†è² è¼‰ä½¿ç”¨ Base64Url ç·¨ç¢¼ï¼Œå¾—åˆ°ä¸€å€‹å­—ä¸²å°±æ˜¯ JWT ä»¤ç‰Œçš„ç¬¬äºŒéƒ¨åˆ†ã€‚</p>\n<figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;sub&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;1234567890&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;456&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;admin&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span> </span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span> </span><br></pre></td></tr></table></figure>\n<p>3ï¸âƒ£Signature<br>\n ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ç°½åï¼Œæ­¤éƒ¨åˆ†ç”¨æ–¼é˜²æ­¢ jwt å…§å®¹è¢«ç«„æ”¹ã€‚<br>\né€™å€‹éƒ¨åˆ†ä½¿ç”¨ base64url å°‡å‰å…©éƒ¨åˆ†ç·¨ç¢¼ï¼Œç·¨ç¢¼å¾Œä½¿ç”¨é»ï¼ˆ.ï¼‰é€£æ¥çµ„æˆå­—ä¸²ï¼Œæœ€å¾Œä½¿ç”¨ header ä¸­è²æ˜çš„ç°½ç« æ¼”ç®—æ³•é€²è¡Œç°½ç« ã€‚</p>\n<figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HMACSHA256( </span><br><span class=\"line\">  base64UrlEncode(header) + <span class=\"string\">&quot;.&quot;</span> + </span><br><span class=\"line\">  base64UrlEncode(payload)<span class=\"punctuation\">,</span> </span><br><span class=\"line\">  secret) </span><br></pre></td></tr></table></figure>\n<p><span class=\"green\">ç‚ºä»€éº¼ JWT å¯ä»¥é˜²æ­¢ç¯¡æ”¹ï¼Ÿ</span></p>\n<blockquote><p>ç¬¬ä¸‰éƒ¨åˆ†ä½¿ç”¨ç°½åæ¼”ç®—æ³•å°ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬äºŒéƒ¨åˆ†çš„å…§å®¹é€²è¡Œç°½åï¼Œå¸¸ç”¨çš„ç°½åæ¼”ç®—æ³•æ˜¯ HS256ï¼Œå¸¸è¦‹çš„é‚„æœ‰ md5,sha ç­‰ï¼Œç°½åæ¼”ç®—æ³•éœ€è¦ä½¿ç”¨é‡‘é‘°é€²è¡Œç°½åï¼Œé‡‘é‘°ä¸å°å¤–å…¬é–‹ï¼Œä¸” ç°½ç« æ˜¯ä¸å¯é€†çš„ï¼Œå¦‚æœç¬¬ä¸‰æ–¹æ›´æ”¹äº†å…§å®¹é‚£éº¼ä¼ºæœå™¨é©—è­‰ç°½ç« å°±æœƒå¤±æ•—ï¼Œè¦æƒ³ä¿è­‰é©—è­‰ç°½ç« æ­£ç¢ºå¿…é ˆä¿è­‰å…§å®¹ã€é‡‘é‘°èˆ‡ç°½ç« å‰ä¸€è‡´ã€‚</p>\n</blockquote>\n<img data-src=\"/John/img/java/SpringSecurity/9.png\" class=\"abc\" width=\"700\" height=\"400\">\n<p>å¾ä¸Šåœ–å¯ä»¥çœ‹å‡ºèªè­‰æœå‹™å’Œè³‡æºæœå‹™ä½¿ç”¨ç›¸åŒçš„é‡‘é‘°ï¼Œé€™å«å°ç¨±åŠ å¯†ï¼Œå°ç¨±åŠ å¯†æ•ˆç‡é«˜ï¼Œå¦‚æœä¸€æ—¦é‡‘é‘°å¤–æ´©å¯ä»¥å½é€  jwt ä»¤ç‰Œï¼ŒJWT é‚„å¯ä»¥ä½¿ç”¨éå°ç¨±åŠ å¯†ï¼Œèªè­‰æœå‹™è‡ªå·±ä¿ç•™ç§é‘°ï¼Œå°‡å…¬é‘°ä¸‹ç™¼çµ¦å—ä¿¡ä»»çš„å®¢æˆ¶ç«¯ã€è³‡æºæœå‹™ï¼Œå…¬é‘°å’Œç§é‘°æ˜¯é…å°çš„ï¼Œæˆå°çš„å…¬é‘°å’Œç§é‘°æ‰å¯ä»¥æ­£å¸¸ åŠ å¯†å’Œè§£å¯†ï¼Œéå°ç¨±åŠ å¯†æ•ˆç‡ä½ä½†ç›¸æ¯”å°ç¨±åŠ å¯†éå°ç¨±åŠ å¯†æ›´å®‰å…¨ä¸€äº›ã€‚</p>\n<h2 id=\"243-æ¸¬è©¦ç”¢ç”Ÿjwtä»¤ç‰Œ\"><a class=\"markdownIt-Anchor\" href=\"#243-æ¸¬è©¦ç”¢ç”Ÿjwtä»¤ç‰Œ\">#</a> 2.4.3 æ¸¬è©¦ç”¢ç”Ÿ JWT ä»¤ç‰Œ</h2>\n<p>1ï¸âƒ£åœ¨èªè­‰æœå‹™ä¸­é…ç½® jwt ä»¤ç‰Œæœå‹™ï¼Œå³å¯å¯¦ç¾ç”¢ç”Ÿ jwt æ ¼å¼çš„ä»¤ç‰Œ</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TokenConfig</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">String</span> <span class=\"variable\">SIGNING_KEY</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;mq123&quot;</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">    TokenStore tokenStore; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">    <span class=\"keyword\">private</span> JwtAccessTokenConverter accessTokenConverter; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Bean</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> TokenStore <span class=\"title function_\">tokenStore</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JwtTokenStore</span>(accessTokenConverter()); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Bean</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> JwtAccessTokenConverter <span class=\"title function_\">accessTokenConverter</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"type\">JwtAccessTokenConverter</span> <span class=\"variable\">converter</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JwtAccessTokenConverter</span>(); </span><br><span class=\"line\">        converter.setSigningKey(SIGNING_KEY); </span><br><span class=\"line\">        <span class=\"keyword\">return</span> converter; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//ä»¤ç‰Œç®¡ç†æœåŠ¡ </span></span><br><span class=\"line\">    <span class=\"meta\">@Bean(name=&quot;authorizationServerTokenServicesCustom&quot;)</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> AuthorizationServerTokenServices <span class=\"title function_\">tokenService</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        DefaultTokenServices service=<span class=\"keyword\">new</span> <span class=\"title class_\">DefaultTokenServices</span>(); </span><br><span class=\"line\">        service.setSupportRefreshToken(<span class=\"literal\">true</span>);<span class=\"comment\">//æ”¯æŒåˆ·æ–°ä»¤ç‰Œ </span></span><br><span class=\"line\">        service.setTokenStore(tokenStore);<span class=\"comment\">//ä»¤ç‰Œå­˜å‚¨ç­–ç•¥ </span></span><br><span class=\"line\"> </span><br><span class=\"line\">        <span class=\"type\">TokenEnhancerChain</span> <span class=\"variable\">tokenEnhancerChain</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">TokenEnhancerChain</span>(); </span><br><span class=\"line\">        tokenEnhancerChain.setTokenEnhancers(Arrays.asList(accessTokenConverter)); </span><br><span class=\"line\">        service.setTokenEnhancer(tokenEnhancerChain); </span><br><span class=\"line\"> </span><br><span class=\"line\">        service.setAccessTokenValiditySeconds(<span class=\"number\">7200</span>); <span class=\"comment\">// ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ2å°æ—¶ </span></span><br><span class=\"line\">        service.setRefreshTokenValiditySeconds(<span class=\"number\">259200</span>); <span class=\"comment\">// åˆ·æ–°ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ3å¤© </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> service; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£ä½¿ç”¨ httpclient é€šè¿‡å¯†ç æ¨¡å¼ç”³è¯·ä»¤ç‰Œ</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### å¯†ç æ¨¡å¼ </span><br><span class=\"line\">POST &#123;&#123;auth_host&#125;&#125;/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=zhangsan&amp;password=<span class=\"number\">123</span> </span><br></pre></td></tr></table></figure>\n<p>ç”Ÿæˆ jwt çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;access_token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzE2OTUsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImU5ZDNkMGZkLTI0Y2ItNDRjOC04YzEwLTI1NmIzNGY4ZGZjYyIsImNsaWVudF9pZCI6ImMxIn0.-9SKI-qUqKhKcs8Gb80Rascx-JxqsNZxxXoPo82d8SM&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;token_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;bearer&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;refresh_token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJhdGkiOiJlOWQzZDBmZC0yNGNiLTQ0YzgtOGMxMC0yNTZiMzRmOGRmY2MiLCJleHAiOjE2NjQ1ODM2OTUsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImRjNTRjNTRkLTA0YTMtNDIzNS04MmY3LTFkOWZkMmFjM2VmNSIsImNsaWVudF9pZCI6ImMxIn0.Wsw1Jc-Kd_GFqEugzdfoSsMY6inC8OQsraA21WjWtT8&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;expires_in&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">7199</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;all&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;jti&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;e9d3d0fd-24cb-44c8-8c10-256b34f8dfcc&quot;</span> </span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span> </span><br></pre></td></tr></table></figure>\n<p>3ï¸âƒ£æˆ‘ä»¬å¯ä»¥é€šè¿‡ check_token æ¥å£æ ¡éªŒ jwt ä»¤ç‰Œ</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">###æ ¡éªŒjwtä»¤ç‰Œ </span><br><span class=\"line\">POST &#123;&#123;auth_host&#125;&#125;/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY2NDM3MTc4MCwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiZjBhM2NkZWItMzk5ZC00OGYwLTg4MDQtZWNhNjM4YWQ4ODU3IiwiY2xpZW50X2lkIjoiYzEifQ.qy46CSCJsH3eXWTHgdcntZhzcSzfRQlBU0dxAjZcsUw </span><br></pre></td></tr></table></figure>\n<p>éŸ¿æ‡‰ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> </span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;aud&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span> </span><br><span class=\"line\">    <span class=\"string\">&quot;res1&quot;</span> </span><br><span class=\"line\">  <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;user_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;zhangsan&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span> </span><br><span class=\"line\">    <span class=\"string\">&quot;all&quot;</span> </span><br><span class=\"line\">  <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;active&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;exp&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1664371780</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;authorities&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span> </span><br><span class=\"line\">    <span class=\"string\">&quot;p1&quot;</span> </span><br><span class=\"line\">  <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;jti&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;f0a3cdeb-399d-48f0-8804-eca638ad8857&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  <span class=\"attr\">&quot;client_id&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;c1&quot;</span> </span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span> </span><br></pre></td></tr></table></figure>\n<h2 id=\"ç¶²é—œèªè­‰\"><a class=\"markdownIt-Anchor\" href=\"#ç¶²é—œèªè­‰\">#</a> ç¶²é—œèªè­‰</h2>\n<img data-src=\"/John/img/java/SpringSecurity/10.png\" class=\"abc\">\n<p>ğŸŸ¡æ‰€æœ‰å­˜å–å¾®æœå‹™çš„è«‹æ±‚éƒ½è¦ç¶“éç¶²é—œï¼Œåœ¨ç¶²é—œé€²è¡Œä½¿ç”¨è€…èº«åˆ†çš„èªè­‰å¯ä»¥å°‡è¨±å¤šéæ³•çš„è«‹æ±‚æ””æˆªåˆ°å¾®æœå‹™ä»¥å¤–ï¼Œé€™å«åšç¶²é—œèªè­‰ã€‚</p>\n<p>ä¸‹é‚Šéœ€è¦æ˜ç¢ºç¶²é—œçš„è·è²¬ï¼š</p>\n<p>1ã€ç¶²ç«™ç™½åå–®ç¶­è­·ï¼šé‡å°ä¸ç”¨èªè­‰çš„ URL å…¨éƒ¨æ”¾è¡Œã€‚</p>\n<p>2ã€æ ¡é©— jwt çš„åˆæ³•æ€§ï¼šé™¤äº†ç™½åå–®å‰©ä¸‹çš„å°±æ˜¯éœ€è¦èªè­‰çš„è«‹æ±‚ï¼Œç¶²é—œéœ€è¦é©—è­‰ jwt çš„åˆæ³•æ€§ï¼Œjwt åˆæ³•å‰‡èªªæ˜ç”¨æˆ¶èº«ä»½åˆæ³•ï¼Œå¦å‰‡èªªæ˜èº«ä»½ä¸åˆæ³•å‰‡æ‹’çµ•ç¹¼çºŒè¨ªå•ã€‚</p>\n<p>ğŸŸ¡ç¶²é—œè² è²¬æˆæ¬Šå—ï¼Ÿ</p>\n<p>ç¶²é—œä¸è² è²¬æˆæ¬Šï¼Œå°è«‹æ±‚çš„æˆæ¬Šæ“ä½œåœ¨å„å€‹å¾®æœå‹™é€²è¡Œï¼Œå› ç‚ºå¾®æœå‹™æœ€æ¸…æ¥šä½¿ç”¨è€…æœ‰å“ªäº›æ¬Šé™å­˜å–å“ªäº›ä»‹é¢ã€‚</p>\n<h2 id=\"å¯¦ç¾ç¶²é—œèªè­‰\"><a class=\"markdownIt-Anchor\" href=\"#å¯¦ç¾ç¶²é—œèªè­‰\">#</a> å¯¦ç¾ç¶²é—œèªè­‰</h2>\n<p>ä¸‹é‚Šå¯¦ç¾ç¶²é—œèªè­‰ï¼Œå¯¦ç¾ä»¥ä¸‹è·è²¬ï¼š</p>\n<p>1ï¸âƒ£ç¶²ç«™ç™½åå–®ç¶­è­·</p>\n<p>é‡å°ä¸ç”¨èªè­‰çš„ URL å…¨éƒ¨æ”¾è¡Œã€‚</p>\n<p>2ï¸âƒ£æ ¡é©— jwt çš„åˆæ³•æ€§ã€‚</p>\n<p>é™¤äº†ç™½åå–®å‰©ä¸‹çš„å°±æ˜¯éœ€è¦èªè­‰çš„è«‹æ±‚ï¼Œç¶²é—œéœ€è¦é©—è­‰ jwt çš„åˆæ³•æ€§ï¼Œjwt åˆæ³•å‰‡èªªæ˜ç”¨æˆ¶èº«ä»½åˆæ³•ï¼Œå¦å‰‡èªªæ˜èº«ä»½ä¸åˆæ³•å‰‡æ‹’çµ•ç¹¼çºŒè¨ªå•ã€‚</p>\n<p>1ï¸âƒ£åœ¨ç¶²é—œå·¥ç¨‹æ·»åŠ ä¾è³´</p>\n<figure class=\"highlight xml\"><figcaption><span>XML</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-security<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.alibaba<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>fastjson<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£æ‹·è²èª²ç¨‹è³‡æ–™ä¸‹ç¶²é—œèªè­‰é…ç½®é¡åˆ¥åˆ°ç¶²é—œå·¥ç¨‹çš„ config åŒ…ä¸‹ã€‚</p>\n<p>3ï¸âƒ£è¨­å®šç™½åå–®æª” security-whitelist.properties</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/**=ä¸´æ—¶å…¨éƒ¨æ”¾è¡Œ </span><br><span class=\"line\">/auth/**=è®¤è¯åœ°å€ </span><br><span class=\"line\">/content/open/**=å†…å®¹ç®¡ç†å…¬å¼€è®¿é—®æ¥å£ </span><br><span class=\"line\">/media/open/**=åª’èµ„ç®¡ç†å…¬å¼€è®¿é—®æ¥å£ </span><br></pre></td></tr></table></figure>\n<p>é‡å•Ÿç¶²é—œå·¥ç¨‹ï¼Œé€²è¡Œæ¸¬è©¦<br>\n 1ã€ç”³è«‹ä»¤ç‰Œ<br>\n 2ã€é€éç¶²é—œå­˜å–è³‡æºæœå‹™<br>\né€™è£¡å­˜å–å…§å®¹ç®¡ç†æœå‹™</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### é€šè¿‡ç½‘å…³è®¿é—®èµ„æºæœåŠ¡ </span><br><span class=\"line\">GET http://localhost:63010/content/course/2 </span><br><span class=\"line\">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzNjIzMTAsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijc2OTkwMGNiLWM1ZjItNGRiNC1hZWJmLWY1MzgxZDQxZWMyZCIsImNsaWVudF9pZCI6ImMxIn0.lOITjUgYg2HCh5mDPK9EvJJqz-tIupKVfmP8yWJQIKs </span><br></pre></td></tr></table></figure>\n<p>ç¾åœ¨æˆ‘å€‘çš„ç¶²é—œä½œç”¨:1ï¸âƒ£è·¯ç”±è½‰ç™¼2ï¸âƒ£èªè­‰å’Œæ ¡é©— JWT ä»¤ç‰Œçš„åˆæ³•æ€§3ï¸âƒ£ç¶­è­·ä¸€ä»½ç™½åå–®</p>\n<h1 id=\"ç”¨æˆ·èªè­‰\"><a class=\"markdownIt-Anchor\" href=\"#ç”¨æˆ·èªè­‰\">#</a> ç”¨æˆ·èªè­‰</h1>\n<h2 id=\"é€£çµç”¨æˆ¶ä¸­å¿ƒè³‡æ–™åº«\"><a class=\"markdownIt-Anchor\" href=\"#é€£çµç”¨æˆ¶ä¸­å¿ƒè³‡æ–™åº«\">#</a> é€£çµç”¨æˆ¶ä¸­å¿ƒè³‡æ–™åº«</h2>\n<p>æˆ‘å€‘è¦åœ¨èªè­‰æœå‹™ä¸­é€£æ¥ç”¨æˆ¶ä¸­å¿ƒè³‡æ–™åº«æŸ¥è©¢ç”¨æˆ¶è³‡è¨Šã€‚</p>\n<p>å‰é‚Šå­¸ç¿’ Spring Security é‹ä½œåŸç†æ™‚æœ‰ä¸€å¼µåŸ·è¡Œæµç¨‹åœ–ï¼Œå¦‚ä¸‹åœ–ï¼š</p>\n<img data-src=\"/John/img/java/SpringSecurity/11.png\" class=\"abc\">\n<p>ä½¿ç”¨è€…æäº¤å¸³è™Ÿå’Œå¯†ç¢¼ç”± DaoAuthenticationProvider å‘¼å« UserDetailsService çš„ loadUserByUsername () æ–¹æ³•å–å¾— UserDetails ä½¿ç”¨è€…è³‡è¨Šã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">UserDetailsService</span> &#123; </span><br><span class=\"line\">    UserDetails <span class=\"title function_\">loadUserByUsername</span><span class=\"params\">(String var1)</span> <span class=\"keyword\">throws</span> UsernameNotFoundException; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>UserDetails æ˜¯ç”¨æˆ·ä¿¡æ¯æ¥å£</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">UserDetails</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Serializable</span> &#123; </span><br><span class=\"line\">    Collection&lt;? <span class=\"keyword\">extends</span> <span class=\"title class_\">GrantedAuthority</span>&gt; getAuthorities(); </span><br><span class=\"line\"> </span><br><span class=\"line\">    String <span class=\"title function_\">getPassword</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    String <span class=\"title function_\">getUsername</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isAccountNonExpired</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isAccountNonLocked</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isCredentialsNonExpired</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isEnabled</span><span class=\"params\">()</span>; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>æˆ‘å€‘åªè¦å¯¦ä½œ UserDetailsService ä»‹é¢æŸ¥è©¢è³‡æ–™åº«å¾—åˆ°ä½¿ç”¨è€…è³‡è¨Šå›å‚³ UserDetails é¡å‹çš„ä½¿ç”¨è€…è³‡è¨Šå³å¯</p>\n<p>é¦–å…ˆå±è”½åŸæ¥å®šä¹‰çš„ UserDetailsServiceã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">//é…ç½®ç”¨æˆ·ä¿¡æ¯æœåŠ¡ </span></span><br><span class=\"line\"><span class=\"comment\">//    @Bean </span></span><br><span class=\"line\"><span class=\"comment\">//    public UserDetailsService userDetailsService() &#123; </span></span><br><span class=\"line\"><span class=\"comment\">//        //è¿™é‡Œé…ç½®ç”¨æˆ·ä¿¡æ¯,è¿™é‡Œæš‚æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·å­˜å‚¨åœ¨å†…å­˜ä¸­ </span></span><br><span class=\"line\"><span class=\"comment\">//        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager(); </span></span><br><span class=\"line\"><span class=\"comment\">//        manager.createUser(User.withUsername(&quot;zhangsan&quot;).password(&quot;123&quot;).authorities(&quot;p1&quot;).build()); </span></span><br><span class=\"line\"><span class=\"comment\">//        manager.createUser(User.withUsername(&quot;lisi&quot;).password(&quot;456&quot;).authorities(&quot;p2&quot;).build()); </span></span><br><span class=\"line\"><span class=\"comment\">//        return manager; </span></span><br><span class=\"line\"><span class=\"comment\">//    &#125; </span></span><br></pre></td></tr></table></figure>\n<p>ä¸‹è¾¹è‡ªå®šä¹‰ UserDetailsService</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UserDetailsImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">UserDetailsService</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    XcUserMapper xcUserMapper;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> name     ç”¨æˆ·è¾“å…¥çš„ç™»å½•è´¦å·</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@return</span>         UserDetails</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@throws</span>         UsernameNotFoundException</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> UserDetails <span class=\"title function_\">loadUserByUsername</span><span class=\"params\">(String name)</span> <span class=\"keyword\">throws</span> UsernameNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"comment\">// æ²¡åˆ«çš„æ„æ€ï¼Œåªæ˜¯å˜é‡åçœ‹ç€èˆ’æœ</span></span><br><span class=\"line\">        <span class=\"comment\">// æ ¹æ®usernameå»XcUserè¡¨ä¸­æŸ¥è¯¢å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class=\"line\">        <span class=\"type\">XcUser</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> xcUserMapper.selectOne(<span class=\"keyword\">new</span> <span class=\"title class_\">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, name));</span><br><span class=\"line\">        <span class=\"comment\">// è¿”å›NULLè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨ï¼ŒSpringSecurityä¼šå¸®æˆ‘ä»¬å¤„ç†ï¼Œæ¡†æ¶æŠ›å‡ºå¼‚å¸¸ç”¨æˆ·ä¸å­˜åœ¨</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (user == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// å–å‡ºæ•°æ®åº“å­˜å‚¨çš„å¯†ç </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">password</span> <span class=\"operator\">=</span> user.getPassword();</span><br><span class=\"line\">        <span class=\"comment\">//å¦‚æœæŸ¥åˆ°äº†ç”¨æˆ·æ‹¿åˆ°æ­£ç¡®çš„å¯†ç ï¼Œæœ€ç»ˆå°è£…æˆä¸€ä¸ªUserDetailså¯¹è±¡ç»™spring securityæ¡†æ¶è¿”å›ï¼Œç”±æ¡†æ¶è¿›è¡Œå¯†ç æ¯”å¯¹</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> User.withUsername(user.getUsername()).password(password).authorities(<span class=\"string\">&quot;test&quot;</span>).build();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æŸ¥è©¢ç”¨æˆ¶æµç¨‹:</p>\n<img data-src=\"/John/img/java/SpringSecurity/12.png\" class=\"abc\">\n<p>è³‡æ–™åº«ä¸­çš„å¯†ç¢¼åŠ éå¯†çš„ï¼Œä½¿ç”¨è€…è¼¸å…¥çš„å¯†ç¢¼æ˜¯æ˜æ–‡ï¼Œæˆ‘å€‘éœ€è¦ä¿®æ”¹å¯†ç¢¼æ ¼å¼å™¨ PasswordEncoderï¼ŒåŸä¾†ä½¿ç”¨çš„æ˜¯ NoOpPasswordEncoderï¼Œå®ƒæ˜¯é€éæ˜æ–‡æ–¹å¼æ¯”è¼ƒå¯†ç¢¼ï¼Œç¾åœ¨æˆ‘å€‘ä¿®æ”¹ç‚º BCryptPasswordEncoderï¼Œå®ƒæ˜¯å°‡ä½¿ç”¨è€…è¼¸å…¥çš„ å¯†ç¢¼ç·¨ç¢¼ç‚º BCrypt æ ¼å¼èˆ‡è³‡æ–™åº«ä¸­çš„å¯†ç¢¼é€²è¡Œæ¯”å°ã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"meta\">@Bean</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> PasswordEncoder <span class=\"title function_\">passwordEncoder</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\"><span class=\"comment\">//        //å¯†ç ä¸ºæ˜æ–‡æ–¹å¼ </span></span><br><span class=\"line\"><span class=\"comment\">//        return NoOpPasswordEncoder.getInstance(); </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BCryptPasswordEncoder</span>(); </span><br><span class=\"line\">    &#125; </span><br></pre></td></tr></table></figure>\n<p>æˆ‘ä»¬é€šè¿‡æµ‹è¯•ä»£ç æµ‹è¯• BCryptPasswordEncoderï¼Œå¦‚ä¸‹</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123; </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">password</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;111111&quot;</span>; </span><br><span class=\"line\">    <span class=\"type\">PasswordEncoder</span> <span class=\"variable\">passwordEncoder</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BCryptPasswordEncoder</span>(); </span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">10</span>;i++) &#123; </span><br><span class=\"line\">        <span class=\"comment\">//æ¯ä¸ªè®¡ç®—å‡ºçš„Hashå€¼éƒ½ä¸ä¸€æ · </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">hashPass</span> <span class=\"operator\">=</span> passwordEncoder.encode(password); </span><br><span class=\"line\">        System.out.println(hashPass); </span><br><span class=\"line\">        <span class=\"comment\">//è™½ç„¶æ¯æ¬¡è®¡ç®—çš„å¯†ç Hashå€¼ä¸ä¸€æ ·ä½†æ˜¯æ ¡éªŒæ˜¯é€šè¿‡çš„ </span></span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">f</span> <span class=\"operator\">=</span> passwordEncoder.matches(password, hashPass); </span><br><span class=\"line\">        System.out.println(f); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>ä¿®æ”¹è³‡æ–™åº«ä¸­çš„å¯†ç¢¼ç‚º Bcrypt æ ¼å¼ï¼Œä¸¦ä¸”è¨˜éŒ„æ˜æ–‡å¯†ç¢¼ï¼Œç¨å¾Œç”³è«‹ä»¤ç‰Œæ™‚éœ€è¦ã€‚<br>\nç”±æ–¼ä¿®æ”¹å¯†ç¢¼ç·¨ç¢¼æ–¹å¼é‚„éœ€è¦å°‡å®¢æˆ¶ç«¯çš„é‡‘é‘°æ›´æ”¹ç‚º Bcrypt æ ¼å¼.</p>\n<figure class=\"highlight java\"><figcaption><span>Java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"meta\">@Override</span> </span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(ClientDetailsServiceConfigurer clients)</span> </span><br><span class=\"line\">          <span class=\"keyword\">throws</span> Exception &#123; </span><br><span class=\"line\">        clients.inMemory()<span class=\"comment\">// ä½¿ç”¨in-memoryå­˜å‚¨ </span></span><br><span class=\"line\">                .withClient(<span class=\"string\">&quot;XcWebApp&quot;</span>)<span class=\"comment\">// client_id </span></span><br><span class=\"line\"><span class=\"comment\">//                .secret(&quot;secret&quot;)//å®¢æˆ·ç«¯å¯†é’¥ </span></span><br><span class=\"line\">                .secret(<span class=\"keyword\">new</span> <span class=\"title class_\">BCryptPasswordEncoder</span>().encode(<span class=\"string\">&quot;XcWebApp&quot;</span>))<span class=\"comment\">//å®¢æˆ·ç«¯å¯†é’¥ </span></span><br><span class=\"line\">                .resourceIds(<span class=\"string\">&quot;xuecheng-plus&quot;</span>)<span class=\"comment\">//èµ„æºåˆ—è¡¨ </span></span><br><span class=\"line\">                .authorizedGrantTypes(<span class=\"string\">&quot;authorization_code&quot;</span>, <span class=\"string\">&quot;password&quot;</span>,<span class=\"string\">&quot;client_credentials&quot;</span>,<span class=\"string\">&quot;implicit&quot;</span>,<span class=\"string\">&quot;refresh_token&quot;</span>)<span class=\"comment\">// è¯¥clientå…è®¸çš„æˆæƒç±»å‹authorization_code,password,refresh_token,implicit,client_credentials </span></span><br><span class=\"line\">                .scopes(<span class=\"string\">&quot;all&quot;</span>)<span class=\"comment\">// å…è®¸çš„æˆæƒèŒƒå›´ </span></span><br><span class=\"line\">                .autoApprove(<span class=\"literal\">false</span>)<span class=\"comment\">//falseè·³è½¬åˆ°æˆæƒé¡µé¢ </span></span><br><span class=\"line\">                <span class=\"comment\">//å®¢æˆ·ç«¯æ¥æ”¶æˆæƒç çš„é‡å®šå‘åœ°å€ </span></span><br><span class=\"line\">                .redirectUris(<span class=\"string\">&quot;http://www.51xuecheng.cn&quot;</span>) </span><br><span class=\"line\">   ; </span><br><span class=\"line\">  &#125; </span><br></pre></td></tr></table></figure>\n<p>ç¾åœ¨é‡å•Ÿèªè­‰æœå‹™<br>\nä¸‹é‚Šä½¿ç”¨ httpclient æ¸¬è©¦ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### å¯†ç æ¨¡å¼ </span><br><span class=\"line\">POST &#123;&#123;auth_host&#125;&#125;/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=stu1&amp;password=<span class=\"number\">111111</span> </span><br></pre></td></tr></table></figure>\n<h3 id=\"æ“´å±•ç”¨æˆ¶èº«ä»½è³‡è¨Š\"><a class=\"markdownIt-Anchor\" href=\"#æ“´å±•ç”¨æˆ¶èº«ä»½è³‡è¨Š\">#</a> æ“´å±•ç”¨æˆ¶èº«ä»½è³‡è¨Š</h3>\n<p>ä½¿ç”¨è€…è¡¨ä¸­å„²å­˜äº†ä½¿ç”¨è€…çš„å¸³è™Ÿã€æ‰‹æ©Ÿè™Ÿç¢¼ã€emailï¼Œæš±ç¨±ã€é ­åƒç­‰è¨Šæ¯ï¼ŒUserDetails ä»‹é¢åªå›å‚³äº† usernameã€å¯†ç¢¼ç­‰è¨Šæ¯ï¼Œå¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>Java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">UserDetails</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Serializable</span> &#123; </span><br><span class=\"line\">    Collection&lt;? <span class=\"keyword\">extends</span> <span class=\"title class_\">GrantedAuthority</span>&gt; getAuthorities(); </span><br><span class=\"line\"> </span><br><span class=\"line\">    String <span class=\"title function_\">getPassword</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    String <span class=\"title function_\">getUsername</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isAccountNonExpired</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isAccountNonLocked</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isCredentialsNonExpired</span><span class=\"params\">()</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isEnabled</span><span class=\"params\">()</span>; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>æˆ‘å€‘éœ€è¦æ“´å±•ä½¿ç”¨è€…èº«åˆ†çš„è¨Šæ¯ï¼Œåœ¨ jwt ä»¤ç‰Œä¸­å„²å­˜ä½¿ç”¨è€…çš„æš±ç¨±ã€é ­åƒã€é›»éƒµç­‰è³‡è¨Šã€‚</p>\n<p>ğŸŸ¡å¦‚ä½•æ“´å±• Spring Security çš„ä½¿ç”¨è€…è­˜åˆ¥è³‡è¨Šå‘¢ï¼Ÿ</p>\n<p>åœ¨èªè­‰éšæ®µ DaoAuthenticationProvider æœƒå‘¼å« UserDetailService æŸ¥è©¢ä½¿ç”¨è€…çš„ä¿¡æ¯ï¼Œé€™è£¡æ˜¯å¯ä»¥ç²å–åˆ°é½Šå…¨çš„ä½¿ç”¨è€…è³‡è¨Šçš„ã€‚ ç”±æ–¼ JWT ä»¤ç‰Œä¸­ç”¨æˆ¶èº«ä»½è³‡è¨Šä¾†è‡ª UserDetailsï¼ŒUserDetails ä¸­åƒ…å®šç¾©äº† username ç‚ºç”¨æˆ¶çš„èº«ä»½ä¿¡æ¯ï¼Œé€™è£¡æœ‰å…©å€‹æ€è·¯ï¼šç¬¬ä¸€å€‹æ˜¯å¯ä»¥æ“´å±• UserDetailsï¼Œä½¿ä¹‹åŒ…æ‹¬æ›´å¤šçš„è‡ªå®šç¾©å±¬æ€§ï¼Œç¬¬äºŒä¹Ÿ å¯ä»¥æ“´å…… username çš„å…§å®¹ï¼Œä¾‹å¦‚å­˜å…¥ json è³‡æ–™å…§å®¹ä½œç‚º username çš„å…§å®¹ã€‚ ç›¸æ¯”è¼ƒè€Œè¨€ï¼Œæ–¹æ¡ˆäºŒæ¯”è¼ƒç°¡å–®é‚„ä¸ç”¨ç ´å£ UserDetails çš„çµæ§‹ï¼Œæˆ‘å€‘æ¡ç”¨æ–¹æ¡ˆäºŒã€‚<br>\nä¿®æ”¹ UserServiceImpl å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UserDetailsImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">UserDetailsService</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    XcUserMapper xcUserMapper;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> s     ç”¨æˆ·è¾“å…¥çš„ç™»å½•è´¦å·</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>      UserDetails</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> UsernameNotFoundException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> UserDetails <span class=\"title function_\">loadUserByUsername</span><span class=\"params\">(String s)</span> <span class=\"keyword\">throws</span> UsernameNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"comment\">// æ²¡åˆ«çš„æ„æ€ï¼Œåªæ˜¯å˜é‡åçœ‹ç€èˆ’æœ</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> s;</span><br><span class=\"line\">        <span class=\"comment\">// æ ¹æ®usernameå»XcUserè¡¨ä¸­æŸ¥è¯¢å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class=\"line\">        <span class=\"type\">XcUser</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> xcUserMapper.selectOne(<span class=\"keyword\">new</span> <span class=\"title class_\">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, name));</span><br><span class=\"line\">        <span class=\"comment\">// è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨ï¼ŒSpringSecurityä¼šå¸®æˆ‘ä»¬å¤„ç†</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (user == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// å–å‡ºæ•°æ®åº“å­˜å‚¨çš„å¯†ç </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">password</span> <span class=\"operator\">=</span> user.getPassword();</span><br><span class=\"line\">+       <span class=\"comment\">// ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ä¸è¦è®¾ç½®</span></span><br><span class=\"line\">+       user.setPassword(<span class=\"literal\">null</span>);</span><br><span class=\"line\">+       <span class=\"type\">String</span> <span class=\"variable\">userString</span> <span class=\"operator\">=</span> JSON.toJSONString(user);</span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»ºUserDetailså¯¹è±¡ï¼Œå¹¶è¿”å›ï¼Œæ³¨æ„è¿™é‡Œçš„authoritieså¿…é¡»æŒ‡å®š</span></span><br><span class=\"line\">-       <span class=\"keyword\">return</span> User.withUsername(user.getUsername()).password(password).authorities(<span class=\"string\">&quot;test&quot;</span>).build();</span><br><span class=\"line\">+       <span class=\"keyword\">return</span> User.withUsername(userString).password(password).authorities(<span class=\"string\">&quot;test&quot;</span>).build();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>é‡å¯è®¤è¯æœåŠ¡ï¼Œé‡æ–°ç”Ÿæˆä»¤ç‰Œï¼Œç”ŸæˆæˆåŠŸã€‚<br>\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ check_token æŸ¥è¯¢ jwt çš„å†…å®¹</p>\n<figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">###æ ¡éªŒjwtä»¤ç‰Œ </span><br><span class=\"line\">POST <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#123;</span>auth_host<span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span>/oauth/check_token?token= </span><br></pre></td></tr></table></figure>\n<p>user_name å„²å­˜äº†ä½¿ç”¨è€…è³‡è¨Šçš„ json æ ¼å¼ï¼Œåœ¨è³‡æºæœå‹™ä¸­å°±å¯ä»¥å–å‡ºè©² json æ ¼å¼çš„å…§å®¹è½‰ç‚ºä½¿ç”¨è€…ç‰©ä»¶å»ä½¿ç”¨ã€‚</p>\n<h3 id=\"è³‡æºæœå‹™å–å¾—ä½¿ç”¨è€…èº«ä»½\"><a class=\"markdownIt-Anchor\" href=\"#è³‡æºæœå‹™å–å¾—ä½¿ç”¨è€…èº«ä»½\">#</a> è³‡æºæœå‹™å–å¾—ä½¿ç”¨è€…èº«ä»½</h3>\n<p>ä¸‹é¢ç·¨å¯«ä¸€å€‹å·¥å…·é¡åˆ¥åœ¨å„å€‹å¾®æœå‹™ä¸­å»ä½¿ç”¨ï¼Œå–å¾—ç›®å‰ç™»å…¥ä½¿ç”¨è€…çš„ç‰©ä»¶ã€‚ åœ¨ content-api ä¸­å®šç¾©æ­¤é¡:</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SecurityUtil</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> XcUser <span class=\"title function_\">getUser</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">Object</span> <span class=\"variable\">principal</span> <span class=\"operator\">=</span> SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (principal <span class=\"keyword\">instanceof</span> String) &#123;</span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">userJson</span> <span class=\"operator\">=</span> principal.toString();</span><br><span class=\"line\">                <span class=\"type\">XcUser</span> <span class=\"variable\">xcUser</span> <span class=\"operator\">=</span> JSON.parseObject(userJson, XcUser.class);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> xcUser;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">&quot;è·å–å½“å‰ç™»å½•ç”¨æˆ·èº«ä»½ä¿¡æ¯å‡ºé”™ï¼š&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// è¿™é‡Œä½¿ç”¨å†…éƒ¨ç±»ï¼Œæ˜¯ä¸ºäº†ä¸è®©contentå·¥ç¨‹å»ä¾èµ–authå·¥ç¨‹</span></span><br><span class=\"line\">    <span class=\"meta\">@Data</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">XcUser</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Serializable</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">1L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String id;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String username;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String password;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String salt;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> String nickname;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> String wxUnionid;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> String companyId;</span><br><span class=\"line\">        <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">        * å¤´åƒ</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String userpic;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String utype;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> LocalDateTime birthday;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String sex;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String email;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String cellphone;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String qq;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">        * ç”¨æˆ·çŠ¶æ€</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> String status;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> LocalDateTime createTime;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> LocalDateTime updateTime;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸‹åœ¨å…§å®¹ç®¡ç†æœå‹™ä¸­æ¸¬è©¦æ­¤å·¥å…·é¡ï¼Œä»¥æŸ¥è©¢èª²ç¨‹è³‡è¨Šä»‹é¢ç‚ºä¾‹</p>\n<figure class=\"highlight json\"><figcaption><span>json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    @ApiOperation(<span class=\"string\">&quot;æ ¹æ®è¯¾ç¨‹idæŸ¥è¯¢è¯¾ç¨‹åŸºç¡€ä¿¡æ¯&quot;</span>)</span><br><span class=\"line\">    @GetMapping(<span class=\"string\">&quot;/course/&#123;courseId&#125;&quot;</span>)</span><br><span class=\"line\">    public CourseBaseInfoDto getCourseBaseById(@PathVariable Long courseId) <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">+       SecurityUtil.XcUser user = SecurityUtil.getUser();</span><br><span class=\"line\">-       Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class=\"line\">-       System.out.println(<span class=\"string\">&quot;å½“å‰ç”¨æˆ·èº«ä»½ä¸ºï¼š&quot;</span> + principal);</span><br><span class=\"line\">+       System.out.println(<span class=\"string\">&quot;å½“å‰ç”¨æˆ·èº«ä»½ä¸ºï¼š&quot;</span> + user);</span><br><span class=\"line\">        return courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>é‡å•Ÿå…§å®¹ç®¡ç†æœå‹™ï¼š<br>\n1ã€å•Ÿå‹•èªè­‰æœå‹™ã€ç¶²é—œã€å…§å®¹ç®¡ç†æœå‹™<br>\n 2ã€ç”¢ç”Ÿæ–°çš„ä»¤ç‰Œ<br>\n 3ã€æ”œå¸¶ä»¤ç‰Œå­˜å–å…§å®¹ç®¡ç†æœå‹™çš„æŸ¥è©¢èª²ç¨‹æ¥å£</p>\n<img data-src=\"/John/img/java/SpringSecurity/13.png\" class=\"abc\">\n<h1 id=\"æ”¯æ´èªè­‰æ–¹å¼å¤šæ¨£\"><a class=\"markdownIt-Anchor\" href=\"#æ”¯æ´èªè­‰æ–¹å¼å¤šæ¨£\">#</a> æ”¯æ´èªè­‰æ–¹å¼å¤šæ¨£</h1>\n<h2 id=\"çµ±ä¸€èªè­‰å…¥å£\"><a class=\"markdownIt-Anchor\" href=\"#çµ±ä¸€èªè­‰å…¥å£\">#</a> çµ±ä¸€èªè­‰å…¥å£</h2>\n<p>ğŸ‰ç›®å‰å„å¤§ç¶²ç«™çš„èªè­‰æ–¹å¼éå¸¸è±å¯Œï¼šå¸³è™Ÿå¯†ç¢¼èªè­‰ã€æ‰‹æ©Ÿé©—è­‰ç¢¼èªè­‰ã€æƒç¢¼ç™»å…¥ç­‰<br>\nğŸ‰åŸºæ–¼ç›®å‰ç ”ç©¶çš„ Spring Security èªè­‰æµç¨‹å¦‚ä½•æ”¯æ´å¤šæ¨£åŒ–çš„èªè­‰æ–¹æ¡ˆå‘¢ï¼Ÿ<br>\n1ï¸âƒ£æ”¯æ´å¸³è™Ÿå’Œå¯†ç¢¼èªè­‰ï¼šæ¡ç”¨ OAuth2 å”è­°çš„å¯†ç¢¼æ¨¡å¼å³å¯å¯¦ç¾<br>\n2ï¸âƒ£æ”¯æ´æ‰‹æ©Ÿè™ŸåŠ é©—è­‰ç¢¼èªè­‰ï¼šä½¿ç”¨è€…èªè­‰æäº¤çš„æ˜¯æ‰‹æ©Ÿè™Ÿç¢¼å’Œé©—è­‰ç¢¼ï¼Œä¸¦ä¸æ˜¯å¸³è™Ÿå’Œå¯†ç¢¼<br>\n3ï¸âƒ£å¾®ä¿¡æƒç¢¼èªè­‰ï¼šåŸºæ–¼ OAuth2 å”è­°èˆ‡å¾®ä¿¡äº¤äº’ï¼Œå­¸æˆåœ¨ç·šç¶²ç«™æœƒå‘å¾®ä¿¡ä¼ºæœå™¨ç”³è«‹ä¸€å€‹ä»¤ç‰Œï¼Œç„¶å¾Œæ”œå¸¶ä»¤ç‰Œå»å¾®ä¿¡æŸ¥è©¢ç”¨æˆ¶ä¿¡æ¯ï¼ŒæŸ¥è©¢æˆåŠŸå‰‡ç”¨æˆ¶åœ¨å­¸æˆåœ¨ç·šé …ç›®èªè­‰é€šé<br>\nğŸ‰ç›®å‰æˆ‘å€‘æ¸¬è©¦é€šé OAuth2 çš„å¯†ç¢¼æ¨¡å¼ï¼Œç”¨æˆ¶èªè­‰æœƒæäº¤å¸³è™Ÿå’Œå¯†ç¢¼ï¼Œç”± DaoAuthenticationProvider èª¿ç”¨ UserDetailsService çš„ loadUserByUsername () æ–¹æ³•ç²å– UserDetails ç”¨æˆ¶ä¿¡æ¯<br>\nğŸ‰åœ¨å‰é¢æˆ‘å€‘è‡ªè¨‚äº† UserDetailsService ä»‹é¢å¯¦ä½œé¡ï¼Œé€é loadUserByUsername () æ–¹æ³•æ ¹æ“šå¸³è™ŸæŸ¥è©¢ä½¿ç”¨è€…è³‡è¨Š<br>\nğŸ‰è€Œä¸åŒçš„èªè­‰æäº¤æ–¹å¼çš„æ•¸æ“šä¸ä¸€æ¨£ï¼Œä¾‹å¦‚<br>\næ‰‹æ©ŸåŠ é©—è­‰ç¢¼æ–¹å¼ï¼šæœƒæäº¤æ‰‹æ©Ÿè™Ÿç¢¼å’Œé©—è­‰ç¢¼<br>\nå¸³è™Ÿå¯†ç¢¼æ–¹å¼ï¼šæœƒæäº¤å¸³è™Ÿã€å¯†ç¢¼ã€é©—è­‰ç¢¼<br>\nğŸ‰æˆ‘å€‘å¯ä»¥åœ¨ loadUserByUsername () æ–¹æ³•ä¸Šåšæ–‡ç« ï¼Œå°‡ä½¿ç”¨è€…åŸä¾†æäº¤çš„å¸³è™Ÿæ•¸æ“šæ”¹ç‚ºæäº¤ä¸€å€‹ JSON æ•¸æ“šï¼ŒJSON æ•¸æ“šå¯ä»¥æ“´å±•ä¸åŒçš„èªè­‰æ–¹å¼æ‰€æäº¤çš„å„ç¨®åƒæ•¸<br>\nğŸ‰é¦–å…ˆå»ºç«‹ä¸€å€‹ DTO é¡åˆ¥ç”¨æ–¼æ¥æ”¶å„ç¨®èªè­‰åƒæ•¸</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AuthParamsDto</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String username; <span class=\"comment\">//ç”¨æˆ·å</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String password; <span class=\"comment\">//åŸŸ  ç”¨äºæ‰©å±•</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String cellphone;<span class=\"comment\">//æ‰‹æœºå·</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String checkcode;<span class=\"comment\">//éªŒè¯ç </span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String checkcodekey;<span class=\"comment\">//éªŒè¯ç key</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String authType; <span class=\"comment\">// è®¤è¯çš„ç±»å‹   password:ç”¨æˆ·åå¯†ç æ¨¡å¼ç±»å‹    sms:çŸ­ä¿¡æ¨¡å¼ç±»å‹</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, Object&gt; payload = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();<span class=\"comment\">//é™„åŠ æ•°æ®ï¼Œä½œä¸ºæ‰©å±•ï¼Œä¸åŒè®¤è¯ç±»å‹å¯æ‹¥æœ‰ä¸åŒçš„é™„åŠ æ•°æ®ã€‚å¦‚è®¤è¯ç±»å‹ä¸ºçŸ­ä¿¡æ—¶åŒ…å«smsKey : sms:3d21042d054548b08477142bbca95cfa; æ‰€æœ‰æƒ…å†µä¸‹éƒ½åŒ…å«clientId</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ­¤æ—¶ loadUserByUsername () æ–¹æ³•å¯ä»¥ä¿®æ”¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UserDetailsImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">UserDetailsService</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    XcUserMapper xcUserMapper;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> s ç”¨æˆ·è¾“å…¥çš„ç™»å½•è´¦å·</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> UserDetails</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> UsernameNotFoundException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> UserDetails <span class=\"title function_\">loadUserByUsername</span><span class=\"params\">(String s)</span> <span class=\"keyword\">throws</span> UsernameNotFoundException &#123;</span><br><span class=\"line\">+       <span class=\"type\">AuthParamsDto</span> <span class=\"variable\">authParamsDto</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">+       <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">+           authParamsDto = JSON.parseObject(s, AuthParamsDto.class);</span><br><span class=\"line\">+       &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">+           log.error(<span class=\"string\">&quot;è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹ï¼š&#123;&#125;&quot;</span>, s);</span><br><span class=\"line\">+           <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹&quot;</span>);</span><br><span class=\"line\">+       &#125;</span><br><span class=\"line\">-       <span class=\"comment\">// æ²¡åˆ«çš„æ„æ€ï¼Œåªæ˜¯å˜é‡åçœ‹ç€èˆ’æœ</span></span><br><span class=\"line\">-       <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> s;</span><br><span class=\"line\">+       <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> authParamsDto.getUsername();</span><br><span class=\"line\">        <span class=\"comment\">// æ ¹æ®usernameå»XcUserè¡¨ä¸­æŸ¥è¯¢å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class=\"line\">        <span class=\"type\">XcUser</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> xcUserMapper.selectOne(<span class=\"keyword\">new</span> <span class=\"title class_\">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, name));</span><br><span class=\"line\">        <span class=\"comment\">// è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨ï¼ŒSpringSecurityä¼šå¸®æˆ‘ä»¬å¤„ç†</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (user == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// å–å‡ºæ•°æ®åº“å­˜å‚¨çš„å¯†ç </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">password</span> <span class=\"operator\">=</span> user.getPassword();</span><br><span class=\"line\">        user.setPassword(<span class=\"literal\">null</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">userString</span> <span class=\"operator\">=</span> JSON.toJSONString(user);</span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»ºUserDetailså¯¹è±¡ï¼Œå¹¶è¿”å›ï¼Œæ³¨æ„è¿™é‡Œçš„authoritieså¿…é¡»æŒ‡å®š</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> User.withUsername(userString).password(password).authorities(<span class=\"string\">&quot;test&quot;</span>).build();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åŸä¾†çš„ DaoAuthenticationProvider æœƒé€²è¡Œå¯†ç¢¼æ ¡é©—ï¼Œç¾åœ¨é‡æ–°å®šç¾© DaoAuthenticationProviderCustom é¡ï¼Œé‡å¯«é¡åˆ¥çš„ additionalAuthenticationChecks æ–¹æ³•ã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span> </span><br><span class=\"line\"><span class=\"meta\">@Component</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DaoAuthenticationProviderCustom</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">DaoAuthenticationProvider</span> &#123; </span><br><span class=\"line\"> <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\"> <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setUserDetailsService</span><span class=\"params\">(UserDetailsService userDetailsService)</span> &#123; </span><br><span class=\"line\">  <span class=\"built_in\">super</span>.setUserDetailsService(userDetailsService); </span><br><span class=\"line\"> &#125; </span><br><span class=\"line\"> <span class=\"comment\">//å±è”½å¯†ç å¯¹æ¯” </span></span><br><span class=\"line\"> <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">additionalAuthenticationChecks</span><span class=\"params\">(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication)</span> <span class=\"keyword\">throws</span> AuthenticationException &#123; </span><br><span class=\"line\"></span><br><span class=\"line\"> &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¿®æ”¹ WebSecurityConfig ç±»æŒ‡å®š daoAuthenticationProviderCustom</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">DaoAuthenticationProviderCustom daoAuthenticationProviderCustom; </span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\">@Override</span> </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(AuthenticationManagerBuilder auth)</span> <span class=\"keyword\">throws</span> Exception &#123; </span><br><span class=\"line\">    auth.authenticationProvider(daoAuthenticationProviderCustom); </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>åŸä¾†çš„ DaoAuthenticationProvider æœƒé€²è¡Œå¯†ç¢¼æ ¡é©—ï¼Œç¾åœ¨é‡æ–°å®šç¾© DaoAuthenticationProviderCustom é¡ï¼Œé‡å¯«é¡åˆ¥çš„ additionalAuthenticationChecks æ–¹æ³•ã€‚</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">################æ‰©å±•è®¤è¯è¯·æ±‚å‚æ•°å###################### </span><br><span class=\"line\">###å¯†ç æ¨¡å¼ </span><br><span class=\"line\">POST &#123;&#123;auth_host&#125;&#125;/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=&#123;&quot;username&quot;:&quot;stu1&quot;,&quot;authType&quot;:&quot;password&quot;,&quot;password&quot;:&quot;111111&quot;&#125; </span><br></pre></td></tr></table></figure>\n<p>ç¶“éæ¸¬è©¦ç™¼ç¾ loadUserByUsername () æ–¹æ³•å¯ä»¥æ­£å¸¸æ¥æ”¶åˆ°èªè­‰è«‹æ±‚ä¸­çš„ json è³‡æ–™ã€‚<br>\næœ‰äº†é€™äº›èªè­‰åƒæ•¸æˆ‘å€‘å¯ä»¥å®šç¾©ä¸€å€‹èªè­‰ Service ä»‹é¢å»é€²è¡Œå„ç¨®æ–¹å¼çš„èªè­‰ã€‚<br>\nå®šç¾©ä½¿ç”¨è€…è¨Šæ¯ï¼Œç‚ºäº†æ“´å±•æ€§è®“å®ƒç¹¼æ‰¿ XcUser</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Data</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">XcUserExt</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">XcUser</span> &#123; </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>å®šä¹‰è®¤è¯ Service æ¥å£</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">AuthService</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@description</span> è®¤è¯æ–¹æ³• </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> authParamsDto è®¤è¯å‚æ•° </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@return</span> com.xuecheng.ucenter.model.po.XcUser ç”¨æˆ·ä¿¡æ¯ </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@author</span> Mr.M </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@date</span> 2022/9/29 12:11 </span></span><br><span class=\"line\"><span class=\"comment\">   */</span> </span><br><span class=\"line\">   XcUserExt <span class=\"title function_\">execute</span><span class=\"params\">(AuthParamsDto authParamsDto)</span>; </span><br><span class=\"line\"> </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>loadUserByUsername () ä¿®æ”¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span> </span><br><span class=\"line\"><span class=\"meta\">@Service</span> </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UserServiceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">UserDetailsService</span> &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">    XcUserMapper xcUserMapper; </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span> </span><br><span class=\"line\">    ApplicationContext applicationContext; </span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@description</span> æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ç»„æˆç”¨æˆ·èº«ä»½ä¿¡æ¯ </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> s  AuthParamsDtoç±»å‹çš„jsonæ•°æ® </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> org.springframework.security.core.userdetails.UserDetails </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> Mr.M </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@date</span> 2022/9/28 18:30 </span></span><br><span class=\"line\"><span class=\"comment\">    */</span> </span><br><span class=\"line\">    <span class=\"meta\">@Override</span> </span><br><span class=\"line\">    <span class=\"keyword\">public</span> UserDetails <span class=\"title function_\">loadUserByUsername</span><span class=\"params\">(String s)</span> <span class=\"keyword\">throws</span> UsernameNotFoundException &#123; </span><br><span class=\"line\"> </span><br><span class=\"line\">        <span class=\"type\">AuthParamsDto</span> <span class=\"variable\">authParamsDto</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>; </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123; </span><br><span class=\"line\">            <span class=\"comment\">//å°†è®¤è¯å‚æ•°è½¬ä¸ºAuthParamsDtoç±»å‹ </span></span><br><span class=\"line\">            authParamsDto = JSON.parseObject(s, AuthParamsDto.class); </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123; </span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;è®¤è¯è¯·æ±‚ä¸ç¬¦åˆé¡¹ç›®è¦æ±‚:&#123;&#125;&quot;</span>,s); </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹&quot;</span>); </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">        <span class=\"comment\">//å¼€å§‹è®¤è¯ </span></span><br><span class=\"line\">        authService.execute(authParamsDto); </span><br><span class=\"line\">        ..... </span><br></pre></td></tr></table></figure>\n<h2 id=\"å¯¦ç¾å¸³è™Ÿå¯†ç¢¼èªè­‰\"><a class=\"markdownIt-Anchor\" href=\"#å¯¦ç¾å¸³è™Ÿå¯†ç¢¼èªè­‰\">#</a> å¯¦ç¾å¸³è™Ÿå¯†ç¢¼èªè­‰</h2>\n<p>ä¸Šç¯€å®šç¾©äº† AuthService èªè­‰æ¥å£ï¼Œç”¨ç­–ç•¥æ¨¡å¼å¯¦ä½œæ­¤æ¥å£å¯¦ä½œå¸³è™Ÿå¯†ç¢¼èªè­‰å’Œå¾®ä¿¡æƒç¢¼æ–¹å¼ï¼Œ</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service(&quot;password_authservice&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">PasswordAuthServiceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AuthService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> XcUserExt <span class=\"title function_\">execute</span><span class=\"params\">(AuthParamsDto authParamsDto)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service(&quot;wx_authservice&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">WxAuthServiceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AuthService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> XcUserExt <span class=\"title function_\">execute</span><span class=\"params\">(AuthParamsDto authParamsDto)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¿®æ”¹ UserServiceImpl é¡ï¼Œä¾ç…§èªè­‰æ–¹å¼ä½¿ç”¨ä¸åŒçš„èªè­‰ bean</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> UserDetails <span class=\"title function_\">loadUserByUsername</span><span class=\"params\">(String s)</span> <span class=\"keyword\">throws</span> UsernameNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"type\">AuthParamsDto</span> <span class=\"variable\">authParamsDto</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">&quot;è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹ï¼š&#123;&#125;&quot;</span>, s);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">+       <span class=\"comment\">// è·å–è®¤è¯ç±»å‹ï¼ŒbeanNameå°±æ˜¯ è®¤è¯ç±»å‹ + åç¼€ï¼Œä¾‹å¦‚ password + _authservice = password_authservice</span></span><br><span class=\"line\">+       <span class=\"type\">String</span> <span class=\"variable\">authType</span> <span class=\"operator\">=</span> authParamsDto.getAuthType();</span><br><span class=\"line\">+       <span class=\"comment\">// æ ¹æ®è®¤è¯ç±»å‹ï¼Œä»Springå®¹å™¨ä¸­å–å‡ºå¯¹åº”çš„bean</span></span><br><span class=\"line\">+       <span class=\"type\">AuthService</span> <span class=\"variable\">authService</span> <span class=\"operator\">=</span> applicationContext.getBean(authType + <span class=\"string\">&quot;_authservice&quot;</span>, AuthService.class);</span><br><span class=\"line\">+       <span class=\"type\">XcUserExt</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> authService.execute(authParamsDto);</span><br><span class=\"line\">-       <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> authParamsDto.getUsername();</span><br><span class=\"line\">-       <span class=\"comment\">// æ ¹æ®usernameå»XcUserè¡¨ä¸­æŸ¥è¯¢å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class=\"line\">-       <span class=\"type\">XcUser</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> xcUserMapper.selectOne(<span class=\"keyword\">new</span> <span class=\"title class_\">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, name));</span><br><span class=\"line\">        <span class=\"comment\">// è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨ï¼ŒSpringSecurityä¼šå¸®æˆ‘ä»¬å¤„ç†</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (user == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// å–å‡ºæ•°æ®åº“å­˜å‚¨çš„å¯†ç </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">password</span> <span class=\"operator\">=</span> user.getPassword();</span><br><span class=\"line\">        user.setPassword(<span class=\"literal\">null</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">userString</span> <span class=\"operator\">=</span> JSON.toJSONString(user);</span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»ºUserDetailså¯¹è±¡ï¼Œå¹¶è¿”å›ï¼Œæ³¨æ„è¿™é‡Œçš„authoritieså¿…é¡»æŒ‡å®š</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> User.withUsername(userString).password(password).authorities(<span class=\"string\">&quot;test&quot;</span>).build();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>ä¸Šé¢æˆ‘ä»¬åªæ˜¯ç®€å•å®šä¹‰äº†è´¦å·å¯†ç è®¤è¯çš„å®ç°ç±»ï¼Œå¹¶æ²¡æœ‰ç¼–å†™å…·ä½“é€»è¾‘ï¼Œé‚£è¿™ä¸ªå°èŠ‚æˆ‘ä»¬å°±æ¥å…·ä½“å®ç°è´¦å·å¯†ç è®¤è¯</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service(&quot;password_authservice&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">PasswordAuthServiceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AuthService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    XcUserMapper xcUserMapper;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    PasswordEncoder passwordEncoder;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> XcUserExt <span class=\"title function_\">execute</span><span class=\"params\">(AuthParamsDto authParamsDto)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 1. è·å–è´¦å·</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">username</span> <span class=\"operator\">=</span> authParamsDto.getUsername();</span><br><span class=\"line\">        <span class=\"comment\">// 2. æ ¹æ®è´¦å·å»æ•°æ®åº“ä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨</span></span><br><span class=\"line\">        <span class=\"type\">XcUser</span> <span class=\"variable\">xcUser</span> <span class=\"operator\">=</span> xcUserMapper.selectOne(<span class=\"keyword\">new</span> <span class=\"title class_\">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));</span><br><span class=\"line\">        <span class=\"comment\">// 3. ä¸å­˜åœ¨æŠ›å¼‚å¸¸</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (xcUser == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è´¦å·ä¸å­˜åœ¨&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 4. æ ¡éªŒå¯†ç </span></span><br><span class=\"line\">        <span class=\"comment\">// 4.1 è·å–ç”¨æˆ·è¾“å…¥çš„å¯†ç </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">passwordForm</span> <span class=\"operator\">=</span> authParamsDto.getPassword();</span><br><span class=\"line\">        <span class=\"comment\">// 4.2 è·å–æ•°æ®åº“ä¸­å­˜å‚¨çš„å¯†ç </span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">passwordDb</span> <span class=\"operator\">=</span> xcUser.getPassword();</span><br><span class=\"line\">        <span class=\"comment\">// 4.3 æ¯”è¾ƒå¯†ç </span></span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">matches</span> <span class=\"operator\">=</span> passwordEncoder.matches(passwordForm, passwordDb);</span><br><span class=\"line\">        <span class=\"comment\">// 4.4 ä¸åŒ¹é…ï¼ŒæŠ›å¼‚å¸¸</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!matches) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 4.5 åŒ¹é…ï¼Œå°è£…è¿”å›</span></span><br><span class=\"line\">        <span class=\"type\">XcUserExt</span> <span class=\"variable\">xcUserExt</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">XcUserExt</span>();</span><br><span class=\"line\">        BeanUtils.copyProperties(xcUser, xcUserExt);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> xcUserExt;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¿®æ”¹ loadUserByUsername () æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å°†æœ€åçš„å°è£… UserDetails çš„ç›¸å…³ä»£ç æŠ½å–ä¸ºä¸€ä¸ªæ–¹æ³•</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> UserDetails <span class=\"title function_\">loadUserByUsername</span><span class=\"params\">(String s)</span> <span class=\"keyword\">throws</span> UsernameNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"type\">AuthParamsDto</span> <span class=\"variable\">authParamsDto</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">&quot;è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹ï¼š&#123;&#125;&quot;</span>, s);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// è·å–è®¤è¯ç±»å‹ï¼ŒbeanNameå°±æ˜¯ è®¤è¯ç±»å‹ + åç¼€ï¼Œä¾‹å¦‚ password + _authservice = password_authservice</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">authType</span> <span class=\"operator\">=</span> authParamsDto.getAuthType();</span><br><span class=\"line\">        <span class=\"comment\">// æ ¹æ®è®¤è¯ç±»å‹ï¼Œä»Springå®¹å™¨ä¸­å–å‡ºå¯¹åº”çš„bean</span></span><br><span class=\"line\">        <span class=\"type\">AuthService</span> <span class=\"variable\">authService</span> <span class=\"operator\">=</span> applicationContext.getBean(authType + <span class=\"string\">&quot;_authservice&quot;</span>, AuthService.class);</span><br><span class=\"line\">        <span class=\"type\">XcUserExt</span> <span class=\"variable\">user</span> <span class=\"operator\">=</span> authService.execute(authParamsDto);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getUserPrincipal(user);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">       <span class=\"keyword\">public</span> UserDetails <span class=\"title function_\">getUserPrincipal</span><span class=\"params\">(XcUserExt user)</span> &#123;</span><br><span class=\"line\">       String[] authorities = &#123;<span class=\"string\">&quot;test&quot;</span>&#125;;</span><br><span class=\"line\">       <span class=\"type\">String</span> <span class=\"variable\">password</span> <span class=\"operator\">=</span> user.getPassword();</span><br><span class=\"line\">       user.setPassword(<span class=\"literal\">null</span>);</span><br><span class=\"line\">       <span class=\"type\">String</span> <span class=\"variable\">userJsonStr</span> <span class=\"operator\">=</span> JSON.toJSONString(user);</span><br><span class=\"line\">       <span class=\"type\">UserDetails</span> <span class=\"variable\">userDetails</span> <span class=\"operator\">=</span> User.withUsername(userJsonStr).password(password).authorities(authorities).build();</span><br><span class=\"line\">       <span class=\"keyword\">return</span> userDetails;</span><br><span class=\"line\">       &#125;</span><br></pre></td></tr></table></figure>\n<p>å¯¦ç¾å¸³è™Ÿå¯†ç¢¼èªè­‰ï¼Œç”³è«‹ä»¤ç‰Œï¼Œæ³¨æ„ JSON è³‡æ–™ä¸­è¦å¸¶ä¸Š authType</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">###### å¯†ç æ¨¡å¼</span><br><span class=\"line\">POST localhost:<span class=\"number\">53070</span>/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=&#123;<span class=\"string\">&quot;username&quot;</span>:<span class=\"string\">&quot;Kyle&quot;</span>,<span class=\"string\">&quot;password&quot;</span>:<span class=\"string\">&quot;111111&quot;</span>,<span class=\"string\">&quot;authType&quot;</span>:<span class=\"string\">&quot;password&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<p><span class=\"green\">ä¸‹ç¯‡:</span><a href=\"/John/2023/11/03/java/SpringSecurity/WeChat_login\">é©—è­‰ç¢¼å’Œå¾®ä¿¡ç™»éŒ„</a></p>\n<img data-src=\"https://s1.aigei.com/src/img/jpg/76/766f945a88ff4bafa8aa409d5bedb642.jpg?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/&e=1735488000&token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:PlOHtwQdZo0HyFUYu3_jASLjruk=\" class=\"abc\" width=\"250\" height=\"200\">",
            "tags": [
                "SpringSecurity"
            ]
        },
        {
            "id": "https://superrjohn.github.io/John/2023/10/27/java/springMVC/UserBook-Web",
            "url": "https://superrjohn.github.io/John/2023/10/27/java/springMVC/UserBook-Web",
            "title": "æ‰‹å¯«springMVC!",
            "date_published": "2023-10-27T09:24:46.659Z",
            "content_html": "<h2 id=\"å‰è¨€\"><a class=\"markdownIt-Anchor\" href=\"#å‰è¨€\">#</a> å‰è¨€</h2>\n<p>åˆå­¸éšæ®µå…¨ç«¯çš„ä¸€å€‹é …ç›®ï¼Œæ˜¯ä¸€å€‹ç°¡å–®çš„ç”¨æˆ¶ç«¯åœ–æ›¸ç®¡ç†ç³»çµ±ï¼Œç™»éŒ„ç”¨ jwt ä»¤ç‰Œå¯¦ç¾ã€‚<br>\nå‰ç«¯æ˜¯ç”¨ Vue2ã€Pinia åšç‹€æ…‹ç®¡ç†ã€bootstrap 5 (ä¸æ¨è–¦)ã€Axiosã€‚<br>\nå¾Œç«¯ç”¨ SpringMVCã€SpringBootã€Mybatisã€MySQLã€‚<br>\næ–¼ç”±å°±æ˜¯ä¸€å€‹å¾ˆä¹…ä¹‹å‰çš„é …ç›®ï¼Œè€Œä¸”é …ç›®çµæ§‹å¾ˆç°¡å–®åªæ˜¯ç·´ç·´æ‰‹ï¼Œç¾åœ¨åªæ˜¯è£œå¯«ä¸€å€‹è¨˜éŒ„ï¼Œæ‰€ä»¥æˆ‘å°±ä¸æ¯å€‹æ­¥é©Ÿè¨˜éŒ„ï¼Œåªè¨˜éŒ„é‡é»ï½<br>\n é …ç›®åœ°å€:<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3N1cGVycmpvaG4vVXNlckJvb2stV2Vi\">https://github.com/superrjohn/UserBook-Web</span></p>\n<h2 id=\"é‚è¼¯åœ–\"><a class=\"markdownIt-Anchor\" href=\"#é‚è¼¯åœ–\">#</a> é‚è¼¯åœ–</h2>\n<p>åšé …ç›®ã€æ¨¡å¡Šã€æ¥­å‹™åŠŸèƒ½ä¸€å®šè¦å…ˆå¯«é‚è¼¯åœ–ï¼Œä¸€ä¾†ç†æ¸…é‚è¼¯æ­¥é©Ÿï¼ŒäºŒä¾†è·Ÿè‘—æ­¥é©Ÿåšé–‹ç™¼ã€‚(é›–ç„¶é€™åœ–å¯«å¾—ä¸å¤ªå„ª)</p>\n<img data-src=\"/John/img/java/springMVC/logic_diagram.png\" class=\"abc\" width=\"400\" height=\"700\">\n<h2 id=\"å‰ç«¯\"><a class=\"markdownIt-Anchor\" href=\"#å‰ç«¯\">#</a> å‰ç«¯</h2>\n<p>å‰ç«¯æ–¹é¢ï¼Œæˆ‘æƒ³è¨˜éŒ„çš„æ˜¯<span class=\"exturl\" data-url=\"aHR0cHM6Ly9waW5pYS52dWVqcy5vcmcvemgvaW50cm9kdWN0aW9uLmh0bWw=\"> Pinia</span> ç‹€æ…‹ç®¡ç†åº«ï¼Œæœƒä»¥ Vue2 åšç°¡å–®èªªæ˜ã€‚<br>\n1ï¸âƒ£å‰µä¸€å€‹ Pinia å¯¦ä¾‹å¹¶æ›è¼‰åˆ° Vue, å¦‚æœæ˜¯ Vue 2 é‚„éœ€è¦å®‰è£…ä¸€ä¸ªæ’ä»¶ PiniaVuePlugin, å¦‚æœæƒ³æ“æœ‰æŒä¹…åŒ–ï¼Œéœ€è¦å®‰è£ pinia-plugin-persistedstate æ’ä»¶ã€‚</p>\n<img data-src=\"/John/img/java/springMVC/create_pinia.png\" class=\"abc\" width=\"600\" height=\"500\">\n<p>2ï¸âƒ£Store å¯ä»¥ç†è§£æˆè¦ç‹€æ…‹ç®¡ç†çš„å°è±¡ï¼Œå®ƒæœ‰ä¸‰å€‹é‡è¦çš„éƒ¨ä»½çµ„æˆï¼Œåˆ†åˆ¥æ˜¯ stateã€getter å’Œ action, æœ¬é …ç›®åªç”¨åˆ° stateã€action,state æ˜¯å±¬æ€§ï¼Œè€Œ action æ˜¯æ”¹è®Šå±¬æ€§çš„æ–¹æ³•ï¼Œæˆ‘å°è£äº†æ ¹æ“šç”¨æˆ¶ ID ç™¼èµ·æŸ¥è©¢å€Ÿæ›¸è¨˜éŒ„çš„ API, è€Œ persist ç‚º true é–‹å•ŸæŒä¹…åŒ–ã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>useBookStatus.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; defineStore &#125; from <span class=\"string\">&#x27;pinia&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; userAPI &#125; from <span class=\"string\">&#x27;@/apis/user&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//å€‹äººå€Ÿæ›¸è¨˜éŒ„</span></span><br><span class=\"line\">export <span class=\"type\">const</span> <span class=\"variable\">useBookStatus</span> <span class=\"operator\">=</span> defineStore(<span class=\"string\">&#x27;bookStatus&#x27;</span>, &#123;</span><br><span class=\"line\">    state: () =&gt; (&#123;</span><br><span class=\"line\">        bookStatus: []</span><br><span class=\"line\">    &#125;),</span><br><span class=\"line\">    actions: &#123;</span><br><span class=\"line\">        async <span class=\"title function_\">getBookStatus</span><span class=\"params\">(id)</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">const</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> await <span class=\"title function_\">userAPI</span><span class=\"params\">(id)</span></span><br><span class=\"line\">            <span class=\"built_in\">this</span>.bookStatus = res.data.data</span><br><span class=\"line\">            <span class=\"comment\">//console.log(this.bookStatus)</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        clearBookStatus() &#123;</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.bookStatus = []</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    persist: <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>3ï¸âƒ£å€‹äººé çš„ JS å¤§æ¦‚é•·é€™æ¨£ï¼Œç”¨ mapActions () è¼”åŠ©å‡½æ•¸å°‡ action å±¬æ€§æ˜ å°„åˆ°ç»„ä»¶ä¸­ï¼Œç„¶å¾Œç•¶é é¢åŠ è¼‰å¾Œæ ¹æ“š id åŸ·è¡Œ getBookStatus æ–¹æ³•ï¼ŒæŸ¥è©¢å€‹äººçš„å€Ÿæ›¸è¨˜éŒ„</p>\n<img data-src=\"/John/img/java/springMVC/status_action.png\" class=\"abc\" width=\"600\" height=\"500\">\n<h2 id=\"å¾Œç«¯\"><a class=\"markdownIt-Anchor\" href=\"#å¾Œç«¯\">#</a> å¾Œç«¯</h2>\n<p>é …ç›®çµæ§‹ç°¡å–®ï¼Œä¸»è¦æ˜¯çˆ¶å·¥ç¨‹ï¼ŒPO é¡ï¼Œå·¥å…·é¡åªæœ‰ç”Ÿæˆå’Œè§£æ jwt ä»¤ç‰Œï¼Œä¸»è¦æ¥­å‹™é‚è¼¯å¯«åœ¨ boot-web-management</p>\n<img data-src=\"/John/img/java/springMVC/boot-web-management.png\" class=\"abc\" width=\"300\" height=\"250\">\n<p>1ï¸âƒ£é¦–å…ˆæ˜¯ç™»éŒ„åŠŸèƒ½ï¼ŒæŸ¥è©¢ç”¨æˆ¶è¡¨ï¼Œå¦‚æœç”¨æˆ¶å­˜åœ¨å‰›ç²å¾—ç”¨æˆ¶å°è±¡å¾Œç”Ÿæˆ jwt ä»¤ç‰Œè¿”å›å‰ç«¯ï¼Œæ²’æœ‰å‰‡è¿”å›ç™»éŒ„å¤±æ•—ä¿¡æ¯çµ¦å‰ç«¯</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">LoginController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> UserService userService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@PostMapping(&quot;/login&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Result <span class=\"title function_\">login</span><span class=\"params\">(<span class=\"meta\">@RequestBody</span> User user)</span> &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;ç”¨æˆ¶ç™»éŒ„:&#123;&#125;&quot;</span>,user);</span><br><span class=\"line\">        <span class=\"type\">User</span> <span class=\"variable\">u</span> <span class=\"operator\">=</span> userService.login(user);</span><br><span class=\"line\">        <span class=\"comment\">//ç”¨æˆ¶ç™»éŒ„æˆåŠŸ</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(u != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            Map&lt;String, Object&gt; claims = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">            claims.put(<span class=\"string\">&quot;id&quot;</span>, u.getId());</span><br><span class=\"line\">            claims.put(<span class=\"string\">&quot;username&quot;</span>, u.getUsername());</span><br><span class=\"line\">            claims.put(<span class=\"string\">&quot;name&quot;</span>, u.getName());</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">jwt</span> <span class=\"operator\">=</span> JwtUtils.generateJwt(claims);<span class=\"comment\">//ç”Ÿæˆtokenä»¤ç‰Œ</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> Result.success(jwt);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//ç™»éŒ„å¤±æ•—</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> Result.error(<span class=\"string\">&quot;å¯†ç¢¼å¸³è™Ÿæœ‰éŒ¯&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2ï¸âƒ£ä¹‹å¾Œéƒ½æ˜¯å°ç”¨æˆ¶çš„å€Ÿæ›¸ç‹€æ…‹å’Œåœ–æ›¸ç‹€æ…‹çš„å¢åˆªæ”¹æŸ¥ï¼Œä½¿ç”¨äº† interceptor æŸ¥è©¢ä»¤ç‰Œï¼Œæ²’æœ‰å‰‡æ””æˆªï¼Œé‚„æœ‰å…¨å±€ç•°å¸¸é…ç½®ç­‰ï¼Œæ²’ä»€éº¼ç‰¹åˆ¥ï¼Œå€¼å¾—èªªçš„æ˜¯æˆ‘ç”¨äº† Spring AOP, è‡ªå®šç¾©è¨»è§£ä¾†å°é‡è¦çš„æ“ä½œé€²è¡Œé¡å¤–çš„æ—¥èªŒè¨˜éŒ„ã€‚<br>\né¦–å…ˆè¦å‰µä¸€å€‹è‡ªå®šç¾©è¨»è§£ï¼Œèªªæ˜åœ¨å“ªæ–¹æ³•ä¸Šé‹è¡Œ</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//è‡ªå®šç¾©è¨»è§£,è¨˜éŒ„ä¿®æ”¹ç”¨æˆ¶ä¿®æ”¹æ—¥èªŒ</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span> <span class=\"comment\">//é‹è¡Œæ™‚ç”Ÿæ•ˆ</span></span><br><span class=\"line\"><span class=\"meta\">@Target(ElementType.METHOD)</span><span class=\"comment\">//è¨»æ˜æ–¹æ³•ä¸Šç”Ÿæ•ˆ</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> Log &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>é€™è£¡æˆ‘ä½¿ç”¨äº† @Around åšåˆ‡å…¥æ–¹æ³•ï¼Œå› ç‚ºæˆ‘éœ€è¦è¨˜éŒ„åŸå§‹æ–¹æ³•çš„é‹è¡Œæ™‚é–“ï¼Œannotation å‰‡ä»¥è‡ªå®šç¾©è¨»è§£ç‚ºåˆ‡é»ã€‚</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span><span class=\"comment\">//äº¤çµ¦IOCç®¡ç†</span></span><br><span class=\"line\"><span class=\"meta\">@Aspect</span><span class=\"comment\">//åˆ‡é¢é¡</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">LogAspect</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> HttpServletRequest request;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> OperateLogMapper operateLogMapper;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Around(&quot;@annotation(com.itheima.anno.Log)&quot;)</span><span class=\"comment\">//ä»¥è¨»è§£æ–¹å¼é…å‚™åˆ‡å…¥é»æ–¹æ³•</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">recordLog</span><span class=\"params\">(ProceedingJoinPoint joinPoint)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        <span class=\"comment\">//æ“ä½œäººID,ç•¶å‰ç™»éŒ„å“¡å·¥çš„ID,ç²æœ€è«‹æ±‚é ­çš„JWTä»¤ç‰Œ,è§£æä»¤ç‰Œ</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">jwt</span> <span class=\"operator\">=</span> request.getHeader(<span class=\"string\">&quot;token&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Claims</span> <span class=\"variable\">claims</span> <span class=\"operator\">=</span> JwtUtils.parseJWT(jwt);</span><br><span class=\"line\">        <span class=\"type\">Integer</span> <span class=\"variable\">operateUser</span> <span class=\"operator\">=</span> (Integer) claims.get(<span class=\"string\">&quot;id&quot;</span>);<span class=\"comment\">//Claimsé¡ç‚ºObject,æ‰€ä»¥è¦å¼·è½‰</span></span><br><span class=\"line\">        <span class=\"comment\">//æ“ä½œæ™‚é–“</span></span><br><span class=\"line\">        <span class=\"type\">LocalDateTime</span> <span class=\"variable\">operateTime</span> <span class=\"operator\">=</span> LocalDateTime.now();</span><br><span class=\"line\">        <span class=\"comment\">//æ“ä½œé¡å</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">className</span> <span class=\"operator\">=</span> joinPoint.getTarget().getClass().getName();</span><br><span class=\"line\">        <span class=\"comment\">//æ“ä½œæ–¹æ³•å</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">methodName</span> <span class=\"operator\">=</span> joinPoint.getSignature().getName();</span><br><span class=\"line\">        <span class=\"comment\">//æ“ä½œæ–¹æ³•åƒæ•¸</span></span><br><span class=\"line\">        Object[] args = joinPoint.getArgs();</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">methodParams</span> <span class=\"operator\">=</span> Arrays.toString(args);</span><br><span class=\"line\">        <span class=\"comment\">//é–‹å§‹èª¿ç”¨åŸå§‹æ–¹æ³•æ™‚é–“</span></span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">begin</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        <span class=\"comment\">//èª¿ç”¨åŸå§‹ç›®æ¨™æ–¹æ³•é‹è¡Œ</span></span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> joinPoint.proceed();</span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">end</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        <span class=\"comment\">//æ–¹æ³•è¿”å›å€¼</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">returnValue</span> <span class=\"operator\">=</span> JSONObject.toJSONString(result);</span><br><span class=\"line\">        <span class=\"comment\">//æ“ä½œæ™‚é–“</span></span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">costTime</span> <span class=\"operator\">=</span> end - begin;</span><br><span class=\"line\">        <span class=\"comment\">//è¨˜éŒ„æ“ä½œæ—¥å¿—</span></span><br><span class=\"line\">        <span class=\"type\">OperateLog</span> <span class=\"variable\">operateLog</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">OperateLog</span>(<span class=\"literal\">null</span>,operateUser,operateTime,className,methodName,methodParams,returnValue,costTime);</span><br><span class=\"line\">        operateLogMapper.insert(operateLog);</span><br><span class=\"line\"></span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;AOPè¨˜éŒ„æ—¥å¿—:&#123;&#125;&quot;</span>, operateLog);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ç„¶å¾Œåœ¨éœ€è¦çš„ API åŠ ä¸Šå°±å®Œæˆäº†</p>\n<figure class=\"highlight java\"><figcaption><span>java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Log</span></span><br><span class=\"line\">   <span class=\"comment\">//ä¿®æ”¹æ›¸æœ¬å‡ºå€Ÿç‹€æ…‹å’Œæ–°å¢ç”¨æˆ¶å€Ÿæ›¸è¨˜éŒ„</span></span><br><span class=\"line\">   <span class=\"meta\">@PutMapping</span></span><br><span class=\"line\">   <span class=\"keyword\">public</span> Result <span class=\"title function_\">updateStatus</span><span class=\"params\">(<span class=\"meta\">@RequestBody</span> UserBorrow userBorrow)</span>&#123;</span><br><span class=\"line\">       log.info(<span class=\"string\">&quot;å€Ÿå‡ºæ›¸æœ¬è³‡æ–™:&#123;&#125;&quot;</span>,userBorrow);</span><br><span class=\"line\">       bookService.updateStatus(userBorrow);</span><br><span class=\"line\">       <span class=\"keyword\">return</span> Result.success();</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3ï¸âƒ£æˆ‘å° AOP çš„ç†è§£æ˜¯ï¼Œå®ƒæ˜¯ä»¥å‹•æ…‹ä»£ç†çš„æ–¹å¼å»å¢å¼·åŠŸèƒ½ï¼Œè¡¨é”å¼å‰‡æ˜¯è¦åŠ å¼·çš„æ–¹æ³• (åˆ‡é»), åˆ‡å…¥æ–¹æ³•å‰‡æ˜¯ä»€éº¼æ™‚å€™åšåŠ å¼·ï¼Œæ˜¯ä»£ç¢¼åŸ·è¡Œå‰é‚„æ˜¯å¾Œï¼Œè¦ç†è§£æºç¢¼é‚„æ˜¯è »è¤‡é›œçš„ï¼Œå¹¸å¥½èƒ½ç†è§£ä¸¦ä½¿ç”¨ä¸é›£ï½</p>\n<img data-src=\"https://usagif.com/wp-content/uploads/gifs/thanks-for-watching-9.gif\" class=\"abc\" width=\"600\" height=\"350\">",
            "tags": [
                "SpringMVC",
                "Pinia",
                "Vue2",
                "SpringBoot"
            ]
        },
        {
            "id": "https://superrjohn.github.io/John/2023/10/26/java/rabbitmq/rabbitmq",
            "url": "https://superrjohn.github.io/John/2023/10/26/java/rabbitmq/rabbitmq",
            "title": "Hello RabbitMq!",
            "date_published": "2023-10-26T14:18:33.325Z",
            "content_html": "<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\">Hexo</span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\">documentation</span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\">troubleshooting</span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\">GitHub</span>.</p>\n<h2 id=\"quick-start\"><a class=\"markdownIt-Anchor\" href=\"#quick-start\">#</a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"markdownIt-Anchor\" href=\"#create-a-new-post\">#</a> Create a new post</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\">Writing</span></p>\n<h3 id=\"run-server\"><a class=\"markdownIt-Anchor\" href=\"#run-server\">#</a> Run server</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\">Server</span></p>\n<h3 id=\"generate-static-files\"><a class=\"markdownIt-Anchor\" href=\"#generate-static-files\">#</a> Generate static files</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\">Generating</span></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"markdownIt-Anchor\" href=\"#deploy-to-remote-sites\">#</a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudC5odG1s\">Deployment</span></p>\n",
            "tags": [
                "RabbitMQ"
            ]
        },
        {
            "id": "https://superrjohn.github.io/John/2023/10/26/java/radis/radis",
            "url": "https://superrjohn.github.io/John/2023/10/26/java/radis/radis",
            "title": "Hello Radis!",
            "date_published": "2023-10-26T14:15:36.096Z",
            "content_html": "<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\">Hexo</span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\">documentation</span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\">troubleshooting</span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\">GitHub</span>.</p>\n<h2 id=\"quick-start\"><a class=\"markdownIt-Anchor\" href=\"#quick-start\">#</a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"markdownIt-Anchor\" href=\"#create-a-new-post\">#</a> Create a new post</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\">Writing</span></p>\n<h3 id=\"run-server\"><a class=\"markdownIt-Anchor\" href=\"#run-server\">#</a> Run server</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\">Server</span></p>\n<h3 id=\"generate-static-files\"><a class=\"markdownIt-Anchor\" href=\"#generate-static-files\">#</a> Generate static files</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\">Generating</span></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"markdownIt-Anchor\" href=\"#deploy-to-remote-sites\">#</a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudC5odG1s\">Deployment</span></p>\n",
            "tags": [
                "Radis"
            ]
        },
        {
            "id": "https://superrjohn.github.io/John/2023/10/22/hexo/Hexo",
            "url": "https://superrjohn.github.io/John/2023/10/22/hexo/Hexo",
            "title": "Hexoå¿«é€Ÿéƒ¨ç½²!",
            "date_published": "2023-10-22T08:24:11.599Z",
            "content_html": "<h2 id=\"å‰è¨€\"><a class=\"markdownIt-Anchor\" href=\"#å‰è¨€\">#</a> å‰è¨€</h2>\n<p>æƒ³éƒ¨ç½²ä¸€å€‹è‡ªå·±çš„ç¶²ç«™çš„åŸå› ï¼Œæ˜¯å› ç‚ºæŸå¤©åœ¨å­¸ JAVA é …ç›®æ™‚é‡åˆ°å¾ˆå¤š BUG, å°±æ»‘è©•è«–å€æ‰¾è§£æ±ºæ–¹æ¡ˆï¼Œç„¶å¾Œè¢«æˆ‘æ‰¾åˆ°ä¸€å€‹å¤§ç¥ï¼Œä»–æŠŠå­¸ç¿’éç¨‹éƒ½æ”¾åœ¨è‡ªå·±çš„ç¶²ç«™ä¸Šï¼Œæˆ‘è¦ºå¾—å¾ˆé…·ï¼Œæ‰€ä»¥ä¹Ÿæ‰“ç®—æ•ˆä»¿ï½é‚£é€™ç¯‡ä¸»è¦æ˜¯è¨˜éŒ„ä¸€ä¸‹éƒ¨ç½²éç¨‹è¸©å‘çš„åœ°æ–¹ã€‚</p>\n<h2 id=\"hexoéƒ¨ç½²\"><a class=\"markdownIt-Anchor\" href=\"#hexoéƒ¨ç½²\">#</a> Hexo éƒ¨ç½²</h2>\n<p>1. é¦–å…ˆç…§è‘—å®˜æ–¹æ–‡æª”å®‰è£<span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3Mv\"> Hexo</span> å’Œæ‰€éœ€æ‡‰ç”¨<br>\n 2. å…¶å¯¦å®˜æ–¹æ–‡æª”èªªæ˜å¾—å¾ˆæ¸…æ¥šï¼Œç…§è‘—å®ƒèªªçš„éƒ¨ç½²åŸºæœ¬æ²’æœ‰å•é¡Œï¼Œæœ¬äººæ˜¯åˆ©ç”¨ Hexo å’Œ Github Pages éƒ¨ç½²çš„ã€‚<br>\n3. è¦æ³¨æ„çš„é»æ˜¯ source æ–‡ä»¶æœƒå­˜æ”¾æ‰€ä»¥æ–‡ç« ï¼Œæ‰€ä»¥å®ƒæ˜¯ç¶²åŸŸçš„çˆ¶è·¯ç”±ï¼Œå¦‚æœä½ æƒ³æ–°å¢å­è·¯ç”±ï¼Œéœ€è¦å‰µä¸€å€‹æ–‡ä»¶å¤¾ï¼Œä½ ç‚ºæ–‡ä»¶å¤¾èµ·çš„åå­—å°±æ˜¯ path äº†ï¼Œç„¶å¾Œå†å‰µä¸€å€‹ index.md çš„æª”æ¡ˆå°±å®Œæˆå•¦ï½</p>\n<h2 id=\"ä¸»é¡Œé…ç½®-é¦–é¡µç²¾é€‰ä¸åˆ†ç±»ç¿»è½¬å—\"><a class=\"markdownIt-Anchor\" href=\"#ä¸»é¡Œé…ç½®-é¦–é¡µç²¾é€‰ä¸åˆ†ç±»ç¿»è½¬å—\">#</a> ä¸»é¡Œé…ç½® - é¦–é¡µç²¾é€‰ä¸åˆ†ç±»ç¿»è½¬å—</h2>\n<p>1. æœ¬ç«™ä¸»é¡Œæ˜¯ç”¨ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmthaXRha3UueHl6L2d1aWRlLw==\">hexo-theme-shokaX</span> è«‹å…ˆä¸‹è¼‰ï¼Œæˆ‘æœƒä»¥é€™å€‹ä¸»é¡Œçš„é…ç½®åšè¨˜éŒ„ï¼Œä¸éåŸºæœ¬ä¸Šä¸»é¡Œçš„ä½¿ç”¨éƒ½å¤§åŒå°ç•°ã€‚<br>\n2 ä¿®æ”¹ç¶²ç«™é…ç½®ï¼Œåœ¨ Hexo æ ¹ç›®éŒ„ _config.yml ä¸­æ‰¾åˆ° category_mapï¼Œé…ç½®æ¯å€‹åˆ†é¡å°æ‡‰çš„è‹±æ–‡æ˜ å°„ã€‚<br>\nHexo å°æ–¼è·¯å¾‘ä¸­çš„ç‰¹æ®Šå­—å…ƒï½``!@#$%^&amp;*()-_+={}|;:&quot;'&lt;&gt;,.? ä»¥åŠç©ºæ ¼ï¼Œé€™äº›å…¨éƒ¨æœƒè¢«æ›¿æ›æˆ -</p>\n<blockquote><p>category_map:<br>\n è®¡ç®—æœºç§‘å­¦: computer-science<br>\nC++: cpp<br>\n éƒ‘è‰è€å¸ˆ C++ è¯­è¨€ç¨‹åºè®¾è®¡: course-1<br>\nLinux: Linux</p>\n</blockquote>\n<p>2.1ã€è¨­å®šæ–‡ç« æ‰€å±¬çš„ç›®éŒ„</p>\n<p>source/_posts ç‚ºä¸Šå‚³æ–‡ç« çš„å„²å­˜ç›®éŒ„ ã€‚</p>\n<p>categories çš„è¨­å®šè¦æ ¹æ“šä¸Šé¢çš„ category_map ä»¥åŠæ–‡ä»¶é †åºé †åºæ›¸å¯«ã€‚ ä¾‹å¦‚ï¼ŒæŸæ–‡ä»¶ä½æ–¼é›»è…¦ç§‘å­¸ / C++/ é„­è‰è€å¸« C++ èªè¨€ç¨‹å¼è¨­è¨ˆç›®éŒ„ä¸‹ï¼Œæ ¹æ“šä¸Šé¢çš„æ˜ å°„ï¼Œåœ¨å„²å­˜æª”æ¡ˆçš„_posts æª”æ¡ˆè·¯å¾‘ä¸‹å°±ä½æ–¼ source/_posts ä¸‹ computer-science/cpp/course-1 ç›®éŒ„ ä¸‹ã€‚</p>\n<figure class=\"highlight plaintext\"><figcaption><span>yml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">categories:</span><br><span class=\"line\">  - [è®¡ç®—æœºç§‘å­¦, C++, éƒ‘è‰è€å¸ˆC++è¯­è¨€ç¨‹åºè®¾è®¡]</span><br></pre></td></tr></table></figure>\n<img data-src=\"/John/img/hexo/categories.png\" class=\"abc\" width=\"350\" height=\"300\">\n<p>ä»¥ä¸Šæ˜¯å®˜æ–¹æ–‡æª”å…§å®¹</p>\n<h2 id=\"ä¸»é¡Œé…ç½®-è©•è«–å€\"><a class=\"markdownIt-Anchor\" href=\"#ä¸»é¡Œé…ç½®-è©•è«–å€\">#</a> ä¸»é¡Œé…ç½® - è©•è«–å€</h2>\n<p>ç…§è‘—å®˜æ–¹æ–‡æª”é…ç½®è©•è«–ç³»çµ±æœ€å¾Œçµæœæœƒæ˜¯ not initialized, åŸå› æˆ‘ä¹Ÿæ‰¾äº†å¾ˆä¹…ï¼Œçµ‚æ–¼è§£æ±ºäº†ï½æ‰€ä»¥è¨˜éŒ„ä¸‹<br>\n 1. é¦–å…ˆåœ¨é…ç½®æ ¹ç›®å½•ä¸‹ _config.shokaX.yml çš„è¯„è®ºç³»ç»Ÿï¼š</p>\n<figure class=\"highlight plaintext\"><figcaption><span>YML</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">waline:</span><br><span class=\"line\">  enable: true # æ˜¯å¦å¯ç”¨</span><br><span class=\"line\">  serverURL: &quot;https://domains.zeabur.app&quot; # å°†æ­¤é“¾æ¥æ¢æˆæ‚¨è‡ªå·±çš„Domains,ä¸»é¡µé“¾æ¥åé¢ä¸èƒ½åŠ  /  ä¼šå‡ºé”™</span><br></pre></td></tr></table></figure>\n<p>2. å®˜æ–¹æ¨è–¦ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly93YWxpbmUuanMub3JnL2d1aWRlL2RlcGxveS96ZWFidXIuaHRtbA==\"> Zeabur</span> æœåŠ¡ç«¯éƒ¨ç½²ï¼ŒæŒ‰ç…§å®ƒçš„æ­¥é©Ÿå¾Œåšæ¸¬è©¦æ™‚æœƒç™¼ç¾å¾—åˆ°çš„æ˜¯ not initialized, ç‚ºä»€éº¼å‘¢ï¼Ÿ<br>\n åŸå› æ˜¯ zeabur åªæ˜¯æœå‹™å™¨ï¼Œè€Œå®˜æ–¹é»˜èªæ˜¯ç”¨ LeanCloud ç‚ºæ•¸æ“šåº«ï¼Œæ‰€ä»¥åœ¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly93YWxpbmUuanMub3JnL2d1aWRlL2dldC1zdGFydGVkLw==\"> Waline</span> å¿«é€Ÿä¸Šæ‰‹ä¸­æœ‰èªªæ˜è¦è¨»å†Š LeanCloud å¸³è™Ÿæ‰å¯ä»¥ï¼Œè¡¨ç…§å¿«é€Ÿä¸Šæ‰‹çš„æ•™å­¸ï¼Œå¾—åˆ° APP ID,APP Key å’Œ Master Key, ç„¶å¾Œé€²å…¥ zeabur-starter ä¸­çš„ Variables é€²è¡Œé…ç½®ï¼Œé…ç½®ç’°å¢ƒè®Šé‡ LEAN_ID, LEAN_KEY å’Œ LEAN_MASTER_KEY, å€¼æ˜¯è¨»å†Š LeanCloud å¾—åˆ°çš„å€¼åƒé€™æ¨£é…ï½</p>\n<img data-src=\"/John/img/hexo/zeabur-starter-variable.png\" class=\"abc\" width=\"650\" height=\"450\">\n<p>2.1 ä¸€é–‹å§‹è¦ºå¾—ç¶²ç«™ä¸€å®šè¦æœ‰å€‹è©•è«–å€å§ï½æ‰€ä»¥å°±é…ç½®äº†ä¸€å€‹ï¼Œä¸éé…ç½®å¾Œç™¼ç¾ï¼Œzeabur åªæœ‰ 7 å¤©å…è²»ï¼ŒéæœŸå‰å¯ä»¥å»¶çºŒ 7 å¤©ï¼Œæ‰€ä»¥æŸå¤©ç™¼ç¾è©•è«–å€ä¸è¦‹äº†ï¼Œæ²’éŒ¯æ˜¯æˆ‘å¤ªæ‡¶æ²’æœ‰å»¶çºŒï¼Œç•¶ç„¶è§£æ±ºæ–¹æ³•å¯ä»¥éƒ¨ç½²åœ¨è‡ªå·±çš„ docker æˆ–äº‘æœå‹™ã€‚<br>\n2.2<span class=\"exturl\" data-url=\"aHR0cHM6Ly93YWxpbmUuanMub3JnL2d1aWRlL2dldC1zdGFydGVkLw==\">Zeabur å¿«é€Ÿä¸Šæ‰‹</span>ï¼Œå› ç‚ºæƒ³è¨­å€‹è©•è«–ç™¼ç¾äº†é€™å€‹è©•è«–ç³»çµ±ï¼Œè¦ºå¾—å®ƒè »ä¸éŒ¯çš„ï¼Œé‚„å¤šåŠŸèƒ½çš„åƒæ˜¯ç•™è¨€å¾Œæœƒç²å¾—é€šçŸ¥ï¼Œç”¨æˆ¶å®‰å…¨æ€§å’Œç•™è¨€é™åˆ¶ç­‰ç­‰ï¼Œæ„Ÿè¦ºæœ‰ç©ºå¯ä»¥å†æ·±å…¥ç ”ç©¶ç ”ç©¶ã€‚</p>\n<img data-src=\"https://i.makeagif.com/media/9-15-2015/bQkqor.gif\" class=\"abc\" width=\"600\" height=\"350\">",
            "tags": [
                "hexo"
            ]
        }
    ]
}