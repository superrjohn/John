<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/John/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/John/assets/apple-touch-icon.png"/><link rel="alternate" href="/John/rss.xml" title="ä¸€åˆ‡éƒ½æ˜¯éç¨‹" type="application/rss+xml"><link rel="alternate" href="/John/atom.xml" title="ä¸€åˆ‡éƒ½æ˜¯éç¨‹" type="application/atom+xml"><link rel="alternate" type="application/json" title="ä¸€åˆ‡éƒ½æ˜¯éç¨‹" href="https://superrjohn.github.io/John/feed.json"/><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"/><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"/><link rel="dns-prefetch" href="https://unpkg.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/John/css/app.css?v=0.3.6"><script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.js"></script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"/><meta name="keywords" content="æ”¯ä»˜"/><link rel="canonical" href="https://superrjohn.github.io/John/2023/11/08/java/pay/alipay"><title>æ•´åˆæ”¯ä»˜å¯¶</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">æ•´åˆæ”¯ä»˜å¯¶</h1><div class="meta"><span class="item" title="å‰µå»ºæ™‚é–“ï¼š2023-11-08 17:27:06"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">ç™¼è¡¨æ–¼</span><time itemprop="dateCreated datePublished" datetime="2023-11-08T17:27:06+08:00">2023-11-08</time></span><span class="item" title="æ–‡ç« å­—æ•¸"><span class="icon"><i class="ic i-pen"></i></span><span class="text">æ–‡ç« å­—æ•¸</span><span>42k</span><span class="text">å­—</span></span><span class="item" title="æ‰€éœ€é–±è®€æ™‚é–“"><span class="icon"><i class="ic i-clock"></i></span><span class="text">æ‰€éœ€é–±è®€æ™‚é–“</span><span>38 åˆ†é˜</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="åˆ‡æ›å°èˆªæ¬„"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/John/" rel="start">john's blog</a></li></ul><ul class="right" id="rightNav"><li class="item theme" @click="changeThemeByBtn"><i class="ic" :class="{'i-sun': !themeStatus,'i-moon': themeStatus}"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://e1.pxfuel.com/desktop-wallpaper/629/30/desktop-wallpaper-cyberpunk-2077-1920x1080-cyberpunk-2077-pc.jpg"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/John/">é¦–é </a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/John/categories/java/" itemprop="item" rel="index" title="åˆ†é¡æ–¼java"><span itemprop="name">java<meta itemprop="position" content="0"/></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/John/categories/java/pay/" itemprop="item" rel="index" title="åˆ†é¡æ–¼æ”¯ä»˜"><span itemprop="name">æ”¯ä»˜<meta itemprop="position" content="1"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-TW"><link itemprop="mainEntityOfPage" href="https://superrjohn.github.io/John/2023/11/08/java/pay/alipay"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/John/assets/404.png"/><meta itemprop="name" content="John"/><meta itemprop="description" content=", "/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="ä¸€åˆ‡éƒ½æ˜¯éç¨‹"/></span><div class="body md" itemprop="articleBody"><p>åœ¨æ­¤ç‰¹åˆ«æ„Ÿè¬é»‘é¦¬ç¨‹åºå“¡æä¾›çš„èª²ç¨‹: <span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMWo4NDExTjdCbS8=">å­¸æˆåœ¨ç·š</span></p>
<p>å‰è¨€<br>
æ–¼ç”±å¯¦ç¿’é …ç›®å¿«åšå®Œæ‰åšè¨˜éŒ„ï¼Œè€Œä¸”é …ç›®æ¨¡å¡Šè¼ƒå¤šï¼Œæ•…æŒ‘éƒ¨ä»½ä¾†è¨˜éŒ„<br>
<span class="rainbow">å®Œæ•´é¡¹ç›®åœ°å€</span>ï¼š<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3N1cGVycmpvaG4vamF2YV93ZWI=">https://github.com/superrjohn/java_web</span></p>
<h1 id="æ•´åˆç¬¬ä¸‰æ–¹æ”¯ä»˜"><a class="markdownIt-Anchor" href="#æ•´åˆç¬¬ä¸‰æ–¹æ”¯ä»˜">#</a> æ•´åˆç¬¬ä¸‰æ–¹æ”¯ä»˜</h1>
<h2 id="åŸ·è¡Œæµç¨‹"><a class="markdownIt-Anchor" href="#åŸ·è¡Œæµç¨‹">#</a> åŸ·è¡Œæµç¨‹</h2>
<p>ç”¨æˆ¶å»å­¸ç¿’æ”¶è²»èª²ç¨‹æ™‚å¼•å°å…¶å»æ”¯ä»˜ï¼Œå¦‚ä¸‹åœ–ï¼š<br>
ç•¶ä½¿ç”¨è€…é»æ“Šå¾®ä¿¡æ”¯ä»˜æˆ–æ”¯ä»˜å¯¶æ”¯ä»˜æ™‚åŸ·è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<img data-src="/John/img/java/pay/alipay/1.png" class="abc">
<p>1ï¸âƒ£è«‹æ±‚å­¸ç¿’ä¸­å¿ƒæœå‹™å»ºç«‹é¸èª²è¨˜éŒ„<br>
2ï¸âƒ£è«‹æ±‚è¨‚å–®æœå‹™å»ºç«‹å•†å“è¨‚å–®ã€ç”¢ç”Ÿæ”¯ä»˜äºŒç¶­ç¢¼ã€‚<br>
3ï¸âƒ£ç”¨æˆ¶æƒç¢¼è«‹æ±‚è¨‚å–®æ”¯ä»˜æœå‹™ï¼Œè¨‚å–®æ”¯ä»˜æœå‹™è«‹æ±‚ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°ç”¢ç”Ÿæ”¯ä»˜è¨‚å–®ã€‚<br>
4ï¸âƒ£å‰ç«¯å–šèµ·æ”¯ä»˜å®¢æˆ¶ç«¯ï¼Œä½¿ç”¨è€…è¼¸å…¥å¯†ç¢¼å®Œæˆä»˜æ¬¾ã€‚<br>
5ï¸âƒ£ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°æ”¯ä»˜å®Œæˆç™¼èµ·æ”¯ä»˜é€šçŸ¥ã€‚<br>
6ï¸âƒ£è¨‚å–®æ”¯ä»˜æœå‹™æ¥æ”¶ç¬¬ä¸‰æ–¹æ”¯ä»˜é€šçŸ¥çµæœã€‚<br>
7ï¸âƒ£ç”¨æˆ¶åœ¨å‰ç«¯æŸ¥è©¢ä»˜æ¬¾çµæœï¼Œè«‹æ±‚è¨‚å–®æ”¯ä»˜æœå‹™æŸ¥è©¢æ”¯ä»˜çµæœã€‚<br>
8ï¸âƒ£è¨‚å–®æ”¯ä»˜æœå‹™å‘å­¸ç¿’ä¸­å¿ƒæœå‹™é€šçŸ¥æ”¯ä»˜çµæœã€‚<br>
9ï¸âƒ£å­¸ç¿’ä¸­å¿ƒæœå‹™æ”¶åˆ°ä»˜æ¬¾çµæœï¼Œå¦‚æœæ”¯ä»˜æˆåŠŸå‰‡æ›´æ–°é¸èª²è¨˜éŒ„ï¼Œä¸¦æ·»åŠ åˆ°æˆ‘çš„èª²ç¨‹è¡¨ã€‚</p>
<h2 id="é€šç”¨è¨‚å–®æœå‹™è¨­è¨ˆ"><a class="markdownIt-Anchor" href="#é€šç”¨è¨‚å–®æœå‹™è¨­è¨ˆ">#</a> é€šç”¨è¨‚å–®æœå‹™è¨­è¨ˆ</h2>
<p>åœ¨æœ¬é …ç›®ä¸­ä¸åƒ…é¸èª²éœ€è¦ä¸‹å–®ï¼Œè³¼è²·å­¸ç¿’è³‡æ–™ã€è€å¸«ä¸€å°ä¸€ç­”ç–‘ç­‰æ‰€æœ‰æ”¶è²»é …ç›®éƒ½éœ€è¦æ”¯ä»˜ä¸‹å–®<br>
æ‰€ä»¥æœ¬é …ç›®è¨­è¨ˆé€šç”¨çš„è¨‚å–®æœå‹™ï¼Œé€šç”¨çš„è¨‚å–®æœå‹™æ‰¿æ¥å„æ¥­å‹™æ¨¡çµ„çš„æ”¶è²»æ”¯ä»˜éœ€æ±‚ï¼Œç•¶ç”¨æˆ¶éœ€è¦äº¤è²»æ™‚ï¼Œçµ±ä¸€ç”¢ç”Ÿå•†å“è¨‚å–®é€²è¡Œæ”¯ä»˜<br>
æ‰€æœ‰æ”¶è²»æ¥­å‹™æœ€çµ‚è½‰æ›ç‚ºè¨‚å–®è¨˜éŒ„ï¼Œåœ¨è¨‚å–®æœå‹™çš„å•†å“è¨‚å–®è¡¨ä¸­å­˜å„²<br>
ä»¥é¸èª²ç‚ºä¾‹ï¼Œé¸èª²è¨˜éŒ„è¡¨çš„ ID åœ¨å•†å“è¨‚å–®è¡¨çš„ out_business_id å­—æ®µ</p>
<h1 id="æº–å‚™é–‹ç™¼ç’°å¢ƒ"><a class="markdownIt-Anchor" href="#æº–å‚™é–‹ç™¼ç’°å¢ƒ">#</a> æº–å‚™é–‹ç™¼ç’°å¢ƒ</h1>
<h2 id="æ”¯ä»˜å¯¶é–‹ç™¼ç’°å¢ƒ"><a class="markdownIt-Anchor" href="#æ”¯ä»˜å¯¶é–‹ç™¼ç’°å¢ƒ">#</a> æ”¯ä»˜å¯¶é–‹ç™¼ç’°å¢ƒ</h2>
<p>1ï¸âƒ£é…ç½®æ²™ç®±ç’°å¢ƒ<br>
æ²™ç®±ç’°å¢ƒæ˜¯æ”¯ä»˜å¯¶é–‹æ”¾å¹³å°ç‚ºé–‹ç™¼è€…æä¾›çš„èˆ‡ç”Ÿç”¢ç’°å¢ƒå®Œå…¨éš”é›¢çš„è¯èª¿æ¸¬è©¦ç’°å¢ƒï¼Œé–‹ç™¼è€…åœ¨æ²™ç®±ç’°å¢ƒä¸­å®Œæˆçš„æ¥å£å‘¼å«ä¸æœƒå°ç”Ÿç”¢ç’°å¢ƒä¸­çš„è³‡æ–™é€ æˆä»»ä½•å½±éŸ¿ã€‚<br>
æ¥å…¥æ‰‹æ©Ÿç¶²ç«™æ”¯ä»˜éœ€å…·å‚™ä»¥ä¸‹æ¢ä»¶ï¼š</p>
<p>ğŸ”´ç”³è«‹å‰å¿…é ˆæ“æœ‰ç¶“éå¯¦åèªè­‰çš„æ”¯ä»˜å¯¶å¸³æˆ¶ï¼›</p>
<p>ğŸ”´ä¼æ¥­æˆ–å€‹é«”å·¥å•†æˆ¶å¯ç”³è«‹ï¼›</p>
<p>ğŸ”´éœ€æä¾›çœŸå¯¦æœ‰æ•ˆçš„ç‡Ÿæ¥­åŸ·ç…§ï¼Œä¸”æ”¯ä»˜å¯¶å¸³æˆ¶åç¨±éœ€èˆ‡ç‡Ÿæ¥­åŸ·ç…§ä¸»é«”ä¸€è‡´ï¼›</p>
<p>ğŸ”´ç¶²ç«™èƒ½æ­£å¸¸å­˜å–ä¸”é é¢é¡¯ç¤ºå®Œæ•´ï¼Œç¶²ç«™éœ€è¦æ˜ç¢ºç¶“ç‡Ÿå…§å®¹ä¸”æœ‰å®Œæ•´çš„å•†å“è³‡è¨Šï¼›</p>
<p>ğŸ”´ç¶²ç«™å¿…é ˆé€é ICP å‚™æ¡ˆã€‚ å¦‚ç‚ºå€‹é«”å·¥å•†æˆ¶ï¼Œç¶²ç«™å‚™æ¡ˆä¸»é«”éœ€èˆ‡æ”¯ä»˜å¯¶å¸³æˆ¶ä¸»é«”åç¨±ä¸€è‡´ï¼›</p>
<p>è©³ç´°åƒè€ƒï¼š<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9wZW4uYWxpcGF5LmNvbS8yMDM=">https://docs.open.alipay.com/203</span></p>
<p>æœ¬æ–‡æª”ä½¿ç”¨æ”¯ä»˜å¯¶æ²™ç®±é€²è¡Œé–‹ç™¼æ¸¬è©¦ï¼Œé€™è£¡ä¸»è¦ä»‹ç´¹æ”¯ä»˜å¯¶æ²™ç®±ç’°å¢ƒé…ç½®ã€‚</p>
<p>è©³ç´°åƒè€ƒï¼š<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9wZW4uYWxpcGF5LmNvbS8yMDAvMTA1MzExLw==">https://docs.open.alipay.com/200/105311/</span></p>
<p>2ï¸âƒ£æ¨¡æ“¬å™¨</p>
<p>ä¸‹è¼‰æ¨¡æ“¬å™¨ï¼š<span class="exturl" data-url="aHR0cDovL211bXUuMTYzLmNvbS8=">http://mumu.163.com/</span></p>
<p>å®‰è£æ¨¡æ“¬å™¨ï¼Œå®‰è£åœ¨æ²’æœ‰ç©ºæ ¼å’Œä¸­æ–‡çš„ç›®éŒ„ã€‚</p>
<p>å®‰è£æˆåŠŸï¼Œå•Ÿå‹•æ¨¡æ“¬å™¨</p>
<p>3ï¸âƒ£åœ¨æ¨¡æ“¬å™¨ä¸­å®‰è£æ²™ç®±ç‰ˆæœ¬çš„æ”¯ä»˜å¯¶</p>
<p>ä½¿ç”¨æ²™ç®±ç’°å¢ƒçš„è²·å®¶å¸³è™Ÿç™»å…¥æ²™ç®±ç‰ˆæœ¬çš„æ”¯ä»˜å¯¶</p>
<img data-src="/John/img/java/pay/alipay/2.png" class="abc">
<h1 id="å»ºç«‹è¨‚å–®æœå‹™"><a class="markdownIt-Anchor" href="#å»ºç«‹è¨‚å–®æœå‹™">#</a> å»ºç«‹è¨‚å–®æœå‹™</h1>
<p>æ‹·è²èª²ç¨‹è³‡æ–™ç›®éŒ„ä¸‹çš„è¨‚å–®æœå‹™å·¥ç¨‹ xuecheng-plus-orders åˆ°è‡ªå·±çš„å·¥ç¨‹ç›®éŒ„</p>
<p>ç„¶å¾Œåœ¨ nacos ä¸­æ·»åŠ é…ç½®æ–‡ä»¶<br>
 orders-api-dev.yaml</p>
<figure class="highlight yaml"><figcaption><span>yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/orders</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63030</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>orders-service-dev.yaml</p>
<figure class="highlight yaml"><figcaption><span>yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/xc_orders?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.128:18088/xxl-job-admin/</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">payresultnotify-job</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">8989</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure>
<p>å»ºç«‹ xc_orders è³‡æ–™åº«ï¼Œå°å…¥é»‘é¦¬æä¾›çš„ SQL è…³æœ¬</p>
<h1 id="æ”¯ä»˜æ¥å£æ¸¬è©¦"><a class="markdownIt-Anchor" href="#æ”¯ä»˜æ¥å£æ¸¬è©¦">#</a> æ”¯ä»˜æ¥å£æ¸¬è©¦</h1>
<h2 id="é–±è®€æ¥å£å®šç¾©"><a class="markdownIt-Anchor" href="#é–±è®€æ¥å£å®šç¾©">#</a> é–±è®€æ¥å£å®šç¾©</h2>
<p>1. æ‰‹æ©Ÿç¶²ç«™æ”¯ä»˜æ¥å–æµç¨‹è©³ç´°åƒè€ƒï¼š<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9wZW4uYWxpcGF5LmNvbS8yMDMvMTA1Mjg1Lw==">https://docs.open.alipay.com/203/105285/</span></p>
<p>1ï¸âƒ£ç”¨æˆ¶åœ¨å•†å®¶çš„ H5 ç¶²ç«™ä¸‹å–®ä»˜æ¬¾å¾Œï¼Œå•†å®¶ç³»çµ±ä¾ç…§æ‰‹æ©Ÿç¶²ç«™æ”¯ä»˜æ¥å£ alipay.trade.wap.payAPI çš„åƒæ•¸è¦æ ¼ç”¢ç”Ÿè¨‚å–®æ•¸æ“š</p>
<p>2ï¸âƒ£å‰ç«¯é é¢é€é Form è¡¨å–®çš„å½¢å¼è«‹æ±‚åˆ°æ”¯ä»˜å¯¶ã€‚ æ­¤æ™‚æ”¯ä»˜å¯¶æœƒè‡ªå‹•å°‡é é¢è·³åˆ°æ”¯ä»˜å¯¶ H5 æ”¶éŠ€å°é é¢ï¼Œå¦‚æœç”¨æˆ¶æ‰‹æ©Ÿä¸Šå®‰è£äº†æ”¯ä»˜å¯¶ APPï¼Œå‰‡æœƒè‡ªå‹•å–šèµ·æ”¯ä»˜å¯¶ APPã€‚</p>
<p>3ï¸âƒ£è¼¸å…¥æ”¯ä»˜å¯†ç¢¼å®Œæˆä»˜æ¬¾ã€‚</p>
<p>4ï¸âƒ£ç”¨æˆ¶åœ¨æ”¯ä»˜å¯¶ APP æˆ– H5 æ”¶éŠ€å°å®Œæˆä»˜æ¬¾å¾Œï¼Œæœƒæ ¹æ“šå•†å®¶åœ¨æ‰‹æ©Ÿç¶²ç«™æ”¯ä»˜ API ä¸­å‚³å…¥çš„å‰å°å›è·³åœ°å€ return_url è‡ªå‹•è·³è½‰å›å•†å®¶é é¢ï¼ŒåŒæ™‚åœ¨ URL è«‹æ±‚ä¸­ä»¥ Query String çš„å½¢å¼é™„å¸¶ æ”¯ä»˜çµæœåƒæ•¸ï¼Œè©³ç´°å›è·³åƒæ•¸è«‹è¦‹ã€Œæ‰‹æ©Ÿç¶²ç«™æ”¯ä»˜æ¥å£ alipay.trade.wap.payã€å‰å°å›è·³åƒæ•¸ã€‚</p>
<p>5ï¸âƒ£æ”¯ä»˜å¯¶ä¹Ÿæœƒæ ¹æ“šåŸå§‹æ”¯ä»˜ API ä¸­å‚³å…¥çš„éåŒæ­¥é€šçŸ¥åœ°å€ notify_urlï¼Œé€é POST è«‹æ±‚çš„å½¢å¼å°‡æ”¯ä»˜çµæœä½œç‚ºåƒæ•¸é€šçŸ¥åˆ°å•†å®¶ç³»çµ±ï¼Œè©³æƒ…è«‹åƒé–±æ”¯ä»˜çµæœéåŒæ­¥é€šçŸ¥ã€‚</p>
<p>2ã€æ¥å£å®šç¾©</p>
<p>æ–‡æª”ï¼š<span class="exturl" data-url="aHR0cHM6Ly9vcGVuZG9jcy5hbGlwYXkuY29tL29wZW4vMjAzLzEwNzA5MA==">https://opendocs.alipay.com/open/203/107090</span></p>
<p>æ¥å£å®šç¾©ï¼šå¤–éƒ¨å•†å®¶è¦æ±‚æ”¯ä»˜å¯¶å»ºç«‹è¨‚å–®ä¸¦æ”¯ä»˜</p>
<p>è«‹æ±‚åœ°å€ï¼šé–‹ç™¼ä¸­ä½¿ç”¨æ²™ç®±ä½å€ï¼š<span class="exturl" data-url="aHR0cHM6Ly9vcGVuYXBpLmFsaXBheWRldi5jb20vZ2F0ZXdheS5kbw==">https://openapi.alipaydev.com/gateway.do</span></p>
<p>è«‹æ±‚åƒæ•¸ï¼šè©³ç´°æŸ¥é–±<span class="exturl" data-url="aHR0cHM6Ly9vcGVuZG9jcy5hbGlwYXkuY29tL29wZW4vMjAzLzEwNzA5MA=="> https://opendocs.alipay.com/open/203/107090</span></p>
<p>ä¸€éƒ¨åˆ†ç”± sdk è¨­ç½®ï¼Œä¸€éƒ¨åˆ†éœ€è¦ç·¨å¯«ç¨‹å¼æ™‚æŒ‡å®šã€‚</p>
<p>3. ç¤ºä¾‹ä»£ç¢¼</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> ... <span class="comment">//è·å¾—åˆå§‹åŒ–çš„AlipayClient</span></span><br><span class="line">    <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//åˆ›å»ºAPIå¯¹åº”çš„request</span></span><br><span class="line">    alipayRequest.setReturnUrl(<span class="string">&quot;http://domain.com/CallBack/return_url.jsp&quot;</span>);</span><br><span class="line">    alipayRequest.setNotifyUrl(<span class="string">&quot;http://domain.com/CallBack/notify_url.jsp&quot;</span>);<span class="comment">//åœ¨å…¬å…±å‚æ•°ä¸­è®¾ç½®å›è·³å’Œé€šçŸ¥åœ°å€</span></span><br><span class="line">    alipayRequest.setBizContent(<span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;out_trade_no\&quot;:\&quot;20150320010101002\&quot;,&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;total_amount\&quot;:88.88,&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;subject\&quot;:\&quot;Iphone6 16G\&quot;,&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;product_code\&quot;:\&quot;QUICK_WAP_WAY\&quot;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;&quot;</span>);<span class="comment">//å¡«å……ä¸šåŠ¡å‚æ•°</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//è°ƒç”¨SDKç”Ÿæˆè¡¨å•</span></span><br><span class="line">    httpResponse.setContentType(<span class="string">&quot;text/html;charset=&quot;</span> + AlipayServiceEnvConstants.CHARSET);</span><br><span class="line">    httpResponse.getWriter().write(form);<span class="comment">//ç›´æ¥å°†å®Œæ•´çš„è¡¨å•htmlè¾“å‡ºåˆ°é¡µé¢</span></span><br><span class="line">    httpResponse.getWriter().flush();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸‹å–®åŸ·è¡Œæµç¨‹"><a class="markdownIt-Anchor" href="#ä¸‹å–®åŸ·è¡Œæµç¨‹">#</a> ä¸‹å–®åŸ·è¡Œæµç¨‹</h2>
<p>æ ¹æ“šæ¥å£æè¿°ï¼Œæ”¯ä»˜å¯¶ä¸‹å–®æ¥å£çš„åŸ·è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<img data-src="/John/img/java/pay/alipay/3.png" class="abc">
<h2 id="ç·¨å¯«ä¸‹å–®ç¨‹å¼ç¢¼"><a class="markdownIt-Anchor" href="#ç·¨å¯«ä¸‹å–®ç¨‹å¼ç¢¼">#</a> ç·¨å¯«ä¸‹å–®ç¨‹å¼ç¢¼</h2>
<p>æ ¹æ“šæ¥å£æµç¨‹ï¼Œé¦–å…ˆåœ¨è¨‚å–®æœå‹™ç·¨å¯«æ¸¬è©¦é¡åˆ¥è«‹æ±‚æ”¯ä»˜å¯¶ä¸‹å–®çš„æ¥å£ã€‚</p>
<p>åœ¨è¨‚å–®æœå‹™ api å·¥ç¨‹æ·»åŠ ä¾è³´ï¼š</p>
<figure class="highlight xml"><figcaption><span>xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ”¯ä»˜å®SDK --&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.73.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- æ”¯ä»˜å®SDKä¾èµ–çš„æ—¥å¿— --&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure>
<p>æ‹·è² AlipayConfig.java åˆ°è¨‚å–®æœå‹™çš„ service å·¥ç¨‹ï¼Œå…¶ä¸­è«‹æ±‚ç¶²ç«™åœ°å€ç‚ºæ”¯ä»˜å¯¶æ”¯ä»˜æ¥å£åœ°å€</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlipayConfig</span> &#123;</span><br><span class="line">    <span class="comment">// å•†æˆ·appid</span></span><br><span class="line"><span class="comment">//	public static String APPID = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">// ç§é’¥ pkcs8æ ¼å¼çš„</span></span><br><span class="line"><span class="comment">//	public static String RSA_PRIVATE_KEY = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨å¼‚æ­¥é€šçŸ¥é¡µé¢è·¯å¾„ éœ€http://æˆ–è€…https://æ ¼å¼çš„å®Œæ•´è·¯å¾„ï¼Œä¸èƒ½åŠ ?id=123è¿™ç±»è‡ªå®šä¹‰å‚æ•°ï¼Œå¿…é¡»å¤–ç½‘å¯ä»¥æ­£å¸¸è®¿é—®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">notify_url</span> <span class="operator">=</span> <span class="string">&quot;http://å•†æˆ·ç½‘å…³åœ°å€/alipay.trade.wap.pay-JAVA-UTF-8/notify_url.jsp&quot;</span>;</span><br><span class="line">    <span class="comment">// é¡µé¢è·³è½¬åŒæ­¥é€šçŸ¥é¡µé¢è·¯å¾„ éœ€http://æˆ–è€…https://æ ¼å¼çš„å®Œæ•´è·¯å¾„ï¼Œä¸èƒ½åŠ ?id=123è¿™ç±»è‡ªå®šä¹‰å‚æ•°ï¼Œå¿…é¡»å¤–ç½‘å¯ä»¥æ­£å¸¸è®¿é—® å•†æˆ·å¯ä»¥è‡ªå®šä¹‰åŒæ­¥è·³è½¬åœ°å€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">return_url</span> <span class="operator">=</span> <span class="string">&quot;http://å•†æˆ·ç½‘å…³åœ°å€/alipay.trade.wap.pay-JAVA-UTF-8/return_url.jsp&quot;</span>;</span><br><span class="line">    <span class="comment">// è¯·æ±‚ç½‘å…³åœ°å€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;https://openapi.alipaydev.com/gateway.do&quot;</span>;</span><br><span class="line">    <span class="comment">// ç¼–ç </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">    <span class="comment">// è¿”å›æ ¼å¼</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">FORMAT</span> <span class="operator">=</span> <span class="string">&quot;json&quot;</span>;</span><br><span class="line">    <span class="comment">// æ”¯ä»˜å®å…¬é’¥</span></span><br><span class="line"><span class="comment">//	public static String ALIPAY_PUBLIC_KEY = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">// æ—¥å¿—è®°å½•ç›®å½•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">log_path</span> <span class="operator">=</span> <span class="string">&quot;/log&quot;</span>;</span><br><span class="line">    <span class="comment">// RSA2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SIGNTYPE</span> <span class="operator">=</span> <span class="string">&quot;RSA2&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æƒç¢¼æ”¯ä»˜å…¶å¯¦å°±æ˜¯è«‹æ±‚ URL, æ‰€ä»¥æˆ‘å€‘è¦å¯«ä¸€å€‹ Controller, æˆ‘å€‘è¦ new DefaultAlipayClient é¡ä¸¦ä¿®æ”¹åƒæ•¸</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span></span><br><span class="line">    String APP_ID;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span></span><br><span class="line">    String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;)</span></span><br><span class="line">    String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/alipaytest&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                    HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException, AlipayApiException &#123;</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY,AlipayConfig.SIGNTYPE);</span><br><span class="line">        <span class="comment">//è·å¾—åˆå§‹åŒ–çš„AlipayClient</span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//åˆ›å»ºAPIå¯¹åº”çš„request</span></span><br><span class="line"><span class="comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span></span><br><span class="line"><span class="comment">//        alipayRequest.setNotifyUrl(&quot;http://domain.com/CallBack/notify_url.jsp&quot;);//åœ¨å…¬å…±å‚æ•°ä¸­è®¾ç½®å›è·³å’Œé€šçŸ¥åœ°å€</span></span><br><span class="line">        alipayRequest.setBizContent(<span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;out_trade_no\&quot;:\&quot;202210100010101002\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;total_amount\&quot;:100000,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;subject\&quot;:\&quot;Iphone6 16G\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;product_code\&quot;:\&quot;QUICK_WAP_WAY\&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;&quot;</span>);<span class="comment">//å¡«å……ä¸šåŠ¡å‚æ•°</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//è°ƒç”¨SDKç”Ÿæˆè¡¨å•</span></span><br><span class="line">        httpResponse.setContentType(<span class="string">&quot;text/html;charset=&quot;</span> + AlipayConfig.CHARSET);</span><br><span class="line">        httpResponse.getWriter().write(form);<span class="comment">//ç›´æ¥å°†å®Œæ•´çš„è¡¨å•htmlè¾“å‡ºåˆ°é¡µé¢</span></span><br><span class="line">        httpResponse.getWriter().flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ nacos ä¸­çš„ orders-service-dev.yaml ä¸­é…ç½®å…¬é’¥å’Œç§é’¥ï¼Œå¾ä½ çš„æ²™ç®±ç’°å¢ƒå¸³è™Ÿç²å¾—</p>
<figure class="highlight yml"><figcaption><span>yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pay:</span></span><br><span class="line">  <span class="attr">alipay:</span></span><br><span class="line">    <span class="attr">APP_ID:</span> <span class="string">å†™ä½ è‡ªå·±çš„AppID</span></span><br><span class="line">    <span class="attr">APP_PRIVATE_KEY:</span> <span class="string">å†™ä½ è‡ªå·±çš„åº”ç”¨ç§é’¥</span></span><br><span class="line">    <span class="attr">ALIPAY_PUBLIC_KEY:</span> <span class="string">å†™ä½ è‡ªå·±çš„æ”¯ä»˜å®å…¬é’¥</span></span><br></pre></td></tr></table></figure>
<h2 id="ç”¢ç”ŸäºŒç¶­ç¢¼"><a class="markdownIt-Anchor" href="#ç”¢ç”ŸäºŒç¶­ç¢¼">#</a> ç”¢ç”ŸäºŒç¶­ç¢¼</h2>
<p>ä½¿ç”¨è€…åœ¨å‰ç«¯ä½¿ç”¨æ”¯ä»˜å¯¶æ²™ç®±é€éæƒç¢¼è«‹æ±‚ä¸‹å–®æ¥å£ï¼Œæˆ‘å€‘éœ€è¦ç”¢ç”Ÿè¨‚å–®æœå‹™çš„ä¸‹å–®æ¥å£çš„äºŒç¶­ç¢¼ã€‚</p>
<p>ZXing æ˜¯ä¸€å€‹é–‹æºçš„é¡åˆ¥åº«ï¼Œæ˜¯ç”¨ Java ç·¨å¯«çš„å¤šæ ¼å¼çš„ 1D / 2D æ¢ç¢¼åœ–åƒè™•ç†åº«ï¼Œä½¿ç”¨ ZXing å¯ä»¥ç”¢ç”Ÿã€è­˜åˆ¥ QR Codeï¼ˆäºŒç¶­ç¢¼ï¼‰ã€‚ å¸¸ç”¨çš„äºŒç¶­ç¢¼è™•ç†åº«é‚„æœ‰ zbarï¼Œè¿‘å¹¾å¹´ä¸å†æ›´æ–°ç¨‹å¼ç¢¼ï¼Œä¸‹é‚Šä»‹ç´¹ ZXing ç”¢ç”ŸäºŒç¶­ç¢¼çš„æ–¹æ³•ã€‚</p>
<p>1ï¼‰åœ¨ base å·¥ç¨‹ pom.xml ä¸­åŠ å…¥ä¾è³´ï¼š</p>
<figure class="highlight xml"><figcaption><span>XML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- äºŒç»´ç ç”Ÿæˆ&amp;è¯†åˆ«ç»„ä»¶ --&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure>
<p>2ï¼‰ç”¢ç”ŸäºŒç¶­ç¢¼æ–¹æ³•</p>
<p>æ‹·è²èª²ç¨‹è³‡æ–™ä¸­ utils ä¸‹çš„ QRCodeUtil.java åˆ° base å·¥ç¨‹ util åŒ…ä¸‹ã€‚</p>
<p>æ¸¬è©¦æ ¹æ“šå…§å®¹ç”¢ç”ŸäºŒç¶­ç¢¼æ–¹æ³•ï¼Œåœ¨ QRCodeUtil ä¸­åŠ å…¥ main æ–¹æ³•ï¼Œç•¶åŸ·è¡Œä»£ç¢¼æ™‚æœƒç”Ÿæˆ base64 ä¸²ï¼Œå°‡ base64 ä¸²è¤‡è£½åˆ°ç€è¦½å™¨ä½å€å¾Œå°‡é¡¯ç¤ºä¸€å€‹äºŒç¶­ç¢¼ï¼Œç”¨æˆ¶ç”¨æ‰‹æ©Ÿæƒæ­¤äºŒç¶­ç¢¼å°‡è¦æ±‚è‡³<span class="exturl" data-url="aHR0cDovL3d3dy5pdGNhc3QuY24v"> http://www.itcast.cn/</span> , å¦‚ä¸‹:</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123; </span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>(); </span><br><span class="line">    System.out.println(qrCodeUtil.createQRCode(<span class="string">&quot;http://www.itcast.cn/&quot;</span>, <span class="number">200</span>, <span class="number">200</span>)); </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="æ¥å£æ¸¬è©¦"><a class="markdownIt-Anchor" href="#æ¥å£æ¸¬è©¦">#</a> æ¥å£æ¸¬è©¦</h2>
<p>ä¿®æ”¹æˆ‘å€‘ä¹‹å‰çš„ main æ–¹æ³•ï¼Œå°‡ url æ›æˆä¸‹å–®æ¥å£ï¼Œæ³¨æ„é€™è£¡ä¸è¦ç”¨ localhostï¼Œå¾—ç”¨æœ¬æ©Ÿå€åŸŸç¶²è·¯ ip, ç¾åœ¨ç”¨æˆ¶æƒç¢¼å¾Œæœƒè«‹æ±‚åˆ°æˆ‘å€‘å¯«çš„æ”¯ä»˜æ¥å£</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    System.out.println(qrCodeUtil.createQRCode(<span class="string">&quot;http://192.168.101.1:63030/orders/alipaytest&quot;</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‹è¡Œ main æ–¹æ³•ï¼Œå¾—åˆ°äºŒç¶­ç¢¼å¾Œï¼Œé–‹å•Ÿæ¨¡æ“¬å™¨ï¼Œåœ¨æ¨¡æ“¬å™¨ä¸­é–‹å•Ÿæ”¯ä»˜å¯¶æ²™ç®±å®¢æˆ¶ç«¯ï¼Œä¸¦ä½¿ç”¨æ²™ç®±å®¢æˆ¶ç«¯æƒç”Ÿæˆçš„äºŒç¶­ç¢¼ï¼Œå°±æœƒèª¿ç”¨ SDK ç”Ÿæˆè¡¨å–®ï¼Œä¸¦å–šé†’æ”¯ä»˜å¯¶çš„ JS çª—å£</p>
<h1 id="æ”¯ä»˜çµæœæŸ¥è©¢æ¥å£"><a class="markdownIt-Anchor" href="#æ”¯ä»˜çµæœæŸ¥è©¢æ¥å£">#</a> æ”¯ä»˜çµæœæŸ¥è©¢æ¥å£</h1>
<p>æ”¯ä»˜å®Œæˆå¯ä»¥å‘¼å«ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°çš„ä»˜æ¬¾çµæœæŸ¥è©¢æ¥å£æŸ¥è©¢æ”¯ä»˜çµæœï¼Œä»¥ä¸‹ç”¨æ¸¬è©¦é¡æŸ¥è©¢</p>
<p>æ–‡ä»¶ï¼š<span class="exturl" data-url="aHR0cHM6Ly9vcGVuZG9jcy5hbGlwYXkuY29tL29wZW4vMDJpdmJ0">https://opendocs.alipay.com/open/02ivbt</span></p>
<p>å‰›æ‰è¨‚å–®ä»˜æ¬¾æˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨ out_trade_no å•†å“è¨‚å–®è™Ÿç¢¼æˆ–æ”¯ä»˜å¯¶çš„äº¤æ˜“æµæ°´è™Ÿ trade_no å»æŸ¥è©¢ä»˜æ¬¾çµæœã€‚</p>
<p>out_trade_no å•†å“è¨‚å–®è™Ÿç¢¼ï¼šæ˜¯åœ¨ä¸‹å–®è¦æ±‚æ™‚æŒ‡å®šçš„å•†å“è¨‚å–®è™Ÿç¢¼ã€‚</p>
<p>æ”¯ä»˜å¯¶çš„äº¤æ˜“æµæ°´è™Ÿ trade_noï¼šæ˜¯æ”¯ä»˜å®Œæˆå¾Œæ”¯ä»˜å¯¶é€šçŸ¥ä»˜æ¬¾çµæœæ™‚ç™¼é€çš„ trade_no</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliPayTest</span> &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span> </span><br><span class="line">    String APP_ID; </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span> </span><br><span class="line">    String APP_PRIVATE_KEY; </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;)</span> </span><br><span class="line">    String ALIPAY_PUBLIC_KEY; </span><br><span class="line"> </span><br><span class="line"><span class="meta">@Test</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryPayResult</span><span class="params">()</span> <span class="keyword">throws</span> AlipayApiException &#123; </span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, <span class="string">&quot;json&quot;</span>, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE); <span class="comment">//è·å¾—åˆå§‹åŒ–çš„AlipayClient </span></span><br><span class="line">    <span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>(); </span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(); </span><br><span class="line">    bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, <span class="string">&quot;202210100010101002&quot;</span>); </span><br><span class="line">    <span class="comment">//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;); </span></span><br><span class="line">    request.setBizContent(bizContent.toString()); </span><br><span class="line">    <span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request); </span><br><span class="line">    <span class="keyword">if</span> (response.isSuccess()) &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨æˆåŠŸ&quot;</span>); </span><br><span class="line">        <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> response.getBody(); </span><br><span class="line">        <span class="comment">//è½¬map </span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> JSON.parseObject(resultJson, Map.class); </span><br><span class="line">        <span class="type">Map</span> <span class="variable">alipay_trade_query_response</span> <span class="operator">=</span> (Map) resultMap.get(<span class="string">&quot;alipay_trade_query_response&quot;</span>); </span><br><span class="line">        <span class="comment">//æ”¯ä»˜ç»“æœ </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">&quot;trade_status&quot;</span>); </span><br><span class="line">        System.out.println(trade_status); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨å¤±è´¥&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éŸ¿æ‡‰å›ä¾†é‡è¦çš„åƒæ•¸ç‚º:<br>
â€œout_trade_noâ€ : â€œ20220520010101026â€,</p>
<p>â€œtrade_noâ€:â€œ2022100422001422760505740639â€  ï¼š æ”¯ä»˜å®äº¤æ˜“æµæ°´å·</p>
<p>â€œtotal_amountâ€ : â€œ1.30â€</p>
<p>â€œtrade_statusâ€ : â€œTRADE_SUCCESSâ€ï¼š</p>
<h2 id="æ”¯ä»˜çµæœé€šçŸ¥æ¥å£"><a class="markdownIt-Anchor" href="#æ”¯ä»˜çµæœé€šçŸ¥æ¥å£">#</a> æ”¯ä»˜çµæœé€šçŸ¥æ¥å£</h2>
<p>æº–å‚™ç’°å¢ƒ<br>
å°æ–¼æ‰‹æ©Ÿç¶²ç«™æ”¯ä»˜ç”¢ç”Ÿçš„äº¤æ˜“ï¼Œæ”¯ä»˜å¯¶æœƒé€šçŸ¥å•†å®¶æ”¯ä»˜çµæœï¼Œæœ‰å…©ç¨®é€šçŸ¥æ–¹å¼ï¼Œé€é return_urlã€notify_url é€²è¡Œé€šçŸ¥ï¼Œä½¿ç”¨ return_url ä¸èƒ½ä¿è­‰é€šçŸ¥åˆ°ä½ï¼Œæ¨è–¦ä½¿ç”¨ notify_url å®Œæˆæ”¯ä»˜çµæ§‹é€šçŸ¥ã€‚</p>
<p>å…·é«”çš„ä½¿ç”¨æ–¹æ³•æ˜¯åœ¨å‘¼å«ä¸‹å–®æ¥å£çš„ API ä¸­å‚³å…¥çš„éåŒæ­¥é€šçŸ¥ä½å€ notify_urlï¼Œé€é POST è«‹æ±‚çš„å½¢å¼å°‡æ”¯ä»˜çµæœä½œç‚ºåƒæ•¸é€šçŸ¥åˆ°å•†å®¶ç³»çµ±ã€‚ è©³æƒ…å¯æŸ¥çœ‹ æ”¯ä»˜å¯¶éåŒæ­¥é€šçŸ¥èªªæ˜ ã€‚</p>
<p>æ–‡ä»¶ï¼š<span class="exturl" data-url="aHR0cHM6Ly9vcGVuZG9jcy5hbGlwYXkuY29tL29wZW4vMjAzLzEwNTI4Ng==">https://opendocs.alipay.com/open/203/105286</span></p>
<p>æ ¹æ“šä¸‹å–®åŸ·è¡Œæµç¨‹ï¼Œè¨‚å–®æœå‹™æ”¶åˆ°ä»˜æ¬¾çµæœéœ€è¦å°å…§å®¹é€²è¡Œé©—ç°½ï¼Œé©—ç°½æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£åœ¨é€šçŸ¥å›å‚³åƒæ•¸æ¸…å–®ä¸­ï¼Œé™¤å» signã€sign_type å…©å€‹åƒæ•¸å¤–ï¼Œå‡¡æ˜¯é€šçŸ¥å›å‚³å›ä¾†çš„åƒæ•¸éƒ½æ˜¯å¾…é©—ç°½çš„åƒæ•¸ã€‚ å°‡å‰©é¤˜åƒæ•¸é€²è¡Œ url_decodeï¼Œç„¶å¾Œé€²è¡Œå­—å…¸æ’åºï¼Œçµ„æˆå­—ä¸²ï¼Œå¾—åˆ°å¾…ç°½åå­—ä¸²ï¼› ç”Ÿæ´»è™ŸéåŒæ­¥é€šçŸ¥çµ„æˆçš„å¾…é©—ç°½ä¸²è£¡éœ€è¦ä¿ç•™ sign_type åƒæ•¸ã€‚</p>
<p>2ï¸âƒ£å°‡ç°½ç« åƒæ•¸ï¼ˆsignï¼‰ä½¿ç”¨ base64 è§£ç¢¼ç‚ºå­—ç¯€ç¢¼å­—ä¸²ï¼›</p>
<p>3ï¸âƒ£ä½¿ç”¨ RSA çš„é©—ç°½æ–¹æ³•ï¼Œé€éç°½ç« å­—ä¸²ã€ç°½ç« åƒæ•¸ï¼ˆç¶“é base64 è§£ç¢¼ï¼‰åŠæ”¯ä»˜å¯¶å…¬é‘°é©—è­‰ç°½ç« ã€‚</p>
<p>4ï¸âƒ£é©—è­‰ç°½ç« æ­£ç¢ºå¾Œï¼Œå¿…é ˆå†åš´æ ¼ä¾ç…§ä»¥ä¸‹æè¿°æ ¡é©—é€šçŸ¥è³‡æ–™çš„æ­£ç¢ºæ€§ã€‚</p>
<p>åœ¨ä¸Šè¿°é©—è­‰é€šéå¾Œï¼Œå•†å®¶å¿…é ˆæ ¹æ“šæ”¯ä»˜å¯¶ä¸åŒé¡å‹çš„æ¥­å‹™é€šçŸ¥ï¼Œæ­£ç¢ºçš„é€²è¡Œä¸åŒçš„æ¥­å‹™è™•ç†ï¼Œä¸¦ä¸”éæ¿¾é‡è¤‡çš„é€šçŸ¥çµæœè³‡æ–™ã€‚</p>
<p>é€éé©—è­‰ out_trade_noã€total_amountã€appid åƒæ•¸çš„æ­£ç¢ºæ€§ä¾†åˆ¤æ–·é€šçŸ¥è«‹æ±‚çš„åˆæ³•æ€§ã€‚</p>
<h2 id="ç·¨å¯«æ¸¬è©¦ç¨‹å¼ç¢¼"><a class="markdownIt-Anchor" href="#ç·¨å¯«æ¸¬è©¦ç¨‹å¼ç¢¼">#</a> ç·¨å¯«æ¸¬è©¦ç¨‹å¼ç¢¼</h2>
<p>åœ¨ä¸‹å–®è«‹æ±‚æ™‚è¨­å®šé€šçŸ¥ä½å€ request.setNotifyUrl (â€œå•†å®¶è‡ªå·±çš„ notify_url ä½å€â€);</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/alipaytest&quot;)</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">alipaytest</span><span class="params">(HttpServletRequest httpRequest, </span></span><br><span class="line"><span class="params">                           HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123; </span><br><span class="line">        <span class="comment">//æ„é€ sdkçš„å®¢æˆ·ç«¯å¯¹è±¡ </span></span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(serverUrl, APP_ID, APP_PRIVATE_KEY, <span class="string">&quot;json&quot;</span>, CHARSET, ALIPAY_PUBLIC_KEY, sign_type); <span class="comment">//è·å¾—åˆå§‹åŒ–çš„AlipayClient </span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//åˆ›å»ºAPIå¯¹åº”çš„request </span></span><br><span class="line"><span class="comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;); </span></span><br><span class="line">        alipayRequest.setNotifyUrl(<span class="string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;</span>);<span class="comment">//åœ¨å…¬å…±å‚æ•°ä¸­è®¾ç½®å›è·³å’Œé€šçŸ¥åœ°å€ </span></span><br><span class="line">        ..... </span><br><span class="line">         </span><br></pre></td></tr></table></figure>
<p><span class="yellow">æ³¨æ„ç”±æ–¼å›å‘¼ä½å€å¿…é ˆå¤–ç¶²å¯å­˜å–çš„ä½å€ï¼Œæ‰€ä»¥é€™è£¡éœ€è¦å…§ç¶²ç©¿é€å·¥å…·ï¼Œå¯ä»¥ç”¨ NatApp æˆ–è€…èŠ±ç”Ÿæ®¼</span></p>
<p>ç·¨å¯«æ¥æ”¶é€šçŸ¥æ¥å£ï¼Œæ¥æ”¶åƒæ•¸ä¸¦é©—ç°½</p>
<p>åƒè€ƒèª²ç¨‹è³‡æ–™ä¸‹çš„ alipay.trade.wap.pay-java-utf-8\WebContent\notify_url.jsp, ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¥æ”¶é€šçŸ¥ </span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/paynotify&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paynotify</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> <span class="keyword">throws</span> UnsupportedEncodingException, AlipayApiException &#123; </span><br><span class="line">    Map&lt;String,String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;(); </span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap(); </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext();) &#123; </span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next(); </span><br><span class="line">        String[] values = (String[]) requestParams.get(name); </span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>; </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123; </span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i] </span><br><span class="line">                    : valueStr + values[i] + <span class="string">&quot;,&quot;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//ä¹±ç è§£å†³ï¼Œè¿™æ®µä»£ç åœ¨å‡ºç°ä¹±ç æ—¶ä½¿ç”¨ã€‚å¦‚æœmysignå’Œsignä¸ç›¸ç­‰ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™æ®µä»£ç è½¬åŒ– </span></span><br><span class="line">        <span class="comment">//valueStr = new String(valueStr.getBytes(&quot;ISO-8859-1&quot;), &quot;gbk&quot;); </span></span><br><span class="line">        params.put(name, valueStr); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//è·å–æ”¯ä»˜å®çš„é€šçŸ¥è¿”å›å‚æ•°ï¼Œå¯å‚è€ƒæŠ€æœ¯æ–‡æ¡£ä¸­é¡µé¢è·³è½¬åŒæ­¥é€šçŸ¥å‚æ•°åˆ—è¡¨(ä»¥ä¸Šä»…ä¾›å‚è€ƒ)// </span></span><br><span class="line">    <span class="comment">//è®¡ç®—å¾—å‡ºé€šçŸ¥éªŒè¯ç»“æœ </span></span><br><span class="line">    <span class="comment">//boolean AlipaySignature.rsaCheckV1(Map&lt;String, String&gt; params, String publicKey, String charset, String sign_type) </span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">&quot;RSA2&quot;</span>); </span><br><span class="line">    <span class="keyword">if</span>(verify_result) &#123;<span class="comment">//éªŒè¯æˆåŠŸ </span></span><br><span class="line">        <span class="comment">////////////////////////////////////////////////////////////////////////////////////////// </span></span><br><span class="line">        <span class="comment">//è¯·åœ¨è¿™é‡ŒåŠ ä¸Šå•†æˆ·çš„ä¸šåŠ¡é€»è¾‘ç¨‹åºä»£ç  </span></span><br><span class="line">         <span class="comment">//å•†æˆ·è®¢å•å· </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;out_trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>); </span><br><span class="line">        <span class="comment">//æ”¯ä»˜å®äº¤æ˜“å·     </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>); </span><br><span class="line">        <span class="comment">//äº¤æ˜“çŠ¶æ€ </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_status&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>); </span><br><span class="line">        <span class="comment">//â€”â€”è¯·æ ¹æ®æ‚¨çš„ä¸šåŠ¡é€»è¾‘æ¥ç¼–å†™ç¨‹åºï¼ˆä»¥ä¸‹ä»£ç ä»…ä½œå‚è€ƒï¼‰â€”â€” </span></span><br><span class="line">        <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_FINISHED&quot;</span>)) &#123;<span class="comment">//äº¤æ˜“ç»“æŸ </span></span><br><span class="line">            <span class="comment">//åˆ¤æ–­è¯¥ç¬”è®¢å•æ˜¯å¦åœ¨å•†æˆ·ç½‘ç«™ä¸­å·²ç»åšè¿‡å¤„ç† </span></span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰åšè¿‡å¤„ç†ï¼Œæ ¹æ®è®¢å•å·ï¼ˆout_trade_noï¼‰åœ¨å•†æˆ·ç½‘ç«™çš„è®¢å•ç³»ç»Ÿä¸­æŸ¥åˆ°è¯¥ç¬”è®¢å•çš„è¯¦ç»†ï¼Œå¹¶æ‰§è¡Œå•†æˆ·çš„ä¸šåŠ¡ç¨‹åº </span></span><br><span class="line">            <span class="comment">//è¯·åŠ¡å¿…åˆ¤æ–­è¯·æ±‚æ—¶çš„total_feeã€seller_idä¸é€šçŸ¥æ—¶è·å–çš„total_feeã€seller_idä¸ºä¸€è‡´çš„ </span></span><br><span class="line">            <span class="comment">//å¦‚æœæœ‰åšè¿‡å¤„ç†ï¼Œä¸æ‰§è¡Œå•†æˆ·çš„ä¸šåŠ¡ç¨‹åº </span></span><br><span class="line">            <span class="comment">//æ³¨æ„ï¼š </span></span><br><span class="line">            <span class="comment">//å¦‚æœç­¾çº¦çš„æ˜¯å¯é€€æ¬¾åè®®ï¼Œé€€æ¬¾æ—¥æœŸè¶…è¿‡å¯é€€æ¬¾æœŸé™åï¼ˆå¦‚ä¸‰ä¸ªæœˆå¯é€€æ¬¾ï¼‰ï¼Œæ”¯ä»˜å®ç³»ç»Ÿå‘é€è¯¥äº¤æ˜“çŠ¶æ€é€šçŸ¥ </span></span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰ç­¾çº¦å¯é€€æ¬¾åè®®ï¼Œé‚£ä¹ˆä»˜æ¬¾å®Œæˆåï¼Œæ”¯ä»˜å®ç³»ç»Ÿå‘é€è¯¥äº¤æ˜“çŠ¶æ€é€šçŸ¥ã€‚ </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<span class="comment">//äº¤æ˜“æˆåŠŸ </span></span><br><span class="line">            System.out.println(trade_status); </span><br><span class="line">            <span class="comment">//åˆ¤æ–­è¯¥ç¬”è®¢å•æ˜¯å¦åœ¨å•†æˆ·ç½‘ç«™ä¸­å·²ç»åšè¿‡å¤„ç† </span></span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰åšè¿‡å¤„ç†ï¼Œæ ¹æ®è®¢å•å·ï¼ˆout_trade_noï¼‰åœ¨å•†æˆ·ç½‘ç«™çš„è®¢å•ç³»ç»Ÿä¸­æŸ¥åˆ°è¯¥ç¬”è®¢å•çš„è¯¦ç»†ï¼Œå¹¶æ‰§è¡Œå•†æˆ·çš„ä¸šåŠ¡ç¨‹åº </span></span><br><span class="line">            <span class="comment">//è¯·åŠ¡å¿…åˆ¤æ–­è¯·æ±‚æ—¶çš„total_feeã€seller_idä¸é€šçŸ¥æ—¶è·å–çš„total_feeã€seller_idä¸ºä¸€è‡´çš„ </span></span><br><span class="line">            <span class="comment">//å¦‚æœæœ‰åšè¿‡å¤„ç†ï¼Œä¸æ‰§è¡Œå•†æˆ·çš„ä¸šåŠ¡ç¨‹åº </span></span><br><span class="line">            <span class="comment">//æ³¨æ„ï¼š </span></span><br><span class="line">            <span class="comment">//å¦‚æœç­¾çº¦çš„æ˜¯å¯é€€æ¬¾åè®®ï¼Œé‚£ä¹ˆä»˜æ¬¾å®Œæˆåï¼Œæ”¯ä»˜å®ç³»ç»Ÿå‘é€è¯¥äº¤æ˜“çŠ¶æ€é€šçŸ¥ã€‚ </span></span><br><span class="line">        &#125; </span><br><span class="line">        response.getWriter().write(<span class="string">&quot;success&quot;</span>); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">        response.getWriter().write(<span class="string">&quot;fail&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>é€šçŸ¥æ¥å£æ¸¬è©¦</p>
<p>1ï¸âƒ£é‡å•Ÿè¨‚å–®æœå‹™ï¼Œä¸¦åœ¨æ¥æ”¶é€šçŸ¥æ¥å£ä¸­æ‰“ä¸Šæ–·é»</p>
<p>2ï¸âƒ£é…ç½®å…§éƒ¨ç¶²è·¯ç©¿é€çš„æœ¬åœ°ç«¯å£ç‚ºè¨‚å–®æœå‹™ç«¯å£ï¼Œå•Ÿå‹•å…§éƒ¨ç¶²è·¯ç©¿é€å®¢æˆ¶ç«¯ã€‚</p>
<p>3ï¸âƒ£æ‰“é–‹æ¨¡æ“¬å™¨ã€æ”¯ä»˜å¯¶æ²™ç®±ï¼Œæƒç¢¼ã€ä»˜æ¬¾ã€‚</p>
<p>4ï¸âƒ£è§€å¯Ÿæ¥æ”¶è¨‚å–®æ”¯ä»˜è³‡æ–™ç­‰æ˜¯å¦æ­£å¸¸ã€‚</p>
<p>é€™é‡ŒæˆåŠŸé€²å…¥åˆ°äº†é€šçŸ¥æ¥å£</p>
<img data-src="/John/img/java/pay/alipay/4.png" class="abc">
<h1 id="ç”Ÿæˆæ”¯ä»˜äºŒç¶­ç¢¼"><a class="markdownIt-Anchor" href="#ç”Ÿæˆæ”¯ä»˜äºŒç¶­ç¢¼">#</a> ç”Ÿæˆæ”¯ä»˜äºŒç¶­ç¢¼</h1>
<h2 id="åŸ·è¡Œæµç¨‹-2"><a class="markdownIt-Anchor" href="#åŸ·è¡Œæµç¨‹-2">#</a> åŸ·è¡Œæµç¨‹</h2>
<p>é»é¸ã€Œæ”¯ä»˜å¯¶æ”¯ä»˜ã€æ­¤æ™‚é–‹å•Ÿæ”¯ä»˜äºŒç¶­ç¢¼ï¼Œç”¨æˆ¶æƒç¢¼æ”¯ä»˜ã€‚</p>
<img data-src="/John/img/java/pay/alipay/5.png" class="abc">
<p>åŸ·è¡Œæµç¨‹ï¼š</p>
<p>1. å‰ç«¯èª¿ç”¨å­¸ç¿’ä¸­å¿ƒæœå‹™çš„æ–°å¢é¸èª²æ¥å£ã€‚</p>
<p>2. æ–°å¢é¸èª²æˆåŠŸè«‹æ±‚è¨‚å–®æœå‹™ç”¢ç”Ÿæ”¯ä»˜äºŒç¶­ç¢¼æ¥å£ã€‚</p>
<p>3. ç”¢ç”ŸäºŒç¶­ç¢¼æ¥å£ï¼šå»ºç«‹å•†å“è¨‚å–®ã€ç”¢ç”Ÿæ”¯ä»˜äº¤æ˜“è¨˜éŒ„ã€ç”¢ç”ŸäºŒç¶­ç¢¼ã€‚</p>
<p>4. å°‡äºŒç¶­ç¢¼è¿”å›å‰ç«¯ï¼Œç”¨æˆ¶æƒç¢¼ã€‚</p>
<p>ä½¿ç”¨è€…æƒç¢¼æ”¯ä»˜æµç¨‹å¦‚ä¸‹ï¼š</p>
<img data-src="/John/img/java/pay/alipay/6.png" class="abc">
<p>1. ç”¨æˆ¶è¼¸å…¥æ”¯ä»˜å¯†ç¢¼ï¼Œä»˜æ¬¾æˆåŠŸã€‚</p>
<p>2ã€æ¥æ”¶ç¬¬ä¸‰æ–¹å¹³å°é€šçŸ¥çš„ä»˜æ¬¾çµæœã€‚</p>
<p>3ã€æ ¹æ“šæ”¯ä»˜çµæœæ›´æ–°æ”¯ä»˜äº¤æ˜“è¨˜éŒ„çš„æ”¯ä»˜ç‹€æ…‹ç‚ºæ”¯ä»˜æˆåŠŸã€‚</p>
<h2 id="æ•¸æ“šæ¨¡å‹"><a class="markdownIt-Anchor" href="#æ•¸æ“šæ¨¡å‹">#</a> æ•¸æ“šæ¨¡å‹</h2>
<p>è¨‚å–®æ”¯ä»˜æ¨¡å¼çš„æ ¸å¿ƒç”±ä¸‰å¼µè¡¨çµ„æˆï¼šè¨‚å–®è¡¨ã€è¨‚å–®æ˜ç´°è¡¨ã€æ”¯ä»˜äº¤æ˜“è¨˜éŒ„è¡¨ã€‚</p>
<img data-src="/John/img/java/pay/alipay/7.png" class="abc">
<p>è¨‚å–®è™Ÿç¢¼æ³¨æ„å”¯ä¸€æ€§ã€å®‰å…¨æ€§ã€ç›¡é‡çŸ­ç­‰ç‰¹é»ï¼Œç”Ÿæˆæ–¹æ¡ˆå¸¸ç”¨çš„å¦‚ä¸‹ï¼š</p>
<p>1. æ™‚é–“æˆ³ + éš¨æ©Ÿæ•¸</p>
<p>å¹´æœˆæ—¥æ™‚åˆ†ç§’æ¯«ç§’ + éš¨æ©Ÿæ•¸</p>
<p>2ã€é«˜ä¸¦ç™¼å ´æ™¯</p>
<p>å¹´æœˆæ—¥æ™‚åˆ†ç§’æ¯«ç§’ + éš¨æ©Ÿæ•¸ + redis è‡ªå¢åºåˆ—</p>
<p>3. è¨‚å–®è™Ÿç¢¼ä¸­åŠ ä¸Šæ¥­å‹™æ¨™è­˜</p>
<p>è¨‚å–®è™Ÿç¢¼åŠ ä¸Šæ¥­å‹™è­˜åˆ¥æ–¹ä¾¿å®¢æœï¼Œä¾‹å¦‚ï¼šç¬¬ 10 ä½æ˜¯æ¥­å‹™é¡å‹ï¼Œç¬¬ 11 ä½æ˜¯ä½¿ç”¨è€…é¡å‹ç­‰ã€‚</p>
<p>4ã€é›ªèŠ±æ¼”ç®—æ³•</p>
<p>é›ªèŠ±æ¼”ç®—æ³•æ˜¯æ¨ç‰¹å…§éƒ¨ä½¿ç”¨çš„åˆ†æ•£å¼ç’°å¢ƒä¸‹çš„å”¯ä¸€ ID ç”Ÿæˆæ¼”ç®—æ³•ï¼Œå®ƒåŸºæ–¼æ™‚é–“æˆ³ç”Ÿæˆï¼Œä¿è­‰æœ‰åºéå¢ï¼ŒåŠ ä»¥å…¥é›»è…¦ç¡¬é«”ç­‰å…ƒç´ ï¼Œå¯ä»¥æ»¿è¶³é«˜ä¸¦ç™¼ç’°å¢ƒä¸‹ ID ä¸é‡è¤‡ã€‚<br>
æœ¬é …ç›®è¨‚å–®ç·¨è™Ÿç”¢ç”Ÿæ¡ç”¨é›ªèŠ±æ¼”ç®—æ³•ã€‚</p>
<p>æœ¬å°ˆæ¡ˆè¨‚å–®è™Ÿç¢¼ç”¢ç”Ÿç­–ç•¥æ¡ç”¨é›ªèŠ±æ¼”ç®—æ³•ï¼Œå°å…¥é»‘é¦¬æä¾›çš„ IdWorkerUtils.java åˆ° base å·¥ç¨‹çš„ utils åŒ…ä¸‹</p>
<h2 id="æ¥å£å®šç¾©"><a class="markdownIt-Anchor" href="#æ¥å£å®šç¾©">#</a> æ¥å£å®šç¾©</h2>
<p>åœ¨è¨‚å–®æœå‹™ä¸­å®šç¾©ç”¢ç”Ÿæ”¯ä»˜äºŒç¶­ç¢¼æ¥å£ã€‚</p>
<p>è«‹æ±‚ï¼šè¨‚å–®è¨Šæ¯</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="meta">@ToString</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddOrderDto</span>  &#123; </span><br><span class="line">    <span class="comment">//æ€»ä»· </span></span><br><span class="line">    <span class="keyword">private</span> Float totalPrice; </span><br><span class="line">    <span class="comment">//è®¢å•ç±»å‹ </span></span><br><span class="line">    <span class="keyword">private</span> String orderType; </span><br><span class="line">    <span class="comment">//è®¢å•åç§° </span></span><br><span class="line">    <span class="keyword">private</span> String orderName; </span><br><span class="line">    <span class="comment">//è®¢å•æè¿° </span></span><br><span class="line">    <span class="keyword">private</span> String orderDescrip; </span><br><span class="line">    <span class="comment">// è®¢å•æ˜ç»†jsonï¼Œä¸å¯ä¸ºç©º </span></span><br><span class="line">    <span class="comment">//[&#123;&quot;goodsId&quot;:&quot;&quot;,&quot;goodsType&quot;:&quot;&quot;,&quot;goodsName&quot;:&quot;&quot;,&quot;goodsPrice&quot;:&quot;&quot;,&quot;goodsDetail&quot;:&quot;&quot;&#125;,&#123;...&#125;] </span></span><br><span class="line">    <span class="keyword">private</span> String orderDetail; </span><br><span class="line">    <span class="comment">//å¤–éƒ¨ç³»ç»Ÿä¸šåŠ¡id </span></span><br><span class="line">    <span class="keyword">private</span> String outBusinessId; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éŸ¿æ‡‰ï¼šæ”¯ä»˜äº¤æ˜“è¨˜éŒ„è³‡è¨ŠåŠäºŒç¶­ç¢¼è¨Šæ¯</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="meta">@ToString</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayRecordDto</span> <span class="keyword">extends</span> <span class="title class_">XcPayRecord</span> &#123; </span><br><span class="line">    <span class="comment">//äºŒç»´ç  </span></span><br><span class="line">    <span class="keyword">private</span> String qrcode; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>æ¥å£å®šç¾©å¦‚ä¸‹</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;è®¢å•æ”¯ä»˜æ¥å£&quot;, tags = &quot;è®¢å•æ”¯ä»˜æ¥å£&quot;)</span> </span><br><span class="line"><span class="meta">@Slf4j</span> </span><br><span class="line"><span class="meta">@Controller</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@ApiOperation(&quot;ç”Ÿæˆæ”¯ä»˜äºŒç»´ç &quot;)</span> </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/generatepaycode&quot;)</span> </span><br><span class="line">    <span class="meta">@ResponseBody</span> </span><br><span class="line">    <span class="keyword">public</span> PayRecordDto <span class="title function_">generatePayCode</span><span class="params">(<span class="meta">@RequestBody</span> AddOrderDto addOrderDto)</span> &#123; </span><br><span class="line">         </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>ç”¨æˆ·æ‰«ç è¯·æ±‚ä¸‹å•ï¼Œå®šä¹‰ä¸‹å•æ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;æ‰«ç ä¸‹å•æ¥å£&quot;)</span> </span><br><span class="line"><span class="meta">@GetMapping(&quot;/requestpay&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestpay</span><span class="params">(String payNo,HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> IOException &#123; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="æ¥å£å¯¦ç¾"><a class="markdownIt-Anchor" href="#æ¥å£å¯¦ç¾">#</a> æ¥å£å¯¦ç¾</h2>
<p>åœ¨å‰é¢çš„åˆ†æä¸­ï¼Œç”¢ç”Ÿæ”¯ä»˜äºŒç¶­ç¢¼æ“ä½œï¼Œå…¶ä¸­åŒ…å«äº†ä¸‰å€‹å°æ“ä½œ<br>
1ï¸âƒ£æ’å…¥è¨‚å–®è¨Šæ¯<br>
2ï¸âƒ£æ’å…¥ä»˜æ¬¾è¨˜éŒ„<br>
3ï¸âƒ£ç”¢ç”ŸäºŒç¶­ç¢¼è¿”å›<br>
ä¸‹é‚Šè¦åšçš„å°±æ˜¯å¯¦ç¾é€™ä¸‰å€‹æ¥å£</p>
<p>å®šç¾©ä¿å­˜è¨‚å–®è³‡è¨Šæ¥å£</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">   <span class="comment">/** </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> åˆ›å»ºå•†å“è®¢å• </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> addOrderDto è®¢å•ä¿¡æ¯ </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> PayRecordDto æ”¯ä»˜äº¤æ˜“è®°å½•(åŒ…æ‹¬äºŒç»´ç ) </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/4 11:02 </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId,AddOrderDto addOrderDto)</span>; </span><br></pre></td></tr></table></figure>
<p>åœ¨ä¿å­˜è¨‚å–®æ¥å£ä¸­éœ€è¦å®Œæˆå»ºç«‹å•†å“è¨‚å–®ã€å»ºç«‹æ”¯ä»˜äº¤æ˜“è¨˜éŒ„ï¼Œæ¥å£å¯¦ä½œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span> </span><br><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123; </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    XcOrdersMapper ordersMapper; </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    XcOrdersGoodsMapper ordersGoodsMapper; </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    XcPayRecordMapper payRecordMapper; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Transactional</span> </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> &#123; </span><br><span class="line"> </span><br><span class="line">        <span class="comment">//æ·»åŠ å•†å“è®¢å• </span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//æ·»åŠ æ”¯ä»˜äº¤æ˜“è®°å½• </span></span><br><span class="line">         </span><br><span class="line">        <span class="comment">//ç”ŸæˆäºŒç»´ç  </span></span><br><span class="line">         </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>ç·¨å¯«å»ºç«‹å•†å“è¨‚å–®æ–¹æ³•ï¼Œå•†å“è¨‚å–®çš„è³‡æ–™ä¾†è‡ªé¸èª²è¨˜éŒ„ï¼Œåœ¨è¨‚å–®è¡¨éœ€è¦å­˜å…¥é¸èª²è¨˜éŒ„çš„ IDï¼Œé€™è£¡éœ€è¦ä½œå¥½å†ªç­‰è™•ç†ã€‚</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> XcOrders <span class="title function_">saveOrders</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. å¹‚ç­‰æ€§åˆ¤æ–­</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">order</span> <span class="operator">=</span> getOrderByBusinessId(addOrderDto.getOutBusinessId());</span><br><span class="line">    <span class="keyword">if</span> (order != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. æ’å…¥è®¢å•è¡¨</span></span><br><span class="line">    order = <span class="keyword">new</span> <span class="title class_">XcOrders</span>();</span><br><span class="line">    BeanUtils.copyProperties(addOrderDto, order);</span><br><span class="line">    order.setId(IdWorkerUtils.getInstance().nextId());</span><br><span class="line">    order.setCreateDate(LocalDateTime.now());</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setStatus(<span class="string">&quot;600001&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcOrdersMapper.insert(order);</span><br><span class="line">    <span class="keyword">if</span> (insert &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;æ’å…¥è®¢å•è®°å½•å¤±è´¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. æ’å…¥è®¢å•æ˜ç»†è¡¨</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> order.getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">orderDetail</span> <span class="operator">=</span> addOrderDto.getOrderDetail();</span><br><span class="line">    List&lt;XcOrdersGoods&gt; xcOrdersGoodsList = JSON.parseArray(orderDetail, XcOrdersGoods.class);</span><br><span class="line">    xcOrdersGoodsList.forEach(goods -&gt; &#123;</span><br><span class="line">        goods.setOrderId(orderId);</span><br><span class="line">        <span class="type">int</span> <span class="variable">insert1</span> <span class="operator">=</span> xcOrdersGoodsMapper.insert(goods);</span><br><span class="line">        <span class="keyword">if</span> (insert1 &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;æ’å…¥è®¢å•æ˜ç»†å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ ¹æ®ä¸šåŠ¡idæŸ¥è¯¢è®¢å• </span></span><br><span class="line"><span class="keyword">public</span> XcOrders <span class="title function_">getOrderByBusinessId</span><span class="params">(String businessId)</span> &#123; </span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">orders</span> <span class="operator">=</span> ordersMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcOrders&gt;().eq(XcOrders::getOutBusinessId, businessId)); </span><br><span class="line">    <span class="keyword">return</span> orders; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å»ºç«‹æ”¯ä»˜äº¤æ˜“è¨˜éŒ„"><a class="markdownIt-Anchor" href="#å»ºç«‹æ”¯ä»˜äº¤æ˜“è¨˜éŒ„">#</a> å»ºç«‹æ”¯ä»˜äº¤æ˜“è¨˜éŒ„</h2>
<p><span class="red">ç‚ºä»€éº¼è¦å‰µå»ºæ”¯ä»˜äº¤æ˜“è¨˜éŒ„ï¼Ÿ</span></p>
<blockquote><p>åœ¨è«‹æ±‚å¾®ä¿¡æˆ–æ”¯ä»˜å¯¶ä¸‹å–®æ¥å£æ™‚éœ€è¦å‚³å…¥å•†å“è¨‚å–®è™Ÿï¼Œåœ¨èˆ‡ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°å°æ¥æ™‚ç™¼ç¾ï¼Œç•¶ç”¨æˆ¶æ”¯ä»˜å¤±æ•—æˆ–å› ç‚ºå…¶å®ƒåŸå› æœ€çµ‚è©²è¨‚å–®æ²’æœ‰æ”¯ä»˜æˆåŠŸï¼Œæ­¤æ™‚å†æ¬¡èª¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°çš„ ä¸‹å–®æ¥å£ç™¼ç¾å ±éŒ¯ â€œè¨‚å–®è™Ÿç¢¼å·²å­˜åœ¨â€ï¼Œæ­¤æ™‚å¦‚æœæˆ‘å€‘å‚³å…¥ä¸€å€‹æ²’æœ‰ä½¿ç”¨éçš„è¨‚å–®è™Ÿç¢¼å°±å¯ä»¥è§£æ±ºå•é¡Œï¼Œä½†æ˜¯å•†å“è¨‚å–®å·²ç¶“å‰µå»ºï¼Œå› ç‚ºæ²’æœ‰æ”¯ä»˜æˆåŠŸé‡æ–°å‰µå»ºä¸€å€‹æ–°è¨‚å–®æ˜¯ä¸åˆç†çš„ã€‚</p>
<p>è§£æ±ºä»¥ä¸Šå•é¡Œçš„æ–¹æ¡ˆæ˜¯ï¼š</p>
<p>1ã€ç”¨æˆ¶æ¯æ¬¡ç™¼èµ·éƒ½å»ºç«‹ä¸€å€‹æ–°çš„æ”¯ä»˜äº¤æ˜“è¨˜éŒ„ ï¼Œæ­¤äº¤æ˜“è¨˜éŒ„èˆ‡å•†å“è¨‚å–®é—œè¯ã€‚</p>
<p>2ã€å°‡æ”¯ä»˜äº¤æ˜“è¨˜éŒ„çš„æµæ°´è™Ÿå‚³çµ¦ç¬¬ä¸‰æ–¹æ”¯ä»˜ç³»çµ±ä¸‹å–®æ¥å£ï¼Œé€™æ¨£å°±å³ä½¿æ²’æœ‰æ”¯ä»˜æˆåŠŸå°±ä¸æœƒå‡ºç¾ä¸Šé‚Šçš„å•é¡Œã€‚</p>
<p>3ã€éœ€è¦æé†’ç”¨æˆ¶ä¸è¦é‡è¤‡ä»˜æ¬¾ã€‚</p>
</blockquote>
<p>ç·¨å¯«å»ºç«‹æ”¯ä»˜äº¤æ˜“è¨˜éŒ„çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">createPayRecord</span><span class="params">(XcOrders orders)</span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(order==<span class="literal">null</span>)&#123; </span><br><span class="line">       XueChengPlusException.cast(<span class="string">&quot;è®¢å•ä¸å­˜åœ¨&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span>(orders.getStatus().equals(<span class="string">&quot;600002&quot;</span>))&#123; </span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;è®¢å•å·²æ”¯ä»˜&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcPayRecord</span>(); </span><br><span class="line">    <span class="comment">//ç”Ÿæˆæ”¯ä»˜äº¤æ˜“æµæ°´å· </span></span><br><span class="line">    <span class="type">long</span> <span class="variable">payNo</span> <span class="operator">=</span> IdWorkerUtils.getInstance().nextId(); </span><br><span class="line">    payRecord.setPayNo(payNo); </span><br><span class="line">    payRecord.setOrderId(orders.getId());<span class="comment">//å•†å“è®¢å•å· </span></span><br><span class="line">    payRecord.setOrderName(orders.getOrderName()); </span><br><span class="line">    payRecord.setTotalPrice(orders.getTotalPrice()); </span><br><span class="line">    payRecord.setCurrency(<span class="string">&quot;CNY&quot;</span>); </span><br><span class="line">    payRecord.setCreateDate(LocalDateTime.now()); </span><br><span class="line">    payRecord.setStatus(<span class="string">&quot;601001&quot;</span>);<span class="comment">//æœªæ”¯ä»˜ </span></span><br><span class="line">    payRecord.setUserId(orders.getUserId()); </span><br><span class="line">    payRecordMapper.insert(payRecord); </span><br><span class="line">    <span class="keyword">return</span> payRecord; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="ç”¢æˆæ”¯ä»˜äºŒç¶­ç¢¼"><a class="markdownIt-Anchor" href="#ç”¢æˆæ”¯ä»˜äºŒç¶­ç¢¼">#</a> ç”¢æˆæ”¯ä»˜äºŒç¶­ç¢¼</h2>
<p>1ã€åœ¨ nacos ä¸­ orders-service-dev.yaml é…ç½®äºŒç¶­ç¢¼çš„ url</p>
<figure class="highlight yaml"><figcaption><span>YAML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pay:</span> </span><br><span class="line"> <span class="attr">qrcodeurl:</span> <span class="string">http://192.168.101.1/api/orders/requestpay?payNo=%s</span> </span><br></pre></td></tr></table></figure>
<p>2ã€ç”¨ format æ‹¼æ¥æ”¯ä»˜ URL, å®Œå–„å»ºç«‹è¨‚å–® service æ–¹æ³•:</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;pay.qrcodeurl&#125;&quot;)</span> </span><br><span class="line">String qrcodeurl; </span><br><span class="line"> </span><br><span class="line"><span class="meta">@Transactional</span> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> &#123; </span><br><span class="line">    <span class="comment">//åˆ›å»ºå•†å“è®¢å• </span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">orders</span> <span class="operator">=</span> saveXcOrders(userId, addOrderDto); </span><br><span class="line">    <span class="keyword">if</span>(orders==<span class="literal">null</span>)&#123; </span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;è®¢å•åˆ›å»ºå¤±è´¥&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span>(orders.getStatus().equals(<span class="string">&quot;600002&quot;</span>))&#123; </span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;è®¢å•å·²æ”¯ä»˜&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//ç”Ÿæˆæ”¯ä»˜è®°å½• </span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> createPayRecord(orders); </span><br><span class="line">    <span class="comment">//ç”ŸæˆäºŒç»´ç  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">qrCode</span> <span class="operator">=</span> <span class="literal">null</span>; </span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">        <span class="comment">//urlè¦å¯ä»¥è¢«æ¨¡æ‹Ÿå™¨è®¿é—®åˆ°ï¼Œurlä¸ºä¸‹å•æ¥å£(ç¨åå®šä¹‰) </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> String.format(qrcodeurl, payRecord.getPayNo()); </span><br><span class="line">        qrCode = <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>().createQRCode(url, <span class="number">200</span>, <span class="number">200</span>); </span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123; </span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;ç”ŸæˆäºŒç»´ç å‡ºé”™&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>(); </span><br><span class="line">    BeanUtils.copyProperties(payRecord,payRecordDto); </span><br><span class="line">    payRecordDto.setQrcode(qrCode); </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> payRecordDto; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="ç”ŸæˆäºŒç¶­ç¢¼æ¥å£å®Œå–„"><a class="markdownIt-Anchor" href="#ç”ŸæˆäºŒç¶­ç¢¼æ¥å£å®Œå–„">#</a> ç”ŸæˆäºŒç¶­ç¢¼æ¥å£å®Œå–„</h2>
<p>å®Œå–„ç”Ÿæˆæ”¯ä»˜äºŒç»´ç  controller æ¥å£</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span> </span><br><span class="line">OrderService orderService; </span><br><span class="line">     </span><br><span class="line"><span class="meta">@ApiOperation(&quot;ç”Ÿæˆæ”¯ä»˜äºŒç»´ç &quot;)</span> </span><br><span class="line"><span class="meta">@PostMapping(&quot;/generatepaycode&quot;)</span> </span><br><span class="line"><span class="meta">@ResponseBody</span> </span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">generatePayCode</span><span class="params">(<span class="meta">@RequestBody</span> AddOrderDto addOrderDto)</span> &#123; </span><br><span class="line">    <span class="comment">//ç™»å½•ç”¨æˆ· </span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser(); </span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123; </span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;è¯·ç™»å½•åç»§ç»­é€‰è¯¾&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">   <span class="keyword">return</span> orderService.createOrder(user.getId(), addOrderDto); </span><br><span class="line">    </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>æˆäº†æ”¯ä»˜äºŒç¶­ç¢¼ï¼Œç”¨æˆ¶æƒç¢¼è«‹æ±‚ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°ä¸‹å–®ã€ä»˜æ¬¾ã€‚</p>
<p>1. å®šç¾©æŸ¥è©¢æ”¯ä»˜äº¤æ˜“è¨˜éŒ„çš„ Service æ¥å£èˆ‡å¯¦ä½œæ–¹æ³•</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">getPayRecordByPayno</span><span class="params">(String payNo)</span>; </span><br></pre></td></tr></table></figure>
<p>å¯¦ç¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">getPayRecordByPayno</span><span class="params">(String payNo)</span> &#123; </span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">xcPayRecord</span> <span class="operator">=</span> payRecordMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcPayRecord&gt;().eq(XcPayRecord::getPayNo, payNo)); </span><br><span class="line">    <span class="keyword">return</span> xcPayRecord; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>2 å®šç¾©ä¸‹å–®æ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span> </span><br><span class="line">String APP_ID; </span><br><span class="line"><span class="meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span> </span><br><span class="line">String APP_PRIVATE_KEY; </span><br><span class="line"> </span><br><span class="line"><span class="meta">@Value(&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;)</span> </span><br><span class="line">String ALIPAY_PUBLIC_KEY; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@ApiOperation(&quot;æ‰«ç ä¸‹å•æ¥å£&quot;)</span> </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/requestpay&quot;)</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestpay</span><span class="params">(String payNo,HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> IOException &#123; </span><br><span class="line">        <span class="comment">//å¦‚æœpayNoä¸å­˜åœ¨åˆ™æç¤ºé‡æ–°å‘èµ·æ”¯ä»˜ </span></span><br><span class="line">        <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> orderService.getPayRecordByPayno(payNo); </span><br><span class="line">        <span class="keyword">if</span>(payRecord == <span class="literal">null</span>)&#123; </span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;è¯·é‡æ–°ç‚¹å‡»æ”¯ä»˜è·å–äºŒç»´ç &quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//æ”¯ä»˜çŠ¶æ€ </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> payRecord.getStatus(); </span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;601002&quot;</span>.equals(status))&#123; </span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;è®¢å•å·²æ”¯ä»˜ï¼Œè¯·å‹¿é‡å¤æ”¯ä»˜ã€‚&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//æ„é€ sdkçš„å®¢æˆ·ç«¯å¯¹è±¡ </span></span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);<span class="comment">//è·å¾—åˆå§‹åŒ–çš„AlipayClient </span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//åˆ›å»ºAPIå¯¹åº”çš„request </span></span><br><span class="line"><span class="comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;); </span></span><br><span class="line"><span class="comment">//        alipayRequest.setNotifyUrl(&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;);//åœ¨å…¬å…±å‚æ•°ä¸­è®¾ç½®å›è·³å’Œé€šçŸ¥åœ°å€ </span></span><br><span class="line">        alipayRequest.setBizContent(<span class="string">&quot;&#123;&quot;</span> + </span><br><span class="line">                <span class="string">&quot; \&quot;out_trade_no\&quot;:\&quot;&quot;</span>+payRecord.getPayNo()+<span class="string">&quot;\&quot;,&quot;</span> + </span><br><span class="line">                <span class="string">&quot; \&quot;total_amount\&quot;:\&quot;&quot;</span>+payRecord.getTotalPrice()+<span class="string">&quot;\&quot;,&quot;</span> + </span><br><span class="line">                <span class="string">&quot; \&quot;subject\&quot;:\&quot;&quot;</span>+payRecord.getOrderName()+<span class="string">&quot;\&quot;,&quot;</span> + </span><br><span class="line">                <span class="string">&quot; \&quot;product_code\&quot;:\&quot;QUICK_WAP_PAY\&quot;&quot;</span> + </span><br><span class="line">                <span class="string">&quot; &#125;&quot;</span>);<span class="comment">//å¡«å……ä¸šåŠ¡å‚æ•° </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>; </span><br><span class="line">        <span class="keyword">try</span> &#123; </span><br><span class="line">            <span class="comment">//è¯·æ±‚æ”¯ä»˜å®ä¸‹å•æ¥å£,å‘èµ·httpè¯·æ±‚ </span></span><br><span class="line">            form = client.pageExecute(alipayRequest).getBody(); <span class="comment">//è°ƒç”¨SDKç”Ÿæˆè¡¨å• </span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (AlipayApiException e) &#123; </span><br><span class="line">            e.printStackTrace(); </span><br><span class="line">        &#125; </span><br><span class="line">        httpResponse.setContentType(<span class="string">&quot;text/html;charset=&quot;</span> + AlipayConfig.CHARSET); </span><br><span class="line">        httpResponse.getWriter().write(form);<span class="comment">//ç›´æ¥å°†å®Œæ•´çš„è¡¨å•htmlè¾“å‡ºåˆ°é¡µé¢ </span></span><br><span class="line">        httpResponse.getWriter().flush(); </span><br><span class="line">        httpResponse.getWriter().close(); </span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>
<p>æ”¯ä»˜æ¸¬è©¦<br>
æ¸¬è©¦æº–å‚™ï¼š</p>
<p>1ã€å•Ÿå‹•ç¶²é—œæœå‹™ã€èªè­‰æœå‹™ã€é©—è­‰ç¢¼æœå‹™ã€å­¸ç¿’ä¸­å¿ƒæœå‹™ã€è¨‚å–®æœå‹™ã€å…§å®¹ç®¡ç†æœå‹™ã€‚</p>
<p>2ã€ç™¼å¸ƒä¸€é–€æ”¶è²»èª²ç¨‹ã€‚</p>
<p>3. ä½¿ç”¨è³‡æ–™ç›®éŒ„ä¸­çš„æ–°æ¨¡æ¿ course_template.ftl</p>
<p>æ¸¬è©¦æµç¨‹ï¼š</p>
<p>1. é€²å…¥æ”¶è²»èª²ç¨‹è©³ç´°é é¢ï¼Œé»é¸é¦¬ä¸Šå­¸ç¿’ã€‚</p>
<p>2. è¿½è¹¤ç€è¦½å™¨åŠå¾®æœå‹™ï¼Œè§€å¯Ÿé¸èª²è¨˜éŒ„æ˜¯å¦å‰µå»ºæˆåŠŸã€å•†å“è¨‚å–®æ˜¯å¦å‰µå»ºæˆåŠŸã€æ”¯ä»˜äº¤æ˜“è¨˜éŒ„æ˜¯å¦å‰µå»ºæˆåŠŸã€‚</p>
<p>3. è§€å¯Ÿç”¢ç”ŸäºŒç¶­ç¢¼æ˜¯å¦æˆåŠŸ</p>
<p>4. ä½¿ç”¨æ¨¡æ“¬å™¨æƒç¢¼æ¸¬è©¦ï¼Œæ˜¯å¦å¯ä»¥æ­£å¸¸ä»˜æ¬¾ã€‚</p>
<h2 id="æŸ¥è©¢ä»˜æ¬¾çµæœ"><a class="markdownIt-Anchor" href="#æŸ¥è©¢ä»˜æ¬¾çµæœ">#</a> æŸ¥è©¢ä»˜æ¬¾çµæœ</h2>
<p>æ¥å£å®šä¹‰:</p>
<p>æ ¹æ“šå‰é‚Šæˆ‘å€‘èª¿æŸ¥çš„ç²å–æ”¯ä»˜çµæœçš„æ¥å£ï¼ŒåŒ…æ‹¬ï¼šä¸»å‹•æŸ¥è©¢æ”¯ä»˜çµæœã€è¢«å‹•æ¥æ”¶æ”¯ä»˜çµæœã€‚<br>
é€™è£¡å…ˆå¯¦ç¾ä¸»å‹•æŸ¥è©¢æ”¯ä»˜çµæœï¼Œç•¶æ”¯ä»˜å®Œæˆç”¨æˆ¶é»æ“Šã€Œæ”¯ä»˜çµæœã€å°‡è«‹æ±‚ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°æŸ¥è©¢æ”¯ä»˜çµæœã€‚<br>
åœ¨ OrderController é¡åˆ¥ä¸­å®šç¾©æ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;æŸ¥è¯¢æ”¯ä»˜ç»“æœ&quot;)</span> </span><br><span class="line"><span class="meta">@GetMapping(&quot;/payresult&quot;)</span> </span><br><span class="line"><span class="meta">@ResponseBody</span> </span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">payresult</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> IOException &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//æŸ¥è¯¢æ”¯ä»˜ç»“æœ </span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>1ã€å®šç¾©æŸ¥è©¢æ”¯ä»˜çµæœçš„ service</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * è¯·æ±‚æ”¯ä»˜å®æŸ¥è¯¢æ”¯ä»˜ç»“æœ </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo æ”¯ä»˜è®°å½•id </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ”¯ä»˜è®°å½•ä¿¡æ¯ </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">queryPayResult</span><span class="params">(String payNo)</span>; </span><br></pre></td></tr></table></figure>
<p>2ã€service å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">queryPayResult</span><span class="params">(String payNo)</span>&#123; </span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> getPayRecordByPayno(payNo); </span><br><span class="line">    <span class="keyword">if</span> (payRecord == <span class="literal">null</span>) &#123; </span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;è¯·é‡æ–°ç‚¹å‡»æ”¯ä»˜è·å–äºŒç»´ç &quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜çŠ¶æ€ </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> payRecord.getStatus(); </span><br><span class="line">    <span class="comment">//å¦‚æœæ”¯ä»˜æˆåŠŸç›´æ¥è¿”å› </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;601002&quot;</span>.equals(status)) &#123; </span><br><span class="line">        <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>(); </span><br><span class="line">        BeanUtils.copyProperties(payRecord, payRecordDto); </span><br><span class="line">        <span class="keyword">return</span> payRecordDto; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//ä»æ”¯ä»˜å®æŸ¥è¯¢æ”¯ä»˜ç»“æœ </span></span><br><span class="line">    <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> queryPayResultFromAlipay(payNo); </span><br><span class="line">    <span class="comment">//ä¿å­˜æ”¯ä»˜ç»“æœ </span></span><br><span class="line">    currentProxy.saveAliPayStatus( payStatusDto); </span><br><span class="line">    <span class="comment">//é‡æ–°æŸ¥è¯¢æ”¯ä»˜è®°å½• </span></span><br><span class="line">    payRecord = getPayRecordByPayno(payNo); </span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>(); </span><br><span class="line">    BeanUtils.copyProperties(payRecord, payRecordDto); </span><br><span class="line">    <span class="keyword">return</span> payRecordDto; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ä»æ”¯ä»˜å®æŸ¥è¯¢æ”¯ä»˜ç»“æœçš„æ–¹æ³•</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PayStatusDto <span class="title function_">queryPayResultFromAlipay</span><span class="params">(String payNo)</span> &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//========è¯·æ±‚æ”¯ä»˜å®æŸ¥è¯¢æ”¯ä»˜ç»“æœ============= </span></span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, <span class="string">&quot;json&quot;</span>, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE); <span class="comment">//è·å¾—åˆå§‹åŒ–çš„AlipayClient </span></span><br><span class="line">    <span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>(); </span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(); </span><br><span class="line">    bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, payNo); </span><br><span class="line">    request.setBizContent(bizContent.toString()); </span><br><span class="line">    <span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>; </span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">        response = alipayClient.execute(request); </span><br><span class="line">        <span class="keyword">if</span> (!response.isSuccess()) &#123; </span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;è¯·æ±‚æ”¯ä»˜æŸ¥è¯¢æŸ¥è¯¢å¤±è´¥&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">catch</span> (AlipayApiException e) &#123; </span><br><span class="line">        log.error(<span class="string">&quot;è¯·æ±‚æ”¯ä»˜å®æŸ¥è¯¢æ”¯ä»˜ç»“æœå¼‚å¸¸:&#123;&#125;&quot;</span>, e.toString(), e); </span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;è¯·æ±‚æ”¯ä»˜æŸ¥è¯¢æŸ¥è¯¢å¤±è´¥&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//è·å–æ”¯ä»˜ç»“æœ </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> response.getBody(); </span><br><span class="line">    <span class="comment">//è½¬map </span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> JSON.parseObject(resultJson, Map.class); </span><br><span class="line">    <span class="type">Map</span> <span class="variable">alipay_trade_query_response</span> <span class="operator">=</span> (Map) resultMap.get(<span class="string">&quot;alipay_trade_query_response&quot;</span>); </span><br><span class="line">    <span class="comment">//æ”¯ä»˜ç»“æœ </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">&quot;trade_status&quot;</span>); </span><br><span class="line">    <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">&quot;total_amount&quot;</span>); </span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">&quot;trade_no&quot;</span>); </span><br><span class="line">    <span class="comment">//ä¿å­˜æ”¯ä»˜ç»“æœ </span></span><br><span class="line">    <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayStatusDto</span>(); </span><br><span class="line">    payStatusDto.setOut_trade_no(payNo); </span><br><span class="line">    payStatusDto.setTrade_status(trade_status); </span><br><span class="line">    payStatusDto.setApp_id(APP_ID); </span><br><span class="line">    payStatusDto.setTrade_no(trade_no); </span><br><span class="line">    payStatusDto.setTotal_amount(total_amount); </span><br><span class="line">    <span class="keyword">return</span> payStatusDto; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>1ã€å®šä¹‰ä¿å­˜æ”¯ä»˜ç»“æœçš„æ¥å£</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span> ;</span><br></pre></td></tr></table></figure>
<p>2ã€ç¼–å†™æ¥å£å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span> &#123; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜æµæ°´å· </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">payNo</span> <span class="operator">=</span> payStatusDto.getOut_trade_no(); </span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> getPayRecordByPayno(payNo); </span><br><span class="line">    <span class="keyword">if</span> (payRecord == <span class="literal">null</span>) &#123; </span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;æ”¯ä»˜è®°å½•æ‰¾ä¸åˆ°&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜ç»“æœ </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> payStatusDto.getTrade_status(); </span><br><span class="line">    log.debug(<span class="string">&quot;æ”¶åˆ°æ”¯ä»˜ç»“æœ:&#123;&#125;,æ”¯ä»˜è®°å½•:&#123;&#125;&#125;&quot;</span>, payStatusDto.toString(),payRecord.toString()); </span><br><span class="line">    <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>)) &#123; </span><br><span class="line"> </span><br><span class="line">        <span class="comment">//æ”¯ä»˜é‡‘é¢å˜ä¸ºåˆ† </span></span><br><span class="line">        <span class="type">Float</span> <span class="variable">totalPrice</span> <span class="operator">=</span> payRecord.getTotalPrice() * <span class="number">100</span>; </span><br><span class="line">        <span class="type">Float</span> <span class="variable">total_amount</span> <span class="operator">=</span> Float.parseFloat(payStatusDto.getTotal_amount()) * <span class="number">100</span>; </span><br><span class="line">        <span class="comment">//æ ¡éªŒæ˜¯å¦ä¸€è‡´ </span></span><br><span class="line">        <span class="keyword">if</span> (!payStatusDto.getApp_id().equals(APP_ID) || totalPrice.intValue() != total_amount.intValue()) &#123; </span><br><span class="line">            <span class="comment">//æ ¡éªŒå¤±è´¥ </span></span><br><span class="line">            log.info(<span class="string">&quot;æ ¡éªŒæ”¯ä»˜ç»“æœå¤±è´¥,æ”¯ä»˜è®°å½•:&#123;&#125;,APP_ID:&#123;&#125;,totalPrice:&#123;&#125;&quot;</span> ,payRecord.toString(),payStatusDto.getApp_id(),total_amount.intValue()); </span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;æ ¡éªŒæ”¯ä»˜ç»“æœå¤±è´¥&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        log.debug(<span class="string">&quot;æ›´æ–°æ”¯ä»˜ç»“æœ,æ”¯ä»˜äº¤æ˜“æµæ°´å·:&#123;&#125;,æ”¯ä»˜ç»“æœ:&#123;&#125;&quot;</span>, payNo, trade_status); </span><br><span class="line">        <span class="type">XcPayRecord</span> <span class="variable">payRecord_u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcPayRecord</span>(); </span><br><span class="line">        payRecord_u.setStatus(<span class="string">&quot;601002&quot;</span>);<span class="comment">//æ”¯ä»˜æˆåŠŸ </span></span><br><span class="line">        payRecord_u.setOutPayChannel(<span class="string">&quot;Alipay&quot;</span>); </span><br><span class="line">        payRecord_u.setOutPayNo(payStatusDto.getTrade_no());<span class="comment">//æ”¯ä»˜å®äº¤æ˜“å· </span></span><br><span class="line">        payRecord_u.setPaySuccessTime(LocalDateTime.now());<span class="comment">//é€šçŸ¥æ—¶é—´ </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">update1</span> <span class="operator">=</span> payRecordMapper.update(payRecord_u, <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcPayRecord&gt;().eq(XcPayRecord::getPayNo, payNo)); </span><br><span class="line">        <span class="keyword">if</span> (update1 &gt; <span class="number">0</span>) &#123; </span><br><span class="line">            log.info(<span class="string">&quot;æ›´æ–°æ”¯ä»˜è®°å½•çŠ¶æ€æˆåŠŸ:&#123;&#125;&quot;</span>, payRecord_u.toString()); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            log.info(<span class="string">&quot;æ›´æ–°æ”¯ä»˜è®°å½•çŠ¶æ€å¤±è´¥:&#123;&#125;&quot;</span>, payRecord_u.toString()); </span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;æ›´æ–°æ”¯ä»˜è®°å½•çŠ¶æ€å¤±è´¥&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//å…³è”çš„è®¢å•å· </span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> payRecord.getOrderId(); </span><br><span class="line">        <span class="type">XcOrders</span> <span class="variable">orders</span> <span class="operator">=</span> ordersMapper.selectById(orderId); </span><br><span class="line">        <span class="keyword">if</span> (orders == <span class="literal">null</span>) &#123; </span><br><span class="line">            log.info(<span class="string">&quot;æ ¹æ®æ”¯ä»˜è®°å½•[&#123;&#125;&#125;]æ‰¾ä¸åˆ°è®¢å•&quot;</span>, payRecord_u.toString()); </span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;æ ¹æ®æ”¯ä»˜è®°å½•æ‰¾ä¸åˆ°è®¢å•&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="type">XcOrders</span> <span class="variable">order_u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcOrders</span>(); </span><br><span class="line">        order_u.setStatus(<span class="string">&quot;600002&quot;</span>);<span class="comment">//æ”¯ä»˜æˆåŠŸ </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> ordersMapper.update(order_u, <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcOrders&gt;().eq(XcOrders::getId, orderId)); </span><br><span class="line">        <span class="keyword">if</span> (update &gt; <span class="number">0</span>) &#123; </span><br><span class="line">            log.info(<span class="string">&quot;æ›´æ–°è®¢å•è¡¨çŠ¶æ€æˆåŠŸ,è®¢å•å·:&#123;&#125;&quot;</span>, orderId); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            log.info(<span class="string">&quot;æ›´æ–°è®¢å•è¡¨çŠ¶æ€å¤±è´¥,è®¢å•å·:&#123;&#125;&quot;</span>, orderId); </span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;æ›´æ–°è®¢å•è¡¨çŠ¶æ€å¤±è´¥&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h1 id="æ¥å£æ¸¬è©¦-2"><a class="markdownIt-Anchor" href="#æ¥å£æ¸¬è©¦-2">#</a> æ¥å£æ¸¬è©¦</h1>
<p>1ã€å®Œå–„æ¥å£</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;æŸ¥è¯¢æ”¯ä»˜ç»“æœ&quot;)</span> </span><br><span class="line"><span class="meta">@GetMapping(&quot;/payresult&quot;)</span> </span><br><span class="line"><span class="meta">@ResponseBody</span> </span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">payresult</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> IOException &#123; </span><br><span class="line">    <span class="comment">//è°ƒç”¨æ”¯ä»˜å®æ¥å£æŸ¥è¯¢ </span></span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> orderService.queryPayResult(payNo); </span><br><span class="line">    <span class="keyword">return</span> payRecordDto; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>å°å…¥é»‘é¦¬æä¾›çš„ LocalDateTimeConfig.java åˆ° base å·¥ç¨‹çš„ config åŒ…ä¸‹ï¼Œç”¨æ–¼è™•ç†å‰ç«¯ Long ç²¾åº¦éºå¤±çš„å•é¡Œï¼Œç„¶å¾Œä½¿ç”¨å‰å¾Œç«¯è¯èª¿</p>
<h2 id="æ¥æ”¶æ”¯ä»˜é€šçŸ¥"><a class="markdownIt-Anchor" href="#æ¥æ”¶æ”¯ä»˜é€šçŸ¥">#</a> æ¥æ”¶æ”¯ä»˜é€šçŸ¥</h2>
<p>æ¥å£å®šä¹‰<br>
æ”¯ä»˜å®Œæˆåç¬¬ä¸‰æ–¹æ”¯ä»˜ç³»ç»Ÿä¼šä¸»åŠ¨é€šçŸ¥æ”¯ä»˜ç»“æœï¼Œè¦å®ç°ä¸»åŠ¨é€šçŸ¥éœ€è¦åœ¨è¯·æ±‚æ”¯ä»˜ç³»ç»Ÿä¸‹å•æ—¶ä¼ å…¥ NotifyUrlï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ª urlï¼šNotifyUrl å’Œ ReturnUrlï¼ŒReturnUrl æ˜¯æ”¯ä»˜å®Œæˆåæ”¯ä»˜ç³»ç»Ÿæºå¸¦æ”¯ä»˜ç»“æœé‡å®šå‘åˆ° ReturnUrl åœ°å€ï¼ŒNotifyUrl æ˜¯æ”¯ä»˜å®Œæˆåæ”¯ä»˜ç³»ç»Ÿåœ¨åå°å®šæ—¶å»é€šçŸ¥ï¼Œä½¿ç”¨ NotifyUrl æ¯”ä½¿ç”¨ ReturnUrl æœ‰ä¿è¯ã€‚</p>
<p>æ ¹æ®æ¥å£æè¿°ï¼š<span class="exturl" data-url="aHR0cHM6Ly9vcGVuZG9jcy5hbGlwYXkuY29tL29wZW4vMjAzLzEwNTI4NiVFNyU5QSU4NCVFNSU4NiU4NSVFNSVBRSVCOSVFNCVCOCU4QiVFOCVCRSVCOSVFNSU5QyVBOCVFOCVBRSVBMiVFNSU4RCU5NSVFNiU5QyU4RCVFNSU4QSVBMSVFNSVBRSU5QSVFNCVCOSU4OSVFNiU4RSVBNSVFNiU5NCVCNiVFNiU5NCVBRiVFNCVCQiU5OCVFNyVCQiU5MyVFNiU5RSU5QyVFOSU4MCU5QSVFNyU5RiVBNSVFNyU5QSU4NCVFNiU4RSVBNSVFNSU4RiVBMyVFMyU4MCU4Mg==">https://opendocs.alipay.com/open/203/105286 çš„å†…å®¹ä¸‹è¾¹åœ¨è®¢å•æœåŠ¡å®šä¹‰æ¥æ”¶æ”¯ä»˜ç»“æœé€šçŸ¥çš„æ¥å£ã€‚</span></p>
<p>é¦–å…ˆåœ¨ä¸‹å•æ—¶æŒ‡å®š NotifyUrl:</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alipayRequest.setNotifyUrl(<span class="string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/receivenotify&quot;</span>); </span><br></pre></td></tr></table></figure>
<p>æ¥æ”¶æ”¯ä»˜ç»“æœé€šçŸ¥æ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;æ¥æ”¶æ”¯ä»˜ç»“æœé€šçŸ¥&quot;)</span> </span><br><span class="line"><span class="meta">@PostMapping(&quot;/receivenotify&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receivenotify</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> UnsupportedEncodingException, AlipayApiException &#123; </span><br><span class="line">    Map&lt;String,String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;(); </span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap(); </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext();) &#123; </span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next(); </span><br><span class="line">        String[] values = (String[]) requestParams.get(name); </span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>; </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123; </span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i] </span><br><span class="line">                    : valueStr + values[i] + <span class="string">&quot;,&quot;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        params.put(name, valueStr); </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//éªŒç­¾ </span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">&quot;RSA2&quot;</span>);  </span><br><span class="line">    <span class="keyword">if</span>(verify_result) &#123;<span class="comment">//éªŒè¯æˆåŠŸ </span></span><br><span class="line">        <span class="comment">//å•†æˆ·è®¢å•å· </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;out_trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>); </span><br><span class="line">        <span class="comment">//æ”¯ä»˜å®äº¤æ˜“å· </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>); </span><br><span class="line">        <span class="comment">//äº¤æ˜“çŠ¶æ€ </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_status&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>); </span><br><span class="line">        <span class="comment">//appid </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">app_id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;app_id&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>); </span><br><span class="line">        <span class="comment">//total_amount </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;total_amount&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);  </span><br><span class="line">        <span class="comment">//äº¤æ˜“æˆåŠŸå¤„ç† </span></span><br><span class="line">        <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>)) &#123; </span><br><span class="line"> </span><br><span class="line">            <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayStatusDto</span>(); </span><br><span class="line">            payStatusDto.setOut_trade_no(out_trade_no); </span><br><span class="line">            payStatusDto.setTrade_status(trade_status); </span><br><span class="line">            payStatusDto.setApp_id(app_id); </span><br><span class="line">            payStatusDto.setTrade_no(trade_no); </span><br><span class="line">            payStatusDto.setTotal_amount(total_amount); </span><br><span class="line">           <span class="comment">//å¤„ç†é€»è¾‘ã€‚ã€‚ã€‚ </span></span><br><span class="line">            orderService.saveAliPayStatus(payStatusDto); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>æ¥å£æµ‹è¯•:</p>
<p>1ã€å¯åŠ¨ç½‘å…³æœåŠ¡ã€è®¤è¯æœåŠ¡ã€éªŒè¯ç æœåŠ¡ã€å­¦ä¹ ä¸­å¿ƒæœåŠ¡ã€å†…å®¹ç®¡ç†æœåŠ¡ã€‚</p>
<p>2ã€å‘å¸ƒä¸€é—¨æ”¶è´¹è¯¾ç¨‹ã€‚</p>
<p>æµ‹è¯•æµç¨‹ï¼š</p>
<p>1ã€å¯¹é€‰è¯¾è¿›è¡Œæ”¯ä»˜</p>
<p>2ã€æ”¯ä»˜æˆåŠŸè·Ÿè¸ª service æ–¹æ³•çš„æ—¥å¿—ï¼Œæ”¯ä»˜æˆåŠŸéœ€è¦æ›´æ–°æ”¯ä»˜äº¤æ˜“è¡¨è®°å½•çš„çŠ¶æ€ã€é€šçŸ¥æ—¶é—´ã€æ”¯ä»˜å®äº¤æ˜“å·ã€æ”¯ä»˜æ¸ é“ (Alipay)</p>
<p>æ”¯ä»˜æˆåŠŸæ›´æ–°è®¢å•è¡¨çš„çŠ¶æ€ä¸ºç©ºã€‚</p>
<h1 id="æ”¯ä»˜é€šçŸ¥"><a class="markdownIt-Anchor" href="#æ”¯ä»˜é€šçŸ¥">#</a> æ”¯ä»˜é€šçŸ¥</h1>
<p>è¨‚å–®æœå‹™ä½œç‚ºé€šç”¨æœå‹™åœ¨è¨‚å–®æ”¯ä»˜æˆåŠŸå¾Œéœ€è¦å°‡æ”¯ä»˜çµæœéåŒæ­¥é€šçŸ¥çµ¦å…¶å®ƒå¾®æœå‹™ã€‚<br>
ä¸‹åœ–ä½¿ç”¨äº†è¨Šæ¯éšŠåˆ—å®Œæˆæ”¯ä»˜çµæœé€šçŸ¥ï¼š</p>
<img data-src="/John/img/java/pay/alipay/8.png" class="abc">
<p>å­¸ç¿’ä¸­å¿ƒæœå‹™ï¼šæ”¶è²»èª²ç¨‹é¸èª²éœ€æ”¯ä»˜ï¼Œèˆ‡è¨‚å–®æœå‹™å°æ¥å®Œæˆæ”¯ä»˜ã€‚</p>
<p>å­¸ç¿’è³‡æºæœå‹™ï¼šæ”¶è²»çš„å­¸ç¿’è³‡æ–™éœ€è¦è³¼è²·å¾Œä¸‹è¼‰ï¼Œèˆ‡è¨‚å–®æœå‹™å°æ¥å®Œæˆä»˜æ¬¾ã€‚</p>
<p>è¨‚å–®æœå‹™å®Œæˆä»˜æ¬¾å¾Œå°‡ä»˜æ¬¾çµæœç™¼çµ¦æ¯ä¸€å€‹èˆ‡è¨‚å–®æœå‹™å°æ¥çš„å¾®æœå‹™ï¼Œè¨‚å–®æœå‹™å°‡è¨Šæ¯ç™¼çµ¦äº¤æ›æ©Ÿï¼Œç”±äº¤æ›æ©Ÿå»£æ’­è¨Šæ¯ï¼Œæ¯å€‹è¨‚é–±è¨Šæ¯çš„å¾®æœå‹™éƒ½å¯ä»¥æ¥æ”¶åˆ°æ”¯ä»˜çµæœ.</p>
<p>å¾®æœå‹™æ”¶åˆ°ä»˜æ¬¾çµæœæœƒæ ¹æ“šè¨‚å–®çš„é¡å‹å»æ›´æ–°è‡ªå·±çš„æ¥­å‹™è³‡æ–™ã€‚</p>
<h2 id="æŠ€æœ¯æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#æŠ€æœ¯æ–¹æ¡ˆ">#</a> æŠ€æœ¯æ–¹æ¡ˆ</h2>
<p>ä½¿ç”¨è¨Šæ¯éšŠåˆ—é€²è¡ŒéåŒæ­¥é€šçŸ¥éœ€è¦ä¿è­‰è¨Šæ¯çš„å¯é æ€§ï¼Œå³ç”Ÿç”¢ç«¯å°‡è¨Šæ¯æˆåŠŸé€šçŸ¥åˆ°æ¶ˆè²»ç«¯ã€‚<br>
è¨Šæ¯å¾ç”Ÿç”¢ç«¯ç™¼é€åˆ°æ¶ˆè²»ç«¯ç¶“æ­·ç­å¦‚ä¸‹éç¨‹ï¼š</p>
<p>1ã€è¨Šæ¯ç™¼é€åˆ°äº¤æ›æ©Ÿ</p>
<p>2ã€è¨Šæ¯ç”±äº¤æ›å™¨ç™¼é€åˆ°éšŠåˆ—</p>
<p>3. è¨Šæ¯è€…æ”¶åˆ°è¨Šæ¯é€²è¡Œè™•ç†</p>
<p>ä¿è­‰è¨Šæ¯çš„å¯é æ€§éœ€è¦ä¿è­‰ä»¥ä¸Šéç¨‹çš„å¯é æ€§ï¼Œæœ¬å°ˆæ¡ˆä½¿ç”¨ RabbitMQ å¯ä»¥é€éä»¥ä¸‹æ–¹é¢ä¿è­‰è¨Šæ¯çš„å¯é æ€§ã€‚</p>
<p>1. ç”Ÿç”¢è€…ç¢ºèªæ©Ÿåˆ¶</p>
<p>ç™¼é€è¨Šæ¯å‰ä½¿ç”¨è³‡æ–™åº«äº‹å‹™å°‡è¨Šæ¯ä¿è­‰åˆ°è³‡æ–™åº«è¡¨ä¸­<br>
æˆåŠŸå‚³é€åˆ°äº¤æ›å™¨å°‡è¨Šæ¯å¾è³‡æ–™åº«ä¸­åˆªé™¤</p>
<p>2ã€mq æŒä¹…åŒ–</p>
<p>mq æ”¶åˆ°è¨Šæ¯é€²è¡ŒæŒä¹…åŒ–ï¼Œç•¶ mq é‡å•Ÿå³ä½¿è¨Šæ¯æ²’æœ‰æ¶ˆè²»å®Œä¹Ÿä¸æœƒéºå¤±ã€‚<br>
éœ€è¦é…ç½®äº¤æ›å™¨æŒä¹…åŒ–ã€éšŠåˆ—æŒä¹…åŒ–ã€ç™¼é€è¨Šæ¯æ™‚è¨­å®šæŒä¹…åŒ–ã€‚</p>
<p>3. æ¶ˆè²»è€…ç¢ºèªæ©Ÿåˆ¶</p>
<p>æ¶ˆè²»è€…æ¶ˆè²»æˆåŠŸè‡ªå‹•ç™¼é€ ackï¼Œå¦å‰‡é‡è©¦æ¶ˆè²»ã€‚</p>
<h2 id="è¨‚å–®æœå‹™æ•´åˆmq"><a class="markdownIt-Anchor" href="#è¨‚å–®æœå‹™æ•´åˆmq">#</a> è¨‚å–®æœå‹™æ•´åˆ MQ</h2>
<p>1. é¦–å…ˆåœ¨è¨‚å–®æœå‹™æ–°å¢è¨Šæ¯éšŠåˆ—ä¾è³´</p>
<figure class="highlight xml"><figcaption><span>XML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure>
<p>2. åœ¨ nacos é…ç½® rabbitmq-dev.yaml ç‚ºé€šç”¨é…ç½®æ–‡ä»¶</p>
<figure class="highlight yaml"><figcaption><span>YAML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">rabbitmq:</span> </span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> </span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span> </span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span> </span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span> </span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment">#correlated å¼‚æ­¥å›è°ƒï¼Œå®šä¹‰ConfirmCallbackï¼ŒMQè¿”å›ç»“æœæ—¶ä¼šå›è°ƒè¿™ä¸ªConfirmCallback </span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">false</span> <span class="comment">#å¼€å¯publish-returnåŠŸèƒ½ï¼ŒåŒæ ·æ˜¯åŸºäºcallbackæœºåˆ¶ï¼Œéœ€è¦å®šä¹‰ReturnCallback </span></span><br><span class="line">    <span class="attr">template:</span> </span><br><span class="line">      <span class="attr">mandatory:</span> <span class="literal">false</span> <span class="comment">#å®šä¹‰æ¶ˆæ¯è·¯ç”±å¤±è´¥æ—¶çš„ç­–ç•¥ã€‚trueï¼Œåˆ™è°ƒç”¨ReturnCallbackï¼›falseï¼šåˆ™ç›´æ¥ä¸¢å¼ƒæ¶ˆæ¯ </span></span><br><span class="line">    <span class="attr">listener:</span> </span><br><span class="line">      <span class="attr">simple:</span> </span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span> <span class="comment">#å‡ºç°å¼‚å¸¸æ—¶è¿”å›unackï¼Œæ¶ˆæ¯å›æ»šåˆ°mqï¼›æ²¡æœ‰å¼‚å¸¸ï¼Œè¿”å›ack ,manual:æ‰‹åŠ¨æ§åˆ¶,none:ä¸¢å¼ƒæ¶ˆæ¯ï¼Œä¸å›æ»šåˆ°mq </span></span><br><span class="line">        <span class="attr">retry:</span> </span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯• </span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment">#åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’ </span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment">#å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval </span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment">#æœ€å¤§é‡è¯•æ¬¡æ•° </span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment">#trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse </span></span><br></pre></td></tr></table></figure>
<p>`3. åœ¨è¨‚å–®æœå‹™éšŠåˆ—å·¥ç¨‹å¼•å…¥ rabbitmq-dev.yaml è¨­å®šæª”</p>
<figure class="highlight yaml"><figcaption><span>YAML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">rabbitmq-$&#123;spring.profiles.active&#125;.yaml</span> </span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span> </span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span> </span><br></pre></td></tr></table></figure>
<p>4. åœ¨è¨‚å–®æœå‹™ service å·¥ç¨‹ç·¨å¯« MQ é…ç½®é¡ï¼Œé…ç½®äº¤æ›æ©Ÿ</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span> </span><br><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyConfig</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//äº¤æ¢æœº </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="operator">=</span> <span class="string">&quot;paynotify_exchange_fanout&quot;</span>; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜ç»“æœé€šçŸ¥æ¶ˆæ¯ç±»å‹ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MESSAGE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;payresult_notify&quot;</span>; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜é€šçŸ¥éšŠåˆ— </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;paynotify_queue&quot;</span>; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//å£°æ˜äº¤æ¢æœºï¼Œä¸”æŒä¹…åŒ– </span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span> </span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">paynotify_exchange_fanout</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="comment">// ä¸‰ä¸ªå‚æ•°ï¼šäº¤æ¢æœºåç§°ã€æ˜¯å¦æŒä¹…åŒ–ã€å½“æ²¡æœ‰queueä¸å…¶ç»‘å®šæ—¶æ˜¯å¦è‡ªåŠ¨åˆ é™¤ </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="literal">true</span>, <span class="literal">false</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜é€šçŸ¥éšŠåˆ—,ä¸”æŒä¹…åŒ– </span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_QUEUE)</span> </span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">course_publish_queue</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build(); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//äº¤æ¢æœºå’Œæ”¯ä»˜é€šçŸ¥éšŠåˆ—ç»‘å®š </span></span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_course_publish_queue</span><span class="params">(<span class="meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123; </span><br><span class="line">        <span class="comment">// è·å–RabbitTemplate </span></span><br><span class="line">        <span class="type">RabbitTemplate</span> <span class="variable">rabbitTemplate</span> <span class="operator">=</span> applicationContext.getBean(RabbitTemplate.class); </span><br><span class="line">        <span class="comment">//æ¶ˆæ¯å¤„ç†service </span></span><br><span class="line">        <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> applicationContext.getBean(MqMessageService.class); </span><br><span class="line">        <span class="comment">// è®¾ç½®ReturnCallback </span></span><br><span class="line">        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; &#123; </span><br><span class="line">            <span class="comment">// æŠ•é€’å¤±è´¥ï¼Œè®°å½•æ—¥å¿— </span></span><br><span class="line">            log.info(<span class="string">&quot;æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œåº”ç­”ç &#123;&#125;ï¼ŒåŸå› &#123;&#125;ï¼Œäº¤æ¢æœº&#123;&#125;ï¼Œè·¯ç”±é”®&#123;&#125;,æ¶ˆæ¯&#123;&#125;&quot;</span>, </span><br><span class="line">                    replyCode, replyText, exchange, routingKey, message.toString()); </span><br><span class="line">            <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> JSON.parseObject(message.toString(), MqMessage.class); </span><br><span class="line">            <span class="comment">//å°†æ¶ˆæ¯å†æ·»åŠ åˆ°æ¶ˆæ¯è¡¨ </span></span><br><span class="line">            mqMessageService.addMessage(mqMessage.getMessageType(),mqMessage.getBusinessKey1(),mqMessage.getBusinessKey2(),mqMessage.getBusinessKey3()); </span><br><span class="line"> </span><br><span class="line">        &#125;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç™¼é€æ”¯ä»˜çµæœ"><a class="markdownIt-Anchor" href="#ç™¼é€æ”¯ä»˜çµæœ">#</a> ç™¼é€æ”¯ä»˜çµæœ</h2>
<p>åœ¨ OrderService ä¸­å®šä¹‰æ¥å£</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * å‘é€é€šçŸ¥ç»“æœ </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span>; </span><br></pre></td></tr></table></figure>
<p>ç·¨å¯«æ¥å£å¯¦ä½œæ–¹æ³•ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span> &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//1ã€æ¶ˆæ¯ä½“ï¼Œè½¬json </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> JSON.toJSONString(message); </span><br><span class="line">    <span class="comment">//è®¾ç½®æ¶ˆæ¯æŒä¹…åŒ– </span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">msgObj</span> <span class="operator">=</span> MessageBuilder.withBody(msg.getBytes(StandardCharsets.UTF_8)) </span><br><span class="line">            .setDeliveryMode(MessageDeliveryMode.PERSISTENT) </span><br><span class="line">            .build(); </span><br><span class="line">    <span class="comment">// 2.å…¨å±€å”¯ä¸€çš„æ¶ˆæ¯IDï¼Œéœ€è¦å°è£…åˆ°CorrelationDataä¸­ </span></span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(message.getId().toString()); </span><br><span class="line">    <span class="comment">// 3.æ·»åŠ callback </span></span><br><span class="line">    correlationData.getFuture().addCallback( </span><br><span class="line">            result -&gt; &#123; </span><br><span class="line">                <span class="keyword">if</span>(result.isAck())&#123; </span><br><span class="line">                    <span class="comment">// 3.1.ackï¼Œæ¶ˆæ¯æˆåŠŸ </span></span><br><span class="line">                    log.debug(<span class="string">&quot;é€šçŸ¥æ”¯ä»˜ç»“æœæ¶ˆæ¯å‘é€æˆåŠŸ, ID:&#123;&#125;&quot;</span>, correlationData.getId()); </span><br><span class="line">                    <span class="comment">//åˆ é™¤æ¶ˆæ¯è¡¨ä¸­çš„è®°å½• </span></span><br><span class="line">                    mqMessageService.completed(message.getId()); </span><br><span class="line">                &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">                    <span class="comment">// 3.2.nackï¼Œæ¶ˆæ¯å¤±è´¥ </span></span><br><span class="line">                    log.error(<span class="string">&quot;é€šçŸ¥æ”¯ä»˜ç»“æœæ¶ˆæ¯å‘é€å¤±è´¥, ID:&#123;&#125;, åŸå› &#123;&#125;&quot;</span>,correlationData.getId(), result.getReason()); </span><br><span class="line">                &#125; </span><br><span class="line">            &#125;, </span><br><span class="line">            ex -&gt; log.error(<span class="string">&quot;æ¶ˆæ¯å‘é€å¼‚å¸¸, ID:&#123;&#125;, åŸå› &#123;&#125;&quot;</span>,correlationData.getId(),ex.getMessage()) </span><br><span class="line">    ); </span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯ </span></span><br><span class="line">    rabbitTemplate.convertAndSend(PayNotifyConfig.PAYNOTIFY_EXCHANGE_FANOUT, <span class="string">&quot;&quot;</span>, msgObj,correlationData); </span><br><span class="line"> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>è®¢å•æœåŠ¡æ”¶åˆ°ç¬¬ä¸‰æ–¹å¹³å°çš„æ”¯ä»˜ç»“æœæ—¶ï¼Œåœ¨ saveAliPayStatus æ–¹æ³•ä¸­æ·»åŠ ä»£ç ï¼Œå‘æ•°æ®åº“æ¶ˆæ¯è¡¨æ·»åŠ æ¶ˆæ¯å¹¶è¿›è¡Œå‘é€æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span> &#123; </span><br><span class="line">        ....... </span><br><span class="line">        <span class="comment">//ä¿å­˜æ¶ˆæ¯è®°å½•,å‚æ•°1ï¼šæ”¯ä»˜ç»“æœé€šçŸ¥ç±»å‹ï¼Œ2: ä¸šåŠ¡idï¼Œ3:ä¸šåŠ¡ç±»å‹ </span></span><br><span class="line">        <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> mqMessageService.addMessage(<span class="string">&quot;payresult_notify&quot;</span>, orders.getOutBusinessId(), orders.getOrderType(), <span class="literal">null</span>); </span><br><span class="line">        <span class="comment">//é€šçŸ¥æ¶ˆæ¯ </span></span><br><span class="line">        notifyPayResult(mqMessage); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>é…ç½®äº¤æ¢æœºå’ŒéšŠåˆ—</p>
<p>åœ¨ order-service å·¥ç¨‹é…ç½®</p>
<p>æ¶ˆæ¯å‘é€æ–¹æ³•</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * å‘é€é€šçŸ¥ç»“æœ </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span>; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="å­¸ç¿’ä¸­å¿ƒæœå‹™é›†æˆmq"><a class="markdownIt-Anchor" href="#å­¸ç¿’ä¸­å¿ƒæœå‹™é›†æˆmq">#</a> å­¸ç¿’ä¸­å¿ƒæœå‹™é›†æˆ MQ</h2>
<p>1ã€åœ¨å­¦ä¹ ä¸­å¿ƒæœåŠ¡æ·»åŠ æ¶ˆæ¯éšŠåˆ—ä¾èµ–</p>
<figure class="highlight xml"><figcaption><span>XML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure>
<p>2ã€åœ¨å­¦ä¹ ä¸­å¿ƒæœåŠ¡æ¥å£å·¥ç¨‹å¼•å…¥ rabbitmq-dev.yaml é…ç½®æ–‡ä»¶</p>
<figure class="highlight yaml"><figcaption><span>YAML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">rabbitmq-$&#123;spring.profiles.active&#125;.yaml</span> </span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span> </span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span> </span><br></pre></td></tr></table></figure>
<p>3ã€æ·»åŠ é…ç½®ç±»</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span> </span><br><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyConfig</span> &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//äº¤æ¢æœº </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="operator">=</span> <span class="string">&quot;paynotify_exchange_fanout&quot;</span>; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜ç»“æœé€šçŸ¥æ¶ˆæ¯ç±»å‹ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MESSAGE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;payresult_notify&quot;</span>; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜é€šçŸ¥éšŠåˆ— </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;paynotify_queue&quot;</span>; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//å£°æ˜äº¤æ¢æœºï¼Œä¸”æŒä¹…åŒ– </span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span> </span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">paynotify_exchange_fanout</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="comment">// ä¸‰ä¸ªå‚æ•°ï¼šäº¤æ¢æœºåç§°ã€æ˜¯å¦æŒä¹…åŒ–ã€å½“æ²¡æœ‰queueä¸å…¶ç»‘å®šæ—¶æ˜¯å¦è‡ªåŠ¨åˆ é™¤ </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="literal">true</span>, <span class="literal">false</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//æ”¯ä»˜é€šçŸ¥éšŠåˆ—,ä¸”æŒä¹…åŒ– </span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_QUEUE)</span> </span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">course_publish_queue</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build(); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//äº¤æ¢æœºå’Œæ”¯ä»˜é€šçŸ¥éšŠåˆ—ç»‘å®š </span></span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_course_publish_queue</span><span class="params">(<span class="meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¥æ”¶æ”¯ä»˜ç»“æœ"><a class="markdownIt-Anchor" href="#æ¥æ”¶æ”¯ä»˜ç»“æœ">#</a> æ¥æ”¶æ”¯ä»˜ç»“æœ</h2>
<p>ç›‘å¬ MQï¼Œæ¥æ”¶æ”¯ä»˜ç»“æœï¼Œå®šä¹‰ ReceivePayNotifyService ç±»å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span> </span><br><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceivePayNotifyService</span> &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    MqMessageService mqMessageService; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    MyCourseTablesService myCourseTablesService; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç›‘å¬æ¶ˆæ¯éšŠåˆ—æ¥æ”¶æ”¯ä»˜ç»“æœé€šçŸ¥ </span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = PayNotifyConfig.PAYNOTIFY_QUEUE)</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(Message message, Channel channel)</span> &#123; </span><br><span class="line">        <span class="keyword">try</span> &#123; </span><br><span class="line">            Thread.sleep(<span class="number">5000</span>); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//è·å–æ¶ˆæ¯ </span></span><br><span class="line">        <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> JSON.parseObject(message.getBody(), MqMessage.class); </span><br><span class="line">        log.debug(<span class="string">&quot;å­¦ä¹ ä¸­å¿ƒæœåŠ¡æ¥æ”¶æ”¯ä»˜ç»“æœ:&#123;&#125;&quot;</span>, mqMessage); </span><br><span class="line"> </span><br><span class="line">        <span class="comment">//æ¶ˆæ¯ç±»å‹ </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">messageType</span> <span class="operator">=</span> mqMessage.getMessageType(); </span><br><span class="line">        <span class="comment">//è®¢å•ç±»å‹,60201è¡¨ç¤ºè´­ä¹°è¯¾ç¨‹ </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">businessKey2</span> <span class="operator">=</span> mqMessage.getBusinessKey2(); </span><br><span class="line">        <span class="comment">//è¿™é‡Œåªå¤„ç†æ”¯ä»˜ç»“æœé€šçŸ¥ </span></span><br><span class="line">        <span class="keyword">if</span> (PayNotifyConfig.MESSAGE_TYPE.equals(messageType) &amp;&amp; <span class="string">&quot;60201&quot;</span>.equals(businessKey2)) &#123; </span><br><span class="line">            <span class="comment">//é€‰è¯¾è®°å½•id </span></span><br><span class="line">            <span class="type">String</span> <span class="variable">choosecourseId</span> <span class="operator">=</span> mqMessage.getBusinessKey1(); </span><br><span class="line">            <span class="comment">//æ·»åŠ é€‰è¯¾ </span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> myCourseTablesService.saveChooseCourseStauts(choosecourseId); </span><br><span class="line">            <span class="keyword">if</span>(!b)&#123; </span><br><span class="line">                <span class="comment">//æ·»åŠ é€‰è¯¾å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œæ¶ˆæ¯é‡å›éšŠåˆ— </span></span><br><span class="line">                XueChengPlusException.cast(<span class="string">&quot;æ”¶åˆ°æ”¯ä»˜ç»“æœï¼Œæ·»åŠ é€‰è¯¾å¤±è´¥&quot;</span>); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é€šçŸ¥æ”¯ä»˜ç»“æœæ¸¬è©¦"><a class="markdownIt-Anchor" href="#é€šçŸ¥æ”¯ä»˜ç»“æœæ¸¬è©¦">#</a> é€šçŸ¥æ”¯ä»˜ç»“æœæ¸¬è©¦</h2>
<p>æµ‹è¯•å‡†å¤‡ï¼š</p>
<p>1ï¸âƒ£æ‰¾ä¸€é–€å·²ç™¼å¸ƒçš„æ”¶è²»èª²ç¨‹ã€‚</p>
<p>2ï¸âƒ£å¦‚æœåœ¨æˆ‘çš„èª²ç¨‹è¡¨å„²å­˜å‰‡åˆªé™¤ã€‚</p>
<p>3ï¸âƒ£åˆªé™¤æ­¤èª²ç¨‹çš„é¸èª²ç´€éŒ„åŠè¨‚å–®è³‡è¨Šã€‚</p>
<p>æ¸¬è©¦æµç¨‹ï¼š</p>
<p>1ï¸âƒ£é€²å…¥èª²ç¨‹è©³ç´°é é¢ï¼Œé»é¸é¦¬ä¸Šå­¸ç¿’ï¼Œç”¢ç”ŸäºŒç¶­ç¢¼é€²è¡Œä»˜æ¬¾ã€‚</p>
<p>2ï¸âƒ£ä»˜æ¬¾å®Œæˆé»æ“Š â€œä»˜æ¬¾å®Œæˆâ€ï¼Œè§€å¯Ÿè¨‚å–®æœå‹™æ§åˆ¶å°æ˜¯å¦ç™¼é€è¨Šæ¯ã€‚</p>
<p>3ï¸âƒ£è§€å¯Ÿå­¸ç¿’ä¸­å¿ƒæœå‹™æ§åˆ¶å°æ˜¯å¦æ¥æ”¶åˆ°è¨Šæ¯ã€‚</p>
<p>4ï¸âƒ£è§€å¯Ÿè³‡æ–™åº«ä¸­çš„æ¶ˆæ¯è¡¨çš„ç›¸æ‡‰è¨˜éŒ„æ˜¯å¦å·²åˆªé™¤ã€‚</p>
<p>æ¶ˆè²»é‡è©¦æ¸¬è©¦ï¼š</p>
<p>1ï¸âƒ£åœ¨å­¸ç¿’ä¸­å¿ƒæœå‹™æ¥æ”¶æ”¯ä»˜çµæœæ–¹æ³•ä¸­è£½é€ ç•°å¸¸ã€‚</p>
<p>2ï¸âƒ£é‡æ–°åŸ·è¡Œä¸Šé‚Šçš„æ¸¬è©¦æµç¨‹ï¼Œè§€å¯Ÿæ˜¯å¦æ¶ˆè²»é‡è©¦ã€‚</p>
<img data-src="https://usagif.com/wp-content/uploads/gifs/thanks-for-watching-9.gif" class="abc" width="600" height="350"><div class="tags"><a href="/John/tags/%E6%94%AF%E4%BB%98/" rel="tag"><i class="ic i-tag"></i>æ”¯ä»˜</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">æ›´æ–°æ–¼</span><time title="ä¿®æ”¹æ™‚é–“ï¼š2023-11-10 16:43:48" itemprop="dateModified" datetime="2023-11-10T16:43:48+08:00">2023-11-10</time></span></div><div id="copyright"><ul><li class="author"><strong>ä½œè€…ï¼š</strong>John<i class="ic i-at"><em>@</em></i>ä¸€åˆ‡éƒ½æ˜¯éç¨‹</li><li class="link"><strong>æ–‡ç« é€£çµï¼š</strong><a href="https://superrjohn.github.io/John/2023/11/08/java/pay/alipay" title="æ•´åˆæ”¯ä»˜å¯¶">https://superrjohn.github.io/John/2023/11/08/java/pay/alipay</a></li><li class="license"><strong>ç‰ˆæ¬Šè²æ˜ï¼š</strong>æœ¬ç¶²èªŒæ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥è²æ˜å¤–ï¼Œå‡æ¡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> è¨±å¯å”è­°ã€‚è½‰è¼‰è«‹è¨»æ˜å‡ºè™•ï¼</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/John/2023/11/07/java/radis/redis_interview" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;www.wangluogeng.com&#x2F;static&#x2F;uploads&#x2F;20191228&#x2F;3918128f599ec041f8d7e71c993ac550.jpeg" title="Redisé¢è©¦é¡Œæ•´ç†"><span class="type">ä¸Šä¸€ç¯‡</span><span class="category"><i class="ic i-flag"></i>ä¸­é–“ä»¶</span><h3>Redisé¢è©¦é¡Œæ•´ç†</h3></a></div><div class="item right"></div></div><div class="wrap" id="wcomments"></div><script type="module" data-pjax="data-pjax">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';

setTimeout(function () {
    init({
        el: '#wcomments',
        serverURL: 'https://superr.zeabur.app',
        lang: 'zh-CN',
        locale: {},
        emoji: ["https://unpkg.com/@waline/emojis@1.0.1/weibo","https://unpkg.com/@waline/emojis@1.0.1/alus","https://unpkg.com/@waline/emojis@1.0.1/bilibili","https://unpkg.com/@waline/emojis@1.0.1/qq","https://unpkg.com/@waline/emojis@1.0.1/tieba","https://unpkg.com/@waline/emojis@1.0.1/tw-emoji"],
        meta: ["nick","mail","link"],
        requiredMeta: ["nick","mail"],
        wordLimit: 0,
        pageSize: 10,
        pageview: false,
        path: window.location.pathname,
        dark: 'html[data-theme="dark"]'
    });
}, 1000)</script></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="æ–‡ç« ç›®éŒ„"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B4%E5%90%88%E7%AC%AC%E4%B8%89%E6%96%B9%E6%94%AF%E4%BB%98"><span class="toc-number">1.</span> <span class="toc-text"> æ•´åˆç¬¬ä¸‰æ–¹æ”¯ä»˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%B7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text"> åŸ·è¡Œæµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E8%A8%82%E5%96%AE%E6%9C%8D%E5%8B%99%E8%A8%AD%E8%A8%88"><span class="toc-number">1.2.</span> <span class="toc-text"> é€šç”¨è¨‚å–®æœå‹™è¨­è¨ˆ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%96%E5%82%99%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text"> æº–å‚™é–‹ç™¼ç’°å¢ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E5%AF%B6%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83"><span class="toc-number">2.1.</span> <span class="toc-text"> æ”¯ä»˜å¯¶é–‹ç™¼ç’°å¢ƒ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%A8%82%E5%96%AE%E6%9C%8D%E5%8B%99"><span class="toc-number">3.</span> <span class="toc-text"> å»ºç«‹è¨‚å–®æœå‹™</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E6%B8%AC%E8%A9%A6"><span class="toc-number">4.</span> <span class="toc-text"> æ”¯ä»˜æ¥å£æ¸¬è©¦</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%96%B1%E8%AE%80%E6%8E%A5%E5%8F%A3%E5%AE%9A%E7%BE%A9"><span class="toc-number">4.1.</span> <span class="toc-text"> é–±è®€æ¥å£å®šç¾©</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E5%96%AE%E5%9F%B7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text"> ä¸‹å–®åŸ·è¡Œæµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B7%A8%E5%AF%AB%E4%B8%8B%E5%96%AE%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="toc-number">4.3.</span> <span class="toc-text"> ç·¨å¯«ä¸‹å–®ç¨‹å¼ç¢¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A2%E7%94%9F%E4%BA%8C%E7%B6%AD%E7%A2%BC"><span class="toc-number">4.4.</span> <span class="toc-text"> ç”¢ç”ŸäºŒç¶­ç¢¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B8%AC%E8%A9%A6"><span class="toc-number">4.5.</span> <span class="toc-text"> æ¥å£æ¸¬è©¦</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E7%B5%90%E6%9E%9C%E6%9F%A5%E8%A9%A2%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.</span> <span class="toc-text"> æ”¯ä»˜çµæœæŸ¥è©¢æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E7%B5%90%E6%9E%9C%E9%80%9A%E7%9F%A5%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.1.</span> <span class="toc-text"> æ”¯ä»˜çµæœé€šçŸ¥æ¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B7%A8%E5%AF%AB%E6%B8%AC%E8%A9%A6%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="toc-number">5.2.</span> <span class="toc-text"> ç·¨å¯«æ¸¬è©¦ç¨‹å¼ç¢¼</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%94%AF%E4%BB%98%E4%BA%8C%E7%B6%AD%E7%A2%BC"><span class="toc-number">6.</span> <span class="toc-text"> ç”Ÿæˆæ”¯ä»˜äºŒç¶­ç¢¼</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%B7%E8%A1%8C%E6%B5%81%E7%A8%8B-2"><span class="toc-number">6.1.</span> <span class="toc-text"> åŸ·è¡Œæµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B8%E6%93%9A%E6%A8%A1%E5%9E%8B"><span class="toc-number">6.2.</span> <span class="toc-text"> æ•¸æ“šæ¨¡å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E7%BE%A9"><span class="toc-number">6.3.</span> <span class="toc-text"> æ¥å£å®šç¾©</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AF%A6%E7%8F%BE"><span class="toc-number">6.4.</span> <span class="toc-text"> æ¥å£å¯¦ç¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E6%94%AF%E4%BB%98%E4%BA%A4%E6%98%93%E8%A8%98%E9%8C%84"><span class="toc-number">6.5.</span> <span class="toc-text"> å»ºç«‹æ”¯ä»˜äº¤æ˜“è¨˜éŒ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A2%E6%88%90%E6%94%AF%E4%BB%98%E4%BA%8C%E7%B6%AD%E7%A2%BC"><span class="toc-number">6.6.</span> <span class="toc-text"> ç”¢æˆæ”¯ä»˜äºŒç¶­ç¢¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E4%BA%8C%E7%B6%AD%E7%A2%BC%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-number">6.7.</span> <span class="toc-text"> ç”ŸæˆäºŒç¶­ç¢¼æ¥å£å®Œå–„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%A9%A2%E4%BB%98%E6%AC%BE%E7%B5%90%E6%9E%9C"><span class="toc-number">6.8.</span> <span class="toc-text"> æŸ¥è©¢ä»˜æ¬¾çµæœ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B8%AC%E8%A9%A6-2"><span class="toc-number">7.</span> <span class="toc-text"> æ¥å£æ¸¬è©¦</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5"><span class="toc-number">7.1.</span> <span class="toc-text"> æ¥æ”¶æ”¯ä»˜é€šçŸ¥</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5"><span class="toc-number">8.</span> <span class="toc-text"> æ”¯ä»˜é€šçŸ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">8.1.</span> <span class="toc-text"> æŠ€æœ¯æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A8%82%E5%96%AE%E6%9C%8D%E5%8B%99%E6%95%B4%E5%90%88mq"><span class="toc-number">8.2.</span> <span class="toc-text"> è¨‚å–®æœå‹™æ•´åˆ MQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BC%E9%80%81%E6%94%AF%E4%BB%98%E7%B5%90%E6%9E%9C"><span class="toc-number">8.3.</span> <span class="toc-text"> ç™¼é€æ”¯ä»˜çµæœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%B8%E7%BF%92%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8B%99%E9%9B%86%E6%88%90mq"><span class="toc-number">8.4.</span> <span class="toc-text"> å­¸ç¿’ä¸­å¿ƒæœå‹™é›†æˆ MQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-number">8.5.</span> <span class="toc-text"> æ¥æ”¶æ”¯ä»˜ç»“æœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E6%B8%AC%E8%A9%A6"><span class="toc-number">8.6.</span> <span class="toc-text"> é€šçŸ¥æ”¯ä»˜ç»“æœæ¸¬è©¦</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="ç³»åˆ—æ–‡ç« "><ul><li  class="active"><a href="/John/2023/11/08/java/pay/alipay" rel="bookmark" title="æ•´åˆæ”¯ä»˜å¯¶">æ•´åˆæ”¯ä»˜å¯¶</a></li></ul></div><div class="overview panel" data-title="æœ¬ç«™æ¦‚è¦"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="John" data-src="/John/assets/404.png"/><p class="name" itemprop="name">John</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/John/archives/"><span class="count">8</span><span class="name">æ–‡ç« </span></a></div><div class="item categories"><a href="/John/categories/"><span class="count">6</span><span class="name">åˆ†é¡</span></a></div><div class="item tags"><a href="/John/tags/"><span class="count">9</span><span class="name">æ¨™ç±¤</span></a></div></nav><div class="social"><a href="https://github.com/superrjohn" class="item github" rel="noopener" title="https:&#x2F;&#x2F;github.com&#x2F;superrjohn" target="_blank"><i class="ic i-github"></i></a><a href="https://music.163.com/#/user/home?id=8923804515" class="item music" rel="noopener" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;8923804515" target="_blank"><i class="ic i-cloud-music"></i></a><a href="https://www.youtube.com/@John-ql5uv" class="item youtube" rel="noopener" title="https:&#x2F;&#x2F;www.youtube.com&#x2F;@John-ql5uv" target="_blank"><i class="ic i-youtube"></i></a></div><div class="menu"><li class="item"><a href="/John/" rel="section"><i class="ic i-home"></i>é¦–é </a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-user"></i>é—œæ–¼</a><ul class="submenu"><li class="item"><a href="/John/about/" rel="section"><i class="ic i-user"></i>é—œæ–¼æœ¬ç«™</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>æ–‡ç« </a><ul class="submenu"><li class="item"><a href="/John/archives/" rel="section"><i class="ic i-list-alt"></i>æ­¸æª”</a></li><li class="item"><a href="/John/categories/" rel="section"><i class="ic i-th"></i>åˆ†é¡</a></li><li class="item"><a href="/John/tags/" rel="section"><i class="ic i-tags"></i>æ¨™ç±¤</a></li></ul></li></div></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/John/2023/11/07/java/radis/redis_interview" rel="next" title="ä¸‹ä¸€ç¯‡"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>éš¨æ©Ÿæ–‡ç« </h2><ul><li class="item"><div class="breadcrumb"><a href="/John/categories/java/" title="åˆ†é¡æ–¼java">java</a><i class="ic i-angle-right"></i><a href="/John/categories/java/pay/" title="åˆ†é¡æ–¼æ”¯ä»˜">æ”¯ä»˜</a></div><span><a href="/John/2023/11/08/java/pay/alipay">æ•´åˆæ”¯ä»˜å¯¶</a></span></li><li class="item"><div class="breadcrumb"><a href="/John/categories/java/" title="åˆ†é¡æ–¼java">java</a><i class="ic i-angle-right"></i><a href="/John/categories/java/SpringSecurity/" title="åˆ†é¡æ–¼SpringSecurity">SpringSecurity</a></div><span><a href="/John/2023/10/30/java/SpringSecurity/SpringSecurity">SpringSecurity èªè­‰æˆæ¬Š</a></span></li><li class="item"><div class="breadcrumb"><a href="/John/categories/java/" title="åˆ†é¡æ–¼java">java</a><i class="ic i-angle-right"></i><a href="/John/categories/java/SpringSecurity/" title="åˆ†é¡æ–¼SpringSecurity">SpringSecurity</a></div><span><a href="/John/2023/11/03/java/SpringSecurity/WeChat_login">SpringSecurity å¾®ä¿¡ç™»éŒ„</a></span></li><li class="item"><div class="breadcrumb"><a href="/John/categories/hexo/" title="åˆ†é¡æ–¼hexo">hexo</a></div><span><a href="/John/2023/10/22/hexo/Hexo">Hexoå¿«é€Ÿéƒ¨ç½²!</a></span></li><li class="item"><div class="breadcrumb"><a href="/John/categories/java/" title="åˆ†é¡æ–¼java">java</a><i class="ic i-angle-right"></i><a href="/John/categories/java/radis-rabbitmq/" title="åˆ†é¡æ–¼ä¸­é–“ä»¶">ä¸­é–“ä»¶</a></div><span><a href="/John/2023/11/07/java/radis/redis_interview">Redisé¢è©¦é¡Œæ•´ç†</a></span></li><li class="item"><div class="breadcrumb"><a href="/John/categories/java/" title="åˆ†é¡æ–¼java">java</a><i class="ic i-angle-right"></i><a href="/John/categories/java/springMVC/" title="åˆ†é¡æ–¼springMVC">springMVC</a></div><span><a href="/John/2023/10/27/java/springMVC/UserBook-Web">æ‰‹å¯«springMVC!</a></span></li><li class="item"><div class="breadcrumb"><a href="/John/categories/java/" title="åˆ†é¡æ–¼java">java</a><i class="ic i-angle-right"></i><a href="/John/categories/java/radis-rabbitmq/" title="åˆ†é¡æ–¼ä¸­é–“ä»¶">ä¸­é–“ä»¶</a></div><span><a href="/John/2023/10/26/java/radis/radis">Redis ç·©å­˜å„ªåŒ–</a></span></li><li class="item"><div class="breadcrumb"><a href="/John/categories/java/" title="åˆ†é¡æ–¼java">java</a><i class="ic i-angle-right"></i><a href="/John/categories/java/radis-rabbitmq/" title="åˆ†é¡æ–¼ä¸­é–“ä»¶">ä¸­é–“ä»¶</a></div><span><a href="/John/2023/10/26/java/rabbitmq/rabbitmq">Hello RabbitMq!</a></span></li></ul></div><div class="rpost pjax"><h2>æœ€æ–°è©•è«–</h2><ul class="leancloud-recent-comment" id="new-comment"><li class="item" v-for="com in coms"><a v-bind:href="root + com.href" data-pjax-state="data-pjax-state"><span class="breadcrumb">{{com.nick}} @ {{com.time}}</span><span>{{com.text}}<br/></span></a></li></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2023</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">John @ john's blog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="ç¸½å­—æ•¸">116k å­—</span><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="æ‰€éœ€ç¸½é–±è®€æ™‚é–“">1:45</span></div><div class="powered-by">åŸºæ–¼ <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & Theme.<a href="https://github.com/theme-shoka-x/hexo-theme-shokaX/" rel="noopener" target="_blank">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
        path: `2023/11/08/java/pay/alipay`,
        favicon: {
        show: `ï¼ˆâ—Â´3ï½€â—ï¼‰å¾©æ´»æˆåŠŸ`,
        hide: `(Â´Ğ”ï½€)ç€è¦½å™¨å´©æ½°å•¦`
    },
    search: {
        placeholder: "æ–‡ç« æœå°‹",
        empty: "é—œæ–¼ ã€Œ ${query} ã€ ï¼Œä»€éº¼ä¹Ÿæ²’æœåˆ°",
        stats: "${time} ms å…§æ‰¾åˆ° ${hits} æ¢çµæœ"
    },
    valine: true,
    chart: false,
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">æ–‡ç« æ™‚æ•ˆæ€§æç¤º</span><br>é€™æ˜¯ä¸€ç¯‡ç™¼ä½ˆæ–¼ {{publish}} å¤©å‰ï¼Œæœ€å¾Œä¸€æ¬¡æ›´æ–°åœ¨ {{updated}} å¤©å‰çš„æ–‡ç« ï¼Œéƒ¨åˆ†ä¿¡æ¯å¯èƒ½å·²ç¶“ç™¼ç”Ÿæ”¹è®Šï¼Œè«‹æ³¨æ„ç”„åˆ¥ã€‚</p></div>`,
    quiz: {
        choice: `å–®é¸é¡Œ`,
        multiple: `å¤šé¸é¡Œ`,
        true_false: `åˆ¤æ–·é¡Œ`,
        essay: `å•ç­”é¡Œ`,
        gap_fill: `å¡«ç©ºé¡Œ`,
        mistake: `éŒ¯é¡Œå‚™è¨»`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=default,fetch"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.0.2/pace.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/algoliasearch/4.12.1/algoliasearch-lite.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/instantsearch.js/4.39.0/instantsearch.production.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/quicklink/2.2.0/quicklink.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/??jquery/3.5.1/jquery.min.js,fancybox/3.5.7/jquery.fancybox.min.js,justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" async></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/KaTeX/0.15.2/contrib/copy-tex.min.js" async></script><script src="/John/js/app.js?v=0.3.6"></script>
    <script type="module" data-pjax>
        let items = []
        import { RecentComments } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs'
        RecentComments({
          serverURL: 'https://superr.zeabur.app',
          count: 10,
        }).then(({ comments }) => {
          comments.forEach(function (item) {
              let cText = (item.orig.length > 50) ? item.orig.substring(0,50)+'...' : item.orig
              item.url = item.url !== '/' ?  '/' + item.url : item.url;
              const siteLink = item.url + "#" + item.objectId
              items.push({
                  href: siteLink,
                  nick: item.nick,
                  time: item.insertedAt.split('T').shift(),
                  text: cText
              })
          })
          Vue.createApp({
            data() {
                return {
                    coms: items,
                    root: '/John'
                }
            }
          }).mount('#new-comment')
        }).catch(function (err) {
          console.error(err)
        })
    </script>
    </body></html>